-- ServerScriptService
-- AIRHUB Style Admin Panel - IMPROVED ESP VERSION

-- Services
local Players = game:GetService("Players")
local ServerStorage = game:GetService("ServerStorage")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local Debris = game:GetService("Debris")
local SoundService = game:GetService("SoundService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local MarketplaceService = game:GetService("MarketplaceService")
local TeleportService = game:GetService("TeleportService")
local BadgeService = game:GetService("BadgeService")
local DataStoreService = game:GetService("DataStoreService")
local PhysicsService = game:GetService("PhysicsService")
local PathfindingService = game:GetService("PathfindingService")
local Chat = game:GetService("Chat")
local Teams = game:GetService("Teams")
local StarterGui = game:GetService("StarterGui")
local StarterPack = game:GetService("StarterPack")
local StarterPlayer = game:GetService("StarterPlayer")
local ContextActionService = game:GetService("ContextActionService")
local CoreGui = game:GetService("CoreGui")

local adminIds = {
    3905919471, -- Your admin
}

local activeTracking = {}
local activeESP = {}
local espEnabled = {}
local rightMouseTracking = {}
local espSettings = {}
local trackingMode = {}
local toggleTrackingActive = {}

-- AIRHUB Color Scheme
local Colors = {
    Background = Color3.fromRGB(25, 15, 35),
    BackgroundTransparent = Color3.fromRGB(30, 20, 45),
    Accent = Color3.fromRGB(130, 80, 200),
    AccentBright = Color3.fromRGB(160, 100, 255),
    AccentDark = Color3.fromRGB(80, 50, 140),
    Border = Color3.fromRGB(60, 40, 90),
    Text = Color3.fromRGB(220, 210, 240),
    TextDim = Color3.fromRGB(140, 130, 160),
    TabActive = Color3.fromRGB(50, 30, 80),
    TabInactive = Color3.fromRGB(35, 25, 55),
    CheckboxOn = Color3.fromRGB(130, 80, 200),
    CheckboxOff = Color3.fromRGB(50, 40, 70),
    SliderFill = Color3.fromRGB(130, 80, 200),
    SliderBg = Color3.fromRGB(40, 30, 60),
    DropdownBg = Color3.fromRGB(35, 25, 55),
    Success = Color3.fromRGB(80, 200, 120),
    Warning = Color3.fromRGB(255, 180, 80),
    Danger = Color3.fromRGB(255, 80, 80),
    
    -- ESP Specific Colors
    ESP_Close = Color3.fromRGB(255, 50, 50),      -- Red for close enemies
    ESP_Medium = Color3.fromRGB(255, 165, 0),    -- Orange for medium
    ESP_Far = Color3.fromRGB(255, 255, 0),       -- Yellow for far
    ESP_VeryFar = Color3.fromRGB(50, 255, 50),   -- Green for very far
    ESP_Visible = Color3.fromRGB(0, 255, 150),   -- Cyan-green for visible
    ESP_Hidden = Color3.fromRGB(255, 100, 100),  -- Light red for hidden
}

local function isAdmin(player)
    for _, id in ipairs(adminIds) do
        if player.UserId == id then
            return true
        end
    end
    return false
end

local function isSameTeam(player1, player2)
    if not player1.Team or not player2.Team then
        return false
    end
    return player1.Team == player2.Team
end

local function isValidTarget(admin, target)
    if target == admin then
        return false
    end
    
    if isAdmin(target) then
        return false
    end
    
    if isSameTeam(admin, target) then
        return false
    end
    
    return true
end

local function hasLineOfSight(admin, target)
    local adminChar = admin.Character
    local targetChar = target.Character
    
    if not adminChar or not targetChar then
        return false
    end
    
    local adminHead = adminChar:FindFirstChild("Head")
    local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
    
    if not adminHead or not targetHRP then
        return false
    end
    
    local origin = adminHead.Position
    local destination = targetHRP.Position
    local direction = (destination - origin)
    local distance = direction.Magnitude
    
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    raycastParams.FilterDescendantsInstances = {adminChar, targetChar}
    raycastParams.IgnoreWater = true
    
    local raycastResult = Workspace:Raycast(origin, direction.Unit * distance, raycastParams)
    
    if raycastResult then
        return false
    end
    
    return true
end

local function findPlayer(name)
    name = name:lower()
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Name:lower():sub(1, #name) == name then
            return player
        end
    end
    return nil
end

local function getNearestValidTarget(admin)
    local adminChar = admin.Character
    if not adminChar then return nil end
    
    local adminHRP = adminChar:FindFirstChild("HumanoidRootPart")
    if not adminHRP then return nil end
    
    local nearestPlayer = nil
    local nearestDistance = math.huge
    
    for _, player in ipairs(Players:GetPlayers()) do
        if isValidTarget(admin, player) then
            local char = player.Character
            if char then
                local hrp = char:FindFirstChild("HumanoidRootPart")
                if hrp then
                    local distance = (adminHRP.Position - hrp.Position).Magnitude
                    
                    if distance < nearestDistance and hasLineOfSight(admin, player) then
                        nearestDistance = distance
                        nearestPlayer = player
                    end
                end
            end
        end
    end
    
    return nearestPlayer, nearestDistance
end

local function stopTracking(admin)
    if activeTracking[admin.UserId] then
        if activeTracking[admin.UserId].connection then
            activeTracking[admin.UserId].connection:Disconnect()
        end
        activeTracking[admin.UserId] = nil
        return true
    end
    return false
end

local function stopRightMouseTracking(admin)
    if rightMouseTracking[admin.UserId] then
        if rightMouseTracking[admin.UserId].connection then
            rightMouseTracking[admin.UserId].connection:Disconnect()
        end
        rightMouseTracking[admin.UserId] = nil
        
        local camera = Workspace.CurrentCamera
        if camera then
            camera.CameraType = Enum.CameraType.Custom
        end
        return true
    end
    return false
end

-- ========================================
-- IMPROVED ESP FUNCTIONS
-- ========================================

local function getESPColor(distance, canSee)
    -- Color based on distance
    local distColor
    if distance < 30 then
        distColor = Colors.ESP_Close
    elseif distance < 75 then
        distColor = Colors.ESP_Medium
    elseif distance < 150 then
        distColor = Colors.ESP_Far
    else
        distColor = Colors.ESP_VeryFar
    end
    
    -- Modify based on visibility
    if canSee then
        return distColor
    else
        -- Darken color when not visible
        return Color3.new(
            distColor.R * 0.6,
            distColor.G * 0.6,
            distColor.B * 0.6
        )
    end
end

local function createImprovedESP(target, admin)
    if not target.Character then return nil end
    
    if not isValidTarget(admin, target) then
        return nil
    end
    
    local existingFolder = target.Character:FindFirstChild("AdminESP_" .. admin.UserId)
    if existingFolder then
        existingFolder:Destroy()
    end
    
    local espFolder = Instance.new("Folder")
    espFolder.Name = "AdminESP_" .. admin.UserId
    espFolder.Parent = target.Character
    
    local settings = espSettings[admin.UserId] or {
        boxEnabled = true,
        tracerEnabled = true,
        nameEnabled = true,
        healthEnabled = true,
        distanceEnabled = true,
        cornerBoxEnabled = true,
        glowEnabled = true
    }
    
    -- ====== MAIN INFO BILLBOARD ======
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Name = "InfoBoard"
    billboardGui.Adornee = target.Character:FindFirstChild("Head")
    billboardGui.Size = UDim2.new(0, 160, 0, 60)
    billboardGui.StudsOffset = Vector3.new(0, 2.8, 0)
    billboardGui.AlwaysOnTop = true
    billboardGui.MaxDistance = 500
    billboardGui.Parent = espFolder
    
    local infoFrame = Instance.new("Frame")
    infoFrame.Size = UDim2.new(1, 0, 1, 0)
    infoFrame.BackgroundTransparency = 1
    infoFrame.Parent = billboardGui
    
    -- Background panel for better readability
    local bgPanel = Instance.new("Frame")
    bgPanel.Name = "BackgroundPanel"
    bgPanel.Size = UDim2.new(1, 0, 0, 50)
    bgPanel.Position = UDim2.new(0, 0, 0, 0)
    bgPanel.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    bgPanel.BackgroundTransparency = 0.7
    bgPanel.BorderSizePixel = 0
    bgPanel.Parent = infoFrame
    
    local bgCorner = Instance.new("UICorner")
    bgCorner.CornerRadius = UDim.new(0, 4)
    bgCorner.Parent = bgPanel
    
    local bgStroke = Instance.new("UIStroke")
    bgStroke.Name = "BorderStroke"
    bgStroke.Color = Colors.AccentBright
    bgStroke.Thickness = 1.5
    bgStroke.Transparency = 0.3
    bgStroke.Parent = bgPanel
    
    -- Player Name with icon
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "NameLabel"
    nameLabel.Size = UDim2.new(1, -8, 0, 16)
    nameLabel.Position = UDim2.new(0, 4, 0, 2)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = "üë§ " .. target.Name
    nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    nameLabel.TextStrokeTransparency = 0
    nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    nameLabel.TextSize = 13
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.TextXAlignment = Enum.TextXAlignment.Center
    nameLabel.Visible = settings.nameEnabled
    nameLabel.Parent = bgPanel
    
    -- Health Bar Background
    local healthBarBg = Instance.new("Frame")
    healthBarBg.Name = "HealthBarBg"
    healthBarBg.Size = UDim2.new(0.9, 0, 0, 8)
    healthBarBg.Position = UDim2.new(0.05, 0, 0, 20)
    healthBarBg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    healthBarBg.BorderSizePixel = 0
    healthBarBg.Visible = settings.healthEnabled
    healthBarBg.Parent = bgPanel
    
    local healthBarBgCorner = Instance.new("UICorner")
    healthBarBgCorner.CornerRadius = UDim.new(0, 4)
    healthBarBgCorner.Parent = healthBarBg
    
    -- Health Bar Fill with gradient effect
    local healthBarFill = Instance.new("Frame")
    healthBarFill.Name = "HealthBarFill"
    healthBarFill.Size = UDim2.new(1, 0, 1, 0)
    healthBarFill.BackgroundColor3 = Colors.Success
    healthBarFill.BorderSizePixel = 0
    healthBarFill.Parent = healthBarBg
    
    local healthBarFillCorner = Instance.new("UICorner")
    healthBarFillCorner.CornerRadius = UDim.new(0, 4)
    healthBarFillCorner.Parent = healthBarFill
    
    -- Health percentage text
    local healthText = Instance.new("TextLabel")
    healthText.Name = "HealthText"
    healthText.Size = UDim2.new(1, 0, 1, 0)
    healthText.BackgroundTransparency = 1
    healthText.Text = "100%"
    healthText.TextColor3 = Color3.fromRGB(255, 255, 255)
    healthText.TextStrokeTransparency = 0
    healthText.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    healthText.TextSize = 8
    healthText.Font = Enum.Font.GothamBold
    healthText.Parent = healthBarFill
    
    -- Distance and Status Label
    local statusFrame = Instance.new("Frame")
    statusFrame.Size = UDim2.new(1, -8, 0, 16)
    statusFrame.Position = UDim2.new(0, 4, 0, 30)
    statusFrame.BackgroundTransparency = 1
    statusFrame.Parent = bgPanel
    
    local distanceLabel = Instance.new("TextLabel")
    distanceLabel.Name = "DistanceLabel"
    distanceLabel.Size = UDim2.new(0.5, 0, 1, 0)
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.Text = "üìç 0m"
    distanceLabel.TextColor3 = Colors.Warning
    distanceLabel.TextStrokeTransparency = 0
    distanceLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    distanceLabel.TextSize = 11
    distanceLabel.Font = Enum.Font.GothamMedium
    distanceLabel.TextXAlignment = Enum.TextXAlignment.Left
    distanceLabel.Visible = settings.distanceEnabled
    distanceLabel.Parent = statusFrame
    
    local visibilityLabel = Instance.new("TextLabel")
    visibilityLabel.Name = "VisibilityLabel"
    visibilityLabel.Size = UDim2.new(0.5, 0, 1, 0)
    visibilityLabel.Position = UDim2.new(0.5, 0, 0, 0)
    visibilityLabel.BackgroundTransparency = 1
    visibilityLabel.Text = "üëÅ VISIBLE"
    visibilityLabel.TextColor3 = Colors.Success
    visibilityLabel.TextStrokeTransparency = 0
    visibilityLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    visibilityLabel.TextSize = 11
    visibilityLabel.Font = Enum.Font.GothamBold
    visibilityLabel.TextXAlignment = Enum.TextXAlignment.Right
    visibilityLabel.Parent = statusFrame
    
    -- ====== IMPROVED HIGHLIGHT ======
    local highlight = Instance.new("Highlight")
    highlight.Name = "BoxHighlight"
    highlight.Adornee = target.Character
    highlight.FillColor = Colors.Accent
    highlight.OutlineColor = Colors.AccentBright
    highlight.FillTransparency = 0.85
    highlight.OutlineTransparency = 0
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Enabled = settings.boxEnabled
    highlight.Parent = espFolder
    
    -- ====== CLEANER TRACER ======
    local tracerPart = Instance.new("Part")
    tracerPart.Name = "TracerAnchor"
    tracerPart.Anchored = true
    tracerPart.CanCollide = false
    tracerPart.Transparency = 1
    tracerPart.Size = Vector3.new(0.1, 0.1, 0.1)
    tracerPart.Parent = espFolder
    
    local beam = Instance.new("Beam")
    beam.Name = "Tracer"
    beam.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Colors.AccentBright),
        ColorSequenceKeypoint.new(1, Colors.Accent)
    })
    beam.Transparency = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 0.2),
        NumberSequenceKeypoint.new(0.5, 0.4),
        NumberSequenceKeypoint.new(1, 0.6)
    })
    beam.Width0 = 1.5
    beam.Width1 = 0.5
    beam.FaceCamera = true
    beam.Segments = 1
    beam.Enabled = settings.tracerEnabled
    beam.Parent = espFolder
    
    local attachment0 = Instance.new("Attachment")
    attachment0.Name = "TracerStart"
    attachment0.Parent = tracerPart
    
    local attachment1 = Instance.new("Attachment")
    attachment1.Name = "TracerEnd"
    attachment1.Parent = tracerPart
    
    beam.Attachment0 = attachment0
    beam.Attachment1 = attachment1
    
    -- ====== HEAD DOT INDICATOR ======
    local headDot = Instance.new("BillboardGui")
    headDot.Name = "HeadDot"
    headDot.Adornee = target.Character:FindFirstChild("Head")
    headDot.Size = UDim2.new(0, 12, 0, 12)
    headDot.StudsOffset = Vector3.new(0, 0, 0)
    headDot.AlwaysOnTop = true
    headDot.Parent = espFolder
    
    local dotFrame = Instance.new("Frame")
    dotFrame.Size = UDim2.new(1, 0, 1, 0)
    dotFrame.BackgroundColor3 = Colors.Danger
    dotFrame.BorderSizePixel = 0
    dotFrame.Parent = headDot
    
    local dotCorner = Instance.new("UICorner")
    dotCorner.CornerRadius = UDim.new(1, 0)
    dotCorner.Parent = dotFrame
    
    local dotStroke = Instance.new("UIStroke")
    dotStroke.Color = Color3.fromRGB(255, 255, 255)
    dotStroke.Thickness = 2
    dotStroke.Parent = dotFrame
    
    -- ====== WEAPON/TOOL INDICATOR ======
    local weaponBoard = Instance.new("BillboardGui")
    weaponBoard.Name = "WeaponBoard"
    weaponBoard.Adornee = target.Character:FindFirstChild("HumanoidRootPart")
    weaponBoard.Size = UDim2.new(0, 100, 0, 20)
    weaponBoard.StudsOffset = Vector3.new(0, -3, 0)
    weaponBoard.AlwaysOnTop = true
    weaponBoard.Parent = espFolder
    
    local weaponLabel = Instance.new("TextLabel")
    weaponLabel.Name = "WeaponLabel"
    weaponLabel.Size = UDim2.new(1, 0, 1, 0)
    weaponLabel.BackgroundTransparency = 1
    weaponLabel.Text = "üî´ No Weapon"
    weaponLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    weaponLabel.TextStrokeTransparency = 0
    weaponLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    weaponLabel.TextSize = 10
    weaponLabel.Font = Enum.Font.Gotham
    weaponLabel.Parent = weaponBoard
    
    return {
        folder = espFolder,
        highlight = highlight,
        billboard = billboardGui,
        bgPanel = bgPanel,
        bgStroke = bgStroke,
        nameLabel = nameLabel,
        healthBarBg = healthBarBg,
        healthBarFill = healthBarFill,
        healthText = healthText,
        distanceLabel = distanceLabel,
        visibilityLabel = visibilityLabel,
        beam = beam,
        tracerPart = tracerPart,
        attachment0 = attachment0,
        attachment1 = attachment1,
        headDot = headDot,
        dotFrame = dotFrame,
        weaponLabel = weaponLabel
    }
end

local function updateImprovedESP(admin, target, espComponents)
    if not admin.Character or not target.Character then return false end
    
    if not isValidTarget(admin, target) then
        if espComponents.folder then
            espComponents.folder:Destroy()
        end
        return false
    end
    
    local adminHRP = admin.Character:FindFirstChild("HumanoidRootPart")
    local targetHRP = target.Character:FindFirstChild("HumanoidRootPart")
    local targetHumanoid = target.Character:FindFirstChild("Humanoid")
    
    if not adminHRP or not targetHRP then return true end
    
    local distance = (adminHRP.Position - targetHRP.Position).Magnitude
    local canSee = hasLineOfSight(admin, target)
    local espColor = getESPColor(distance, canSee)
    
    -- Update distance label
    if espComponents.distanceLabel then
        if distance < 50 then
            espComponents.distanceLabel.Text = string.format("üìç %.0fm ‚ö†Ô∏è", distance)
            espComponents.distanceLabel.TextColor3 = Colors.Danger
        elseif distance < 100 then
            espComponents.distanceLabel.Text = string.format("üìç %.0fm", distance)
            espComponents.distanceLabel.TextColor3 = Colors.Warning
        else
            espComponents.distanceLabel.Text = string.format("üìç %.0fm", distance)
            espComponents.distanceLabel.TextColor3 = Colors.ESP_VeryFar
        end
    end
    
    -- Update health
    if targetHumanoid then
        local healthPercent = targetHumanoid.Health / targetHumanoid.MaxHealth
        
        if espComponents.healthBarFill then
            espComponents.healthBarFill.Size = UDim2.new(math.max(healthPercent, 0), 0, 1, 0)
            
            if healthPercent > 0.6 then
                espComponents.healthBarFill.BackgroundColor3 = Colors.Success
            elseif healthPercent > 0.3 then
                espComponents.healthBarFill.BackgroundColor3 = Colors.Warning
            else
                espComponents.healthBarFill.BackgroundColor3 = Colors.Danger
            end
        end
        
        if espComponents.healthText then
            espComponents.healthText.Text = string.format("%.0f%%", healthPercent * 100)
        end
    end
    
    -- Update visibility indicator
    if espComponents.visibilityLabel then
        if canSee then
            espComponents.visibilityLabel.Text = "üëÅ VISIBLE"
            espComponents.visibilityLabel.TextColor3 = Colors.Success
        else
            espComponents.visibilityLabel.Text = "üö´ HIDDEN"
            espComponents.visibilityLabel.TextColor3 = Colors.Danger
        end
    end
    
    -- Update highlight colors
    if espComponents.highlight then
        espComponents.highlight.FillColor = espColor
        espComponents.highlight.OutlineColor = canSee and Color3.fromRGB(255, 255, 255) or espColor
        espComponents.highlight.FillTransparency = canSee and 0.8 or 0.9
        espComponents.highlight.OutlineTransparency = canSee and 0 or 0.3
    end
    
    -- Update border stroke
    if espComponents.bgStroke then
        espComponents.bgStroke.Color = espColor
    end
    
    -- Update head dot
    if espComponents.dotFrame then
        espComponents.dotFrame.BackgroundColor3 = espColor
    end
    
    -- Update tracer
    if espComponents.beam and espComponents.tracerPart then
        local camera = Workspace.CurrentCamera
        if camera then
            -- Position tracer from bottom of screen
            local screenBottom = camera.CFrame.Position + camera.CFrame.LookVector * 2 + Vector3.new(0, -1, 0)
            espComponents.tracerPart.Position = screenBottom
            espComponents.attachment0.WorldPosition = screenBottom
            espComponents.attachment1.WorldPosition = targetHRP.Position
            
            -- Update tracer color gradient
            espComponents.beam.Color = ColorSequence.new({
                ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 255, 255)),
                ColorSequenceKeypoint.new(0.3, espColor),
                ColorSequenceKeypoint.new(1, espColor)
            })
            
            -- Adjust tracer width based on distance
            local widthMultiplier = math.clamp(1 - (distance / 500), 0.3, 1)
            espComponents.beam.Width0 = 2 * widthMultiplier
            espComponents.beam.Width1 = 0.8 * widthMultiplier
        end
    end
    
    -- Update weapon indicator
    if espComponents.weaponLabel then
        local tool = target.Character:FindFirstChildOfClass("Tool")
        if tool then
            espComponents.weaponLabel.Text = "üî´ " .. tool.Name
            espComponents.weaponLabel.TextColor3 = Colors.Danger
        else
            espComponents.weaponLabel.Text = "‚úã Unarmed"
            espComponents.weaponLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
        end
    end
    
    return true
end

local function clearAllESP(admin)
    if activeESP[admin.UserId] then
        for _, data in pairs(activeESP[admin.UserId]) do
            if data.connection then
                data.connection:Disconnect()
            end
            if data.components and data.components.folder then
                data.components.folder:Destroy()
            end
        end
        activeESP[admin.UserId] = nil
    end
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Character then
            local folder = player.Character:FindFirstChild("AdminESP_" .. admin.UserId)
            if folder then
                folder:Destroy()
            end
        end
    end
    
    espEnabled[admin.UserId] = false
end

local function enableESP(admin)
    clearAllESP(admin)
    
    activeESP[admin.UserId] = {}
    espEnabled[admin.UserId] = true
    
    for _, target in ipairs(Players:GetPlayers()) do
        if isValidTarget(admin, target) then
            local components = createImprovedESP(target, admin)
            if components then
                local connection = RunService.Heartbeat:Connect(function()
                    if not espEnabled[admin.UserId] then
                        return
                    end
                    local stillValid = updateImprovedESP(admin, target, components)
                    if not stillValid then
                        if activeESP[admin.UserId] and activeESP[admin.UserId][target.UserId] then
                            activeESP[admin.UserId][target.UserId].connection:Disconnect()
                            activeESP[admin.UserId][target.UserId] = nil
                        end
                    end
                end)
                
                activeESP[admin.UserId][target.UserId] = {
                    components = components,
                    connection = connection
                }
            end
        end
    end
    
    local playerAddedConn
    playerAddedConn = Players.PlayerAdded:Connect(function(target)
        if not espEnabled[admin.UserId] then
            playerAddedConn:Disconnect()
            return
        end
        
        target.CharacterAdded:Wait()
        task.wait(1)
        
        if espEnabled[admin.UserId] and isValidTarget(admin, target) then
            local components = createImprovedESP(target, admin)
            if components then
                local connection = RunService.Heartbeat:Connect(function()
                    if not espEnabled[admin.UserId] then
                        return
                    end
                    updateImprovedESP(admin, target, components)
                end)
                
                if not activeESP[admin.UserId] then
                    activeESP[admin.UserId] = {}
                end
                
                activeESP[admin.UserId][target.UserId] = {
                    components = components,
                    connection = connection
                }
            end
        end
    end)
    
    for _, target in ipairs(Players:GetPlayers()) do
        if target ~= admin then
            target.CharacterAdded:Connect(function()
                if espEnabled[admin.UserId] and isValidTarget(admin, target) then
                    task.wait(1)
                    
                    if activeESP[admin.UserId] and activeESP[admin.UserId][target.UserId] then
                        if activeESP[admin.UserId][target.UserId].connection then
                            activeESP[admin.UserId][target.UserId].connection:Disconnect()
                        end
                        if activeESP[admin.UserId][target.UserId].components and activeESP[admin.UserId][target.UserId].components.folder then
                            activeESP[admin.UserId][target.UserId].components.folder:Destroy()
                        end
                    end
                    
                    local components = createImprovedESP(target, admin)
                    if components then
                        local connection = RunService.Heartbeat:Connect(function()
                            if not espEnabled[admin.UserId] then
                                return
                            end
                            updateImprovedESP(admin, target, components)
                        end)
                        
                        if not activeESP[admin.UserId] then
                            activeESP[admin.UserId] = {}
                        end
                        
                        activeESP[admin.UserId][target.UserId] = {
                            components = components,
                            connection = connection
                        }
                    end
                end
            end)
            
            target:GetPropertyChangedSignal("Team"):Connect(function()
                if espEnabled[admin.UserId] then
                    if not isValidTarget(admin, target) then
                        if activeESP[admin.UserId] and activeESP[admin.UserId][target.UserId] then
                            if activeESP[admin.UserId][target.UserId].connection then
                                activeESP[admin.UserId][target.UserId].connection:Disconnect()
                            end
                            if activeESP[admin.UserId][target.UserId].components and activeESP[admin.UserId][target.UserId].components.folder then
                                activeESP[admin.UserId][target.UserId].components.folder:Destroy()
                            end
                            activeESP[admin.UserId][target.UserId] = nil
                        end
                    else
                        if (not activeESP[admin.UserId] or not activeESP[admin.UserId][target.UserId]) and target.Character then
                            local components = createImprovedESP(target, admin)
                            if components then
                                local connection = RunService.Heartbeat:Connect(function()
                                    if not espEnabled[admin.UserId] then
                                        return
                                    end
                                    updateImprovedESP(admin, target, components)
                                end)
                                
                                if not activeESP[admin.UserId] then
                                    activeESP[admin.UserId] = {}
                                end
                                
                                activeESP[admin.UserId][target.UserId] = {
                                    components = components,
                                    connection = connection
                                }
                            end
                        end
                    end
                end
            end)
        end
    end
end

local function createAdminGui(player)
    -- Initialize settings with new options
    espSettings[player.UserId] = {
        boxEnabled = true,
        tracerEnabled = true,
        nameEnabled = true,
        healthEnabled = true,
        distanceEnabled = true,
        cornerBoxEnabled = true,
        glowEnabled = true,
        weaponEnabled = true,
        headDotEnabled = true
    }
    trackingMode[player.UserId] = "hold"
    toggleTrackingActive[player.UserId] = false
    
    -- Main ScreenGui
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "AdminPanel"
    screenGui.ResetOnSpawn = false
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.Parent = player:WaitForChild("PlayerGui")
    
    -- Main Frame - AIRHUB Style
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 480, 0, 350)
    mainFrame.Position = UDim2.new(0.5, -240, 0.5, -175)
    mainFrame.BackgroundColor3 = Colors.Background
    mainFrame.BackgroundTransparency = 0.05
    mainFrame.BorderSizePixel = 0
    mainFrame.Visible = false
    mainFrame.Active = true
    mainFrame.Draggable = true
    mainFrame.Parent = screenGui
    
    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = UDim.new(0, 6)
    mainCorner.Parent = mainFrame
    
    local mainStroke = Instance.new("UIStroke")
    mainStroke.Color = Colors.Accent
    mainStroke.Thickness = 1.5
    mainStroke.Parent = mainFrame
    
    -- Glow effect
    local glowFrame = Instance.new("ImageLabel")
    glowFrame.Name = "Glow"
    glowFrame.Size = UDim2.new(1, 40, 1, 40)
    glowFrame.Position = UDim2.new(0, -20, 0, -20)
    glowFrame.BackgroundTransparency = 1
    glowFrame.Image = "rbxassetid://5028857084"
    glowFrame.ImageColor3 = Colors.Accent
    glowFrame.ImageTransparency = 0.85
    glowFrame.ScaleType = Enum.ScaleType.Slice
    glowFrame.SliceCenter = Rect.new(24, 24, 276, 276)
    glowFrame.ZIndex = 0
    glowFrame.Parent = mainFrame
    
    -- Title Bar
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 28)
    titleBar.BackgroundColor3 = Colors.AccentDark
    titleBar.BackgroundTransparency = 0.2
    titleBar.BorderSizePixel = 0
    titleBar.Parent = mainFrame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 6)
    titleCorner.Parent = titleBar
    
    local titleFix = Instance.new("Frame")
    titleFix.Size = UDim2.new(1, 0, 0, 6)
    titleFix.Position = UDim2.new(0, 0, 1, -6)
    titleFix.BackgroundColor3 = Colors.AccentDark
    titleFix.BackgroundTransparency = 0.2
    titleFix.BorderSizePixel = 0
    titleFix.Parent = titleBar
    
    -- Title Text with icon
    local titleText = Instance.new("TextLabel")
    titleText.Size = UDim2.new(1, -60, 1, 0)
    titleText.Position = UDim2.new(0, 10, 0, 0)
    titleText.BackgroundTransparency = 1
    titleText.Text = "‚ö° Admin Panel V2.0 | Enhanced ESP"
    titleText.TextColor3 = Colors.Text
    titleText.TextSize = 12
    titleText.Font = Enum.Font.GothamBold
    titleText.TextXAlignment = Enum.TextXAlignment.Left
    titleText.Parent = titleBar
    
    -- Close button
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 24, 0, 24)
    closeBtn.Position = UDim2.new(1, -28, 0, 2)
    closeBtn.BackgroundColor3 = Colors.Danger
    closeBtn.BackgroundTransparency = 0.5
    closeBtn.Text = "‚úï"
    closeBtn.TextColor3 = Colors.Text
    closeBtn.TextSize = 14
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.AutoButtonColor = false
    closeBtn.Parent = titleBar
    
    local closeBtnCorner = Instance.new("UICorner")
    closeBtnCorner.CornerRadius = UDim.new(0, 4)
    closeBtnCorner.Parent = closeBtn
    
    closeBtn.MouseButton1Click:Connect(function()
        mainFrame.Visible = false
    end)
    
    closeBtn.MouseEnter:Connect(function()
        TweenService:Create(closeBtn, TweenInfo.new(0.15), {BackgroundTransparency = 0}):Play()
    end)
    
    closeBtn.MouseLeave:Connect(function()
        TweenService:Create(closeBtn, TweenInfo.new(0.15), {BackgroundTransparency = 0.5}):Play()
    end)
    
    -- Tab Container
    local tabContainer = Instance.new("Frame")
    tabContainer.Name = "TabContainer"
    tabContainer.Size = UDim2.new(1, 0, 0, 24)
    tabContainer.Position = UDim2.new(0, 0, 0, 28)
    tabContainer.BackgroundTransparency = 1
    tabContainer.BorderSizePixel = 0
    tabContainer.Parent = mainFrame
    
    -- Tab buttons
    local tabs = {"Tracking", "ESP", "Visuals", "Teleport", "Functions"}
    local tabButtons = {}
    local currentTab = "Tracking"
    local tabWidth = 1 / #tabs
    
    for i, tabName in ipairs(tabs) do
        local tabBtn = Instance.new("TextButton")
        tabBtn.Name = tabName .. "Tab"
        tabBtn.Size = UDim2.new(tabWidth, -2, 1, 0)
        tabBtn.Position = UDim2.new((i-1) * tabWidth, 1, 0, 0)
        tabBtn.BackgroundColor3 = i == 1 and Colors.TabActive or Colors.TabInactive
        tabBtn.BackgroundTransparency = 0.2
        tabBtn.BorderSizePixel = 0
        tabBtn.Text = tabName
        tabBtn.TextColor3 = i == 1 and Colors.AccentBright or Colors.TextDim
        tabBtn.TextSize = 11
        tabBtn.Font = Enum.Font.GothamMedium
        tabBtn.AutoButtonColor = false
        tabBtn.Parent = tabContainer
        
        tabButtons[tabName] = tabBtn
    end
    
    -- Content Area
    local contentArea = Instance.new("Frame")
    contentArea.Name = "ContentArea"
    contentArea.Size = UDim2.new(1, -16, 1, -70)
    contentArea.Position = UDim2.new(0, 8, 0, 58)
    contentArea.BackgroundTransparency = 1
    contentArea.BorderSizePixel = 0
    contentArea.Parent = mainFrame
    
    -- Status Label at bottom
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Name = "StatusLabel"
    statusLabel.Size = UDim2.new(1, -16, 0, 16)
    statusLabel.Position = UDim2.new(0, 8, 1, -20)
    statusLabel.BackgroundTransparency = 1
    statusLabel.Text = "‚úì Ready | Press RCtrl to toggle | RMB to track nearest"
    statusLabel.TextColor3 = Colors.Success
    statusLabel.TextSize = 10
    statusLabel.Font = Enum.Font.GothamMedium
    statusLabel.TextXAlignment = Enum.TextXAlignment.Left
    statusLabel.Parent = mainFrame
    
    -- Helper Functions for AIRHUB style components
    local function createSection(parent, title, posY, width, height)
        local section = Instance.new("Frame")
        section.Name = title .. "Section"
        section.Size = UDim2.new(0, width, 0, height)
        section.Position = UDim2.new(0, 0, 0, posY)
        section.BackgroundColor3 = Colors.BackgroundTransparent
        section.BackgroundTransparency = 0.4
        section.BorderSizePixel = 0
        section.Parent = parent
        
        local sectionCorner = Instance.new("UICorner")
        sectionCorner.CornerRadius = UDim.new(0, 4)
        sectionCorner.Parent = section
        
        local sectionStroke = Instance.new("UIStroke")
        sectionStroke.Color = Colors.Border
        sectionStroke.Thickness = 1
        sectionStroke.Parent = section
        
        local sectionTitle = Instance.new("TextLabel")
        sectionTitle.Size = UDim2.new(0, #title * 7 + 10, 0, 14)
        sectionTitle.Position = UDim2.new(0, 8, 0, -7)
        sectionTitle.BackgroundColor3 = Colors.Background
        sectionTitle.BorderSizePixel = 0
        sectionTitle.Text = " " .. title .. " "
        sectionTitle.TextColor3 = Colors.AccentBright
        sectionTitle.TextSize = 10
        sectionTitle.Font = Enum.Font.GothamBold
        sectionTitle.Parent = section
        
        local titleCorner = Instance.new("UICorner")
        titleCorner.CornerRadius = UDim.new(0, 2)
        titleCorner.Parent = sectionTitle
        
        return section
    end
    
    local function createCheckbox(parent, text, posX, posY, default, callback)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(0, 110, 0, 18)
        container.Position = UDim2.new(0, posX, 0, posY)
        container.BackgroundTransparency = 1
        container.Parent = parent
        
        local checkbox = Instance.new("Frame")
        checkbox.Size = UDim2.new(0, 14, 0, 14)
        checkbox.Position = UDim2.new(0, 0, 0, 2)
        checkbox.BackgroundColor3 = default and Colors.CheckboxOn or Colors.CheckboxOff
        checkbox.BorderSizePixel = 0
        checkbox.Parent = container
        
        local checkCorner = Instance.new("UICorner")
        checkCorner.CornerRadius = UDim.new(0, 3)
        checkCorner.Parent = checkbox
        
        local checkStroke = Instance.new("UIStroke")
        checkStroke.Color = Colors.Accent
        checkStroke.Thickness = 1
        checkStroke.Parent = checkbox
        
        local checkMark = Instance.new("TextLabel")
        checkMark.Size = UDim2.new(1, 0, 1, 0)
        checkMark.BackgroundTransparency = 1
        checkMark.Text = default and "‚úì" or ""
        checkMark.TextColor3 = Colors.Text
        checkMark.TextSize = 11
        checkMark.Font = Enum.Font.GothamBold
        checkMark.Parent = checkbox
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0, 90, 0, 18)
        label.Position = UDim2.new(0, 18, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = text
        label.TextColor3 = Colors.Text
        label.TextSize = 10
        label.Font = Enum.Font.Gotham
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = container
        
        local isEnabled = default
        
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(1, 0, 1, 0)
        btn.BackgroundTransparency = 1
        btn.Text = ""
        btn.Parent = container
        
        btn.MouseButton1Click:Connect(function()
            isEnabled = not isEnabled
            TweenService:Create(checkbox, TweenInfo.new(0.15), {BackgroundColor3 = isEnabled and Colors.CheckboxOn or Colors.CheckboxOff}):Play()
            checkMark.Text = isEnabled and "‚úì" or ""
            if callback then callback(isEnabled) end
        end)
        
        return container, function() return isEnabled end, function(val)
            isEnabled = val
            checkbox.BackgroundColor3 = isEnabled and Colors.CheckboxOn or Colors.CheckboxOff
            checkMark.Text = isEnabled and "‚úì" or ""
        end
    end
    
    local function createDropdown(parent, label, posX, posY, options, default, callback)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(0, 120, 0, 36)
        container.Position = UDim2.new(0, posX, 0, posY)
        container.BackgroundTransparency = 1
        container.Parent = parent
        
        local labelText = Instance.new("TextLabel")
        labelText.Size = UDim2.new(1, 0, 0, 14)
        labelText.BackgroundTransparency = 1
        labelText.Text = label
        labelText.TextColor3 = Colors.TextDim
        labelText.TextSize = 10
        labelText.Font = Enum.Font.Gotham
        labelText.TextXAlignment = Enum.TextXAlignment.Left
        labelText.Parent = container
        
        local dropBtn = Instance.new("TextButton")
        dropBtn.Size = UDim2.new(1, 0, 0, 20)
        dropBtn.Position = UDim2.new(0, 0, 0, 16)
        dropBtn.BackgroundColor3 = Colors.DropdownBg
        dropBtn.BorderSizePixel = 0
        dropBtn.Text = default
        dropBtn.TextColor3 = Colors.Text
        dropBtn.TextSize = 10
        dropBtn.Font = Enum.Font.Gotham
        dropBtn.AutoButtonColor = false
        dropBtn.Parent = container
        
        local dropCorner = Instance.new("UICorner")
        dropCorner.CornerRadius = UDim.new(0, 3)
        dropCorner.Parent = dropBtn
        
        local dropStroke = Instance.new("UIStroke")
        dropStroke.Color = Colors.Border
        dropStroke.Thickness = 1
        dropStroke.Parent = dropBtn
        
        local arrow = Instance.new("TextLabel")
        arrow.Size = UDim2.new(0, 14, 1, 0)
        arrow.Position = UDim2.new(1, -16, 0, 0)
        arrow.BackgroundTransparency = 1
        arrow.Text = "‚ñº"
        arrow.TextColor3 = Colors.Accent
        arrow.TextSize = 9
        arrow.Font = Enum.Font.GothamBold
        arrow.Parent = dropBtn
        
        local currentSelection = default
        local isOpen = false
        
        local optionsFrame = Instance.new("Frame")
        optionsFrame.Size = UDim2.new(1, 0, 0, #options * 20)
        optionsFrame.Position = UDim2.new(0, 0, 1, 2)
        optionsFrame.BackgroundColor3 = Colors.DropdownBg
        optionsFrame.BorderSizePixel = 0
        optionsFrame.Visible = false
        optionsFrame.ZIndex = 10
        optionsFrame.Parent = dropBtn
        
        local optCorner = Instance.new("UICorner")
        optCorner.CornerRadius = UDim.new(0, 3)
        optCorner.Parent = optionsFrame
        
        local optStroke = Instance.new("UIStroke")
        optStroke.Color = Colors.Accent
        optStroke.Thickness = 1
        optStroke.Parent = optionsFrame
        
        for i, opt in ipairs(options) do
            local optBtn = Instance.new("TextButton")
            optBtn.Size = UDim2.new(1, 0, 0, 20)
            optBtn.Position = UDim2.new(0, 0, 0, (i-1) * 20)
            optBtn.BackgroundTransparency = 1
            optBtn.Text = opt
            optBtn.TextColor3 = Colors.Text
            optBtn.TextSize = 10
            optBtn.Font = Enum.Font.Gotham
            optBtn.ZIndex = 11
            optBtn.Parent = optionsFrame
            
            optBtn.MouseEnter:Connect(function()
                optBtn.TextColor3 = Colors.AccentBright
            end)
            
            optBtn.MouseLeave:Connect(function()
                optBtn.TextColor3 = Colors.Text
            end)
            
            optBtn.MouseButton1Click:Connect(function()
                currentSelection = opt
                dropBtn.Text = opt
                isOpen = false
                optionsFrame.Visible = false
                arrow.Text = "‚ñº"
                if callback then callback(opt) end
            end)
        end
        
        dropBtn.MouseButton1Click:Connect(function()
            isOpen = not isOpen
            optionsFrame.Visible = isOpen
            arrow.Text = isOpen and "‚ñ≤" or "‚ñº"
        end)
        
        return container, function() return currentSelection end
    end
    
    local function createSlider(parent, label, posX, posY, min, max, default, callback)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(0, 140, 0, 36)
        container.Position = UDim2.new(0, posX, 0, posY)
        container.BackgroundTransparency = 1
        container.Parent = parent
        
        local labelText = Instance.new("TextLabel")
        labelText.Size = UDim2.new(0.7, 0, 0, 14)
        labelText.BackgroundTransparency = 1
        labelText.Text = label
        labelText.TextColor3 = Colors.TextDim
        labelText.TextSize = 10
        labelText.Font = Enum.Font.Gotham
        labelText.TextXAlignment = Enum.TextXAlignment.Left
        labelText.Parent = container
        
        local valueLabel = Instance.new("TextLabel")
        valueLabel.Size = UDim2.new(0.3, 0, 0, 14)
        valueLabel.Position = UDim2.new(0.7, 0, 0, 0)
        valueLabel.BackgroundTransparency = 1
        valueLabel.Text = tostring(default)
        valueLabel.TextColor3 = Colors.AccentBright
        valueLabel.TextSize = 10
        valueLabel.Font = Enum.Font.GothamBold
        valueLabel.TextXAlignment = Enum.TextXAlignment.Right
        valueLabel.Parent = container
        
        local sliderBg = Instance.new("Frame")
        sliderBg.Size = UDim2.new(1, 0, 0, 8)
        sliderBg.Position = UDim2.new(0, 0, 0, 20)
        sliderBg.BackgroundColor3 = Colors.SliderBg
        sliderBg.BorderSizePixel = 0
        sliderBg.Parent = container
        
        local sliderCorner = Instance.new("UICorner")
        sliderCorner.CornerRadius = UDim.new(0, 4)
        sliderCorner.Parent = sliderBg
        
        local sliderFill = Instance.new("Frame")
        sliderFill.Size = UDim2.new((default - min) / (max - min), 0, 1, 0)
        sliderFill.BackgroundColor3 = Colors.SliderFill
        sliderFill.BorderSizePixel = 0
        sliderFill.Parent = sliderBg
        
        local fillCorner = Instance.new("UICorner")
        fillCorner.CornerRadius = UDim.new(0, 4)
        fillCorner.Parent = sliderFill
        
        -- Slider knob
        local knob = Instance.new("Frame")
        knob.Size = UDim2.new(0, 14, 0, 14)
        knob.Position = UDim2.new((default - min) / (max - min), -7, 0.5, -7)
        knob.BackgroundColor3 = Colors.AccentBright
        knob.BorderSizePixel = 0
        knob.ZIndex = 2
        knob.Parent = sliderBg
        
        local knobCorner = Instance.new("UICorner")
        knobCorner.CornerRadius = UDim.new(1, 0)
        knobCorner.Parent = knob
        
        local knobStroke = Instance.new("UIStroke")
        knobStroke.Color = Color3.fromRGB(255, 255, 255)
        knobStroke.Thickness = 2
        knobStroke.Parent = knob
        
        local currentValue = default
        local dragging = false
        
        local sliderBtn = Instance.new("TextButton")
        sliderBtn.Size = UDim2.new(1, 0, 1, 14)
        sliderBtn.Position = UDim2.new(0, 0, 0, -7)
        sliderBtn.BackgroundTransparency = 1
        sliderBtn.Text = ""
        sliderBtn.Parent = sliderBg
        
        sliderBtn.MouseButton1Down:Connect(function()
            dragging = true
        end)
        
        UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
        
        RunService.RenderStepped:Connect(function()
            if dragging then
                local mouse = player:GetMouse()
                local relativeX = (mouse.X - sliderBg.AbsolutePosition.X) / sliderBg.AbsoluteSize.X
                relativeX = math.clamp(relativeX, 0, 1)
                currentValue = math.floor(min + relativeX * (max - min))
                sliderFill.Size = UDim2.new(relativeX, 0, 1, 0)
                knob.Position = UDim2.new(relativeX, -7, 0.5, -7)
                valueLabel.Text = tostring(currentValue)
                if callback then callback(currentValue) end
            end
        end)
        
        return container, function() return currentValue end
    end
    
    local function createButton(parent, text, posX, posY, width, callback)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0, width, 0, 22)
        btn.Position = UDim2.new(0, posX, 0, posY)
        btn.BackgroundColor3 = Colors.AccentDark
        btn.BackgroundTransparency = 0.3
        btn.BorderSizePixel = 0
        btn.Text = text
        btn.TextColor3 = Colors.Text
        btn.TextSize = 10
        btn.Font = Enum.Font.GothamMedium
        btn.AutoButtonColor = false
        btn.Parent = parent
        
        local btnCorner = Instance.new("UICorner")
        btnCorner.CornerRadius = UDim.new(0, 3)
        btnCorner.Parent = btn
        
        local btnStroke = Instance.new("UIStroke")
        btnStroke.Color = Colors.Accent
        btnStroke.Thickness = 1
        btnStroke.Parent = btn
        
        btn.MouseEnter:Connect(function()
            TweenService:Create(btn, TweenInfo.new(0.1), {BackgroundColor3 = Colors.Accent, BackgroundTransparency = 0}):Play()
        end)
        
        btn.MouseLeave:Connect(function()
            TweenService:Create(btn, TweenInfo.new(0.1), {BackgroundColor3 = Colors.AccentDark, BackgroundTransparency = 0.3}):Play()
        end)
        
        btn.MouseButton1Click:Connect(callback)
        
        return btn
    end
    
    local function createInput(parent, placeholder, posX, posY, width)
        local inputFrame = Instance.new("Frame")
        inputFrame.Size = UDim2.new(0, width, 0, 20)
        inputFrame.Position = UDim2.new(0, posX, 0, posY)
        inputFrame.BackgroundColor3 = Colors.DropdownBg
        inputFrame.BorderSizePixel = 0
        inputFrame.Parent = parent
        
        local inputCorner = Instance.new("UICorner")
        inputCorner.CornerRadius = UDim.new(0, 3)
        inputCorner.Parent = inputFrame
        
        local inputStroke = Instance.new("UIStroke")
        inputStroke.Color = Colors.Border
        inputStroke.Thickness = 1
        inputStroke.Parent = inputFrame
        
        local textBox = Instance.new("TextBox")
        textBox.Size = UDim2.new(1, -10, 1, 0)
        textBox.Position = UDim2.new(0, 5, 0, 0)
        textBox.BackgroundTransparency = 1
        textBox.Text = ""
        textBox.PlaceholderText = placeholder
        textBox.TextColor3 = Colors.Text
        textBox.PlaceholderColor3 = Colors.TextDim
        textBox.TextSize = 10
        textBox.Font = Enum.Font.Gotham
        textBox.TextXAlignment = Enum.TextXAlignment.Left
        textBox.ClearTextOnFocus = false
        textBox.Parent = inputFrame
        
        textBox.Focused:Connect(function()
            TweenService:Create(inputStroke, TweenInfo.new(0.1), {Color = Colors.Accent}):Play()
        end)
        
        textBox.FocusLost:Connect(function()
            TweenService:Create(inputStroke, TweenInfo.new(0.1), {Color = Colors.Border}):Play()
        end)
        
        return inputFrame, textBox
    end
    
    -- Create Tab Pages
    local tabPages = {}
    
    -- ===== TRACKING TAB =====
    local trackingPage = Instance.new("Frame")
    trackingPage.Name = "TrackingPage"
    trackingPage.Size = UDim2.new(1, 0, 1, 0)
    trackingPage.BackgroundTransparency = 1
    trackingPage.Visible = true
    trackingPage.Parent = contentArea
    tabPages["Tracking"] = trackingPage
    
    -- Values Section (left)
    local valuesSection = createSection(trackingPage, "Values", 0, 220, 110)
    
    createCheckbox(valuesSection, "Enabled", 8, 16, false, function(enabled)
        if enabled then
            local targetName = playerInput and playerInput.Text or ""
            if targetName ~= "" then
                local target = findPlayer(targetName)
                if target and isValidTarget(player, target) then
                    statusLabel.Text = "üéØ Tracking: " .. target.Name
                end
            end
        else
            stopTracking(player)
            statusLabel.Text = "‚úì Tracking disabled"
        end
    end)
    
    createCheckbox(valuesSection, "Toggle Mode", 8, 36, false, function(enabled)
        trackingMode[player.UserId] = enabled and "toggle" or "hold"
    end)
    
    local _, lockPartDropdown = createDropdown(valuesSection, "Lock Part", 8, 56, {"Head", "Torso", "Random"}, "Head", function(val)
        -- Store lock part preference
    end)
    
    createSlider(valuesSection, "Sensitivity:", 8, 90, 1, 10, 6, function(val)
        -- Sensitivity setting
    end)
    
    -- Checks Section
    local checksSection = createSection(trackingPage, "Checks", 120, 220, 80)
    
    createCheckbox(checksSection, "Team Check", 8, 16, true, nil)
    createCheckbox(checksSection, "Wall Check", 8, 36, true, nil)
    createCheckbox(checksSection, "Alive Check", 8, 56, true, nil)
    
    -- Target Info Section (right)
    local targetSection = createSection(trackingPage, "Target Info", 0, 220, 160)
    targetSection.Position = UDim2.new(0, 235, 0, 0)
    
    local targetNameLabel = Instance.new("TextLabel")
    targetNameLabel.Size = UDim2.new(1, -16, 0, 18)
    targetNameLabel.Position = UDim2.new(0, 8, 0, 16)
    targetNameLabel.BackgroundTransparency = 1
    targetNameLabel.Text = "üë§ Target: None"
    targetNameLabel.TextColor3 = Colors.AccentBright
    targetNameLabel.TextSize = 11
    targetNameLabel.Font = Enum.Font.GothamBold
    targetNameLabel.TextXAlignment = Enum.TextXAlignment.Left
    targetNameLabel.Parent = targetSection
    
    local targetCoordsLabel = Instance.new("TextLabel")
    targetCoordsLabel.Size = UDim2.new(1, -16, 0, 14)
    targetCoordsLabel.Position = UDim2.new(0, 8, 0, 36)
    targetCoordsLabel.BackgroundTransparency = 1
    targetCoordsLabel.Text = "üìç X: 0 | Y: 0 | Z: 0"
    targetCoordsLabel.TextColor3 = Colors.Warning
    targetCoordsLabel.TextSize = 10
    targetCoordsLabel.Font = Enum.Font.Gotham
    targetCoordsLabel.TextXAlignment = Enum.TextXAlignment.Left
    targetCoordsLabel.Parent = targetSection
    
    local targetDistLabel = Instance.new("TextLabel")
    targetDistLabel.Size = UDim2.new(0.5, -8, 0, 14)
    targetDistLabel.Position = UDim2.new(0, 8, 0, 52)
    targetDistLabel.BackgroundTransparency = 1
    targetDistLabel.Text = "üìè Distance: 0m"
    targetDistLabel.TextColor3 = Colors.Text
    targetDistLabel.TextSize = 10
    targetDistLabel.Font = Enum.Font.Gotham
    targetDistLabel.TextXAlignment = Enum.TextXAlignment.Left
    targetDistLabel.Parent = targetSection
    
    local targetVisLabel = Instance.new("TextLabel")
    targetVisLabel.Size = UDim2.new(0.5, -8, 0, 14)
    targetVisLabel.Position = UDim2.new(0.5, 0, 0, 52)
    targetVisLabel.BackgroundTransparency = 1
    targetVisLabel.Text = "üëÅ VISIBLE"
    targetVisLabel.TextColor3 = Colors.Success
    targetVisLabel.TextSize = 10
    targetVisLabel.Font = Enum.Font.GothamBold
    targetVisLabel.TextXAlignment = Enum.TextXAlignment.Left
    targetVisLabel.Parent = targetSection
    
    -- Health bar in target section
    local targetHealthBg = Instance.new("Frame")
    targetHealthBg.Size = UDim2.new(1, -16, 0, 10)
    targetHealthBg.Position = UDim2.new(0, 8, 0, 72)
    targetHealthBg.BackgroundColor3 = Colors.SliderBg
    targetHealthBg.BorderSizePixel = 0
    targetHealthBg.Parent = targetSection
    
    local targetHealthCorner = Instance.new("UICorner")
    targetHealthCorner.CornerRadius = UDim.new(0, 5)
    targetHealthCorner.Parent = targetHealthBg
    
    local targetHealthFill = Instance.new("Frame")
    targetHealthFill.Size = UDim2.new(1, 0, 1, 0)
    targetHealthFill.BackgroundColor3 = Colors.Success
    targetHealthFill.BorderSizePixel = 0
    targetHealthFill.Parent = targetHealthBg
    
    local targetHealthFillCorner = Instance.new("UICorner")
    targetHealthFillCorner.CornerRadius = UDim.new(0, 5)
    targetHealthFillCorner.Parent = targetHealthFill
    
    -- Player input
    local _, playerInput = createInput(targetSection, "Enter player name...", 8, 95, 130)
    
    createButton(targetSection, "üéØ Track", 8, 122, 65, function()
        local targetName = playerInput.Text
        if targetName == "" then
            statusLabel.Text = "‚ö† Enter a player name"
            return
        end
        
        stopTracking(player)
        
        local target = findPlayer(targetName)
        if not target then
            statusLabel.Text = "‚ö† Player not found"
            return
        end
        
        if not isValidTarget(player, target) then
            statusLabel.Text = "‚ö† Invalid target"
            return
        end
        
        statusLabel.Text = "üéØ Tracking: " .. target.Name
        targetNameLabel.Text = "üë§ Target: " .. target.Name
        
        local camera = Workspace.CurrentCamera
        
        local connection = RunService.RenderStepped:Connect(function()
            local adminChar = player.Character
            local targetChar = target.Character
            
            if not adminChar or not targetChar then return end
            
            local adminHRP = adminChar:FindFirstChild("HumanoidRootPart")
            local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
            local targetHumanoid = targetChar:FindFirstChild("Humanoid")
            
            if adminHRP and targetHRP and camera then
                local targetPos = targetHRP.Position
                local adminPos = adminHRP.Position
                local distance = (adminPos - targetPos).Magnitude
                local canSee = hasLineOfSight(player, target)
                
                if canSee then
                    local lookAtCFrame = CFrame.new(camera.CFrame.Position, targetPos)
                    camera.CFrame = camera.CFrame:Lerp(lookAtCFrame, 0.1)
                    targetVisLabel.Text = "üëÅ VISIBLE"
                    targetVisLabel.TextColor3 = Colors.Success
                else
                    targetVisLabel.Text = "üö´ HIDDEN"
                    targetVisLabel.TextColor3 = Colors.Danger
                end
                
                targetCoordsLabel.Text = string.format("üìç X: %.0f | Y: %.0f | Z: %.0f", targetPos.X, targetPos.Y, targetPos.Z)
                targetDistLabel.Text = string.format("üìè Distance: %.0fm", distance)
                
                if targetHumanoid then
                    local healthPercent = targetHumanoid.Health / targetHumanoid.MaxHealth
                    targetHealthFill.Size = UDim2.new(healthPercent, 0, 1, 0)
                    
                    if healthPercent > 0.6 then
                        targetHealthFill.BackgroundColor3 = Colors.Success
                    elseif healthPercent > 0.3 then
                        targetHealthFill.BackgroundColor3 = Colors.Warning
                    else
                        targetHealthFill.BackgroundColor3 = Colors.Danger
                    end
                end
            end
        end)
        
        activeTracking[player.UserId] = {
            connection = connection,
            target = target
        }
    end)
    
    createButton(targetSection, "‚¨õ Stop", 80, 122, 60, function()
        if stopTracking(player) then
            targetNameLabel.Text = "üë§ Target: None"
            statusLabel.Text = "‚úì Tracking stopped"
        end
    end)
    
    -- ===== ESP TAB =====
    local espPage = Instance.new("Frame")
    espPage.Name = "ESPPage"
    espPage.Size = UDim2.new(1, 0, 1, 0)
    espPage.BackgroundTransparency = 1
    espPage.Visible = false
    espPage.Parent = contentArea
    tabPages["ESP"] = espPage
    
    -- ESP Settings Section
    local espSettingsSection = createSection(espPage, "ESP Settings", 0, 220, 180)
    
    local espEnabledCheck
    espEnabledCheck = createCheckbox(espSettingsSection, "‚ö° Enabled", 8, 16, false, function(enabled)
        if enabled then
            enableESP(player)
            statusLabel.Text = "‚úì ESP Enabled"
        else
            clearAllESP(player)
            statusLabel.Text = "‚úì ESP Disabled"
        end
    end)
    
    createCheckbox(espSettingsSection, "Box Highlight", 8, 36, true, function(enabled)
        espSettings[player.UserId].boxEnabled = enabled
        if espEnabled[player.UserId] then
            clearAllESP(player)
            enableESP(player)
        end
    end)
    
    createCheckbox(espSettingsSection, "Tracers", 8, 56, true, function(enabled)
        espSettings[player.UserId].tracerEnabled = enabled
        if espEnabled[player.UserId] then
            clearAllESP(player)
            enableESP(player)
        end
    end)
    
    createCheckbox(espSettingsSection, "Names", 8, 76, true, function(enabled)
        espSettings[player.UserId].nameEnabled = enabled
        if espEnabled[player.UserId] then
            clearAllESP(player)
            enableESP(player)
        end
    end)
    
    createCheckbox(espSettingsSection, "Health Bars", 8, 96, true, function(enabled)
        espSettings[player.UserId].healthEnabled = enabled
        if espEnabled[player.UserId] then
            clearAllESP(player)
            enableESP(player)
        end
    end)
    
    createCheckbox(espSettingsSection, "Distance", 8, 116, true, function(enabled)
        espSettings[player.UserId].distanceEnabled = enabled
        if espEnabled[player.UserId] then
            clearAllESP(player)
            enableESP(player)
        end
    end)
    
    createCheckbox(espSettingsSection, "Head Dot", 8, 136, true, function(enabled)
        espSettings[player.UserId].headDotEnabled = enabled
        if espEnabled[player.UserId] then
            clearAllESP(player)
            enableESP(player)
        end
    end)
    
    createCheckbox(espSettingsSection, "Weapon Info", 8, 156, true, function(enabled)
        espSettings[player.UserId].weaponEnabled = enabled
        if espEnabled[player.UserId] then
            clearAllESP(player)
            enableESP(player)
        end
    end)
    
    -- ESP Appearance Section
    local espAppearSection = createSection(espPage, "Appearance", 0, 220, 120)
    espAppearSection.Position = UDim2.new(0, 235, 0, 0)
    
    createSlider(espAppearSection, "Fill Transparency:", 8, 16, 0, 10, 8, nil)
    createSlider(espAppearSection, "Outline Opacity:", 8, 56, 0, 10, 10, nil)
    createSlider(espAppearSection, "Tracer Width:", 8, 96, 1, 5, 2, nil)
    
    -- ESP Color Section
    local espColorSection = createSection(espPage, "Distance Colors", 130, 220, 70)
    espColorSection.Position = UDim2.new(0, 235, 0, 0)
    
    local colorInfo = Instance.new("TextLabel")
    colorInfo.Size = UDim2.new(1, -16, 0, 50)
    colorInfo.Position = UDim2.new(0, 8, 0, 16)
    colorInfo.BackgroundTransparency = 1
    colorInfo.Text = "üî¥ < 30m  |  üü† < 75m\nüü° < 150m  |  üü¢ > 150m"
    colorInfo.TextColor3 = Colors.Text
    colorInfo.TextSize = 10
    colorInfo.Font = Enum.Font.Gotham
    colorInfo.TextXAlignment = Enum.TextXAlignment.Left
    colorInfo.TextYAlignment = Enum.TextYAlignment.Top
    colorInfo.Parent = espColorSection
    
    -- ===== VISUALS TAB =====
    local visualsPage = Instance.new("Frame")
    visualsPage.Name = "VisualsPage"
    visualsPage.Size = UDim2.new(1, 0, 1, 0)
    visualsPage.BackgroundTransparency = 1
    visualsPage.Visible = false
    visualsPage.Parent = contentArea
    tabPages["Visuals"] = visualsPage
    
    -- FOV Section
    local fovSection = createSection(visualsPage, "Field Of View", 0, 220, 100)
    
    createCheckbox(fovSection, "Enabled", 8, 16, false, nil)
    createCheckbox(fovSection, "Visible", 8, 36, true, nil)
    createSlider(fovSection, "FOV Amount:", 8, 56, 50, 120, 90, nil)
    
    -- FOV Circle Appearance
    local fovAppearSection = createSection(visualsPage, "FOV Appearance", 0, 220, 120)
    fovAppearSection.Position = UDim2.new(0, 235, 0, 0)
    
    createCheckbox(fovAppearSection, "Filled", 8, 16, false, nil)
    createSlider(fovAppearSection, "Transparency:", 8, 36, 0, 10, 5, nil)
    createSlider(fovAppearSection, "Sides:", 8, 72, 3, 64, 60, nil)
    
    -- Third Person Section
    local thirdPersonSection = createSection(visualsPage, "Third Person", 110, 220, 70)
    
    createCheckbox(thirdPersonSection, "Enable", 8, 16, false, nil)
    createSlider(thirdPersonSection, "Sensitivity:", 8, 36, 0, 10, 3, nil)
    
    -- ===== TELEPORT TAB =====
    local teleportPage = Instance.new("Frame")
    teleportPage.Name = "TeleportPage"
    teleportPage.Size = UDim2.new(1, 0, 1, 0)
    teleportPage.BackgroundTransparency = 1
    teleportPage.Visible = false
    teleportPage.Parent = contentArea
    tabPages["Teleport"] = teleportPage
    
    -- Teleport Section
    local tpSection = createSection(teleportPage, "Teleport Controls", 0, 220, 160)
    
    local _, tpInput = createInput(tpSection, "Enter player name...", 8, 16, 140)
    
    createButton(tpSection, "üöÄ Teleport To", 8, 45, 100, function()
        local targetName = tpInput.Text
        if targetName == "" then
            statusLabel.Text = "‚ö† Enter a player name"
            return
        end
        
        local target = findPlayer(targetName)
        if not target then
            statusLabel.Text = "‚ö† Player not found"
            return
        end
        
        local adminChar = player.Character
        local targetChar = target.Character
        
        if adminChar and targetChar then
            local adminHRP = adminChar:FindFirstChild("HumanoidRootPart")
            local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
            
            if adminHRP and targetHRP then
                adminHRP.CFrame = targetHRP.CFrame * CFrame.new(0, 0, 3)
                statusLabel.Text = "‚úì Teleported to " .. target.Name
            end
        end
    end)
    
    createButton(tpSection, "üì• Bring Player", 8, 75, 100, function()
        local targetName = tpInput.Text
        if targetName == "" then
            statusLabel.Text = "‚ö† Enter a player name"
            return
        end
        
        local target = findPlayer(targetName)
        if not target then
            statusLabel.Text = "‚ö† Player not found"
            return
        end
        
        local adminChar = player.Character
        local targetChar = target.Character
        
        if adminChar and targetChar then
            local adminHRP = adminChar:FindFirstChild("HumanoidRootPart")
            local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
            
            if adminHRP and targetHRP then
                targetHRP.CFrame = adminHRP.CFrame * CFrame.new(0, 0, 3)
                statusLabel.Text = "‚úì Brought " .. target.Name
            end
        end
    end)
    
    createButton(tpSection, "üìç Locate All", 8, 105, 100, function()
        local count = 0
        for _, p in ipairs(Players:GetPlayers()) do
            if isValidTarget(player, p) then
                local char = p.Character
                if char then
                    local hrp = char:FindFirstChild("HumanoidRootPart")
                    if hrp then
                        count = count + 1
                        local canSee = hasLineOfSight(player, p)
                        print(string.format("[LOCATE] %s %s: X:%.0f Y:%.0f Z:%.0f", canSee and "üëÅ" or "üö´", p.Name, hrp.Position.X, hrp.Position.Y, hrp.Position.Z))
                    end
                end
            end
        end
        statusLabel.Text = "‚úì Located " .. count .. " enemies (check console)"
    end)
    
    -- ===== FUNCTIONS TAB =====
    local functionsPage = Instance.new("Frame")
    functionsPage.Name = "FunctionsPage"
    functionsPage.Size = UDim2.new(1, 0, 1, 0)
    functionsPage.BackgroundTransparency = 1
    functionsPage.Visible = false
    functionsPage.Parent = contentArea
    tabPages["Functions"] = functionsPage
    
    -- Character Section
    local charSection = createSection(functionsPage, "Character", 0, 220, 150)
    
    local godModeEnabled = false
    local godModeConnection = nil
    
    createCheckbox(charSection, "üíõ God Mode", 8, 16, false, function(enabled)
        godModeEnabled = enabled
        
        if enabled then
            godModeConnection = RunService.Heartbeat:Connect(function()
                local char = player.Character
                if char then
                    local humanoid = char:FindFirstChild("Humanoid")
                    if humanoid then
                        humanoid.Health = humanoid.MaxHealth
                    end
                end
            end)
            statusLabel.Text = "‚úì God Mode enabled"
        else
            if godModeConnection then
                godModeConnection:Disconnect()
                godModeConnection = nil
            end
            statusLabel.Text = "‚úì God Mode disabled"
        end
    end)
    
    createCheckbox(charSection, "‚ö° Speed Boost", 8, 36, false, function(enabled)
        local char = player.Character
        if char then
            local humanoid = char:FindFirstChild("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = enabled and 100 or 16
                statusLabel.Text = enabled and "‚úì Speed Boost ON" or "‚úì Speed Boost OFF"
            end
        end
    end)
    
    createCheckbox(charSection, "ü¶ò Infinite Jump", 8, 56, false, function(enabled)
        statusLabel.Text = enabled and "‚úì Inf Jump ON" or "‚úì Inf Jump OFF"
    end)
    
    createCheckbox(charSection, "üëª No Clip", 8, 76, false, function(enabled)
        statusLabel.Text = enabled and "‚úì No Clip ON" or "‚úì No Clip OFF"
    end)
    
    createSlider(charSection, "Walk Speed:", 8, 100, 16, 200, 16, function(val)
        local char = player.Character
        if char then
            local humanoid = char:FindFirstChild("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = val
            end
        end
    end)
    
    -- Items Section
    local itemsSection = createSection(functionsPage, "Items & Stats", 0, 220, 90)
    itemsSection.Position = UDim2.new(0, 235, 0, 0)
    
    createButton(itemsSection, "üîì Unlock All", 8, 16, 110, function()
        local itemsFolder = ServerStorage:FindFirstChild("Items")
        if itemsFolder then
            for _, item in ipairs(itemsFolder:GetChildren()) do
                local clone = item:Clone()
                clone.Parent = player.Backpack
            end
        end
        statusLabel.Text = "‚úì Items unlocked"
    end)
    
    createButton(itemsSection, "üìä Max Stats", 8, 46, 110, function()
        local leaderstats = player:FindFirstChild("leaderstats")
        if leaderstats then
            for _, stat in ipairs(leaderstats:GetChildren()) do
                if stat:IsA("IntValue") or stat:IsA("NumberValue") then
                    stat.Value = 999999
                end
            end
        end
        statusLabel.Text = "‚úì Stats maxed"
    end)
    
    -- Tab switching logic
    for tabName, tabBtn in pairs(tabButtons) do
        tabBtn.MouseButton1Click:Connect(function()
            for name, btn in pairs(tabButtons) do
                TweenService:Create(btn, TweenInfo.new(0.15), {
                    BackgroundColor3 = name == tabName and Colors.TabActive or Colors.TabInactive,
                    TextColor3 = name == tabName and Colors.AccentBright or Colors.TextDim
                }):Play()
            end
            
            for name, page in pairs(tabPages) do
                page.Visible = name == tabName
            end
            
            currentTab = tabName
        end)
    end
    
    -- RMB Tracking
    local function startRMBTracking()
        stopRightMouseTracking(player)
        
        local nearestPlayer, distance = getNearestValidTarget(player)
        if not nearestPlayer then
            statusLabel.Text = "‚ö† No visible enemies nearby"
            return
        end
        
        statusLabel.Text = "üéØ RMB tracking: " .. nearestPlayer.Name
        targetNameLabel.Text = "üë§ Target: " .. nearestPlayer.Name .. " (RMB)"
        
        local camera = Workspace.CurrentCamera
        
        local connection = RunService.RenderStepped:Connect(function()
            local currentNearest, dist = getNearestValidTarget(player)
            if not currentNearest then 
                targetVisLabel.Text = "‚ö† NO TARGET"
                targetVisLabel.TextColor3 = Colors.Warning
                return 
            end
            
            local adminChar = player.Character
            local targetChar = currentNearest.Character
            
            if not adminChar or not targetChar then return end
            
            local adminHRP = adminChar:FindFirstChild("HumanoidRootPart")
            local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
            local targetHumanoid = targetChar:FindFirstChild("Humanoid")
            
            if adminHRP and targetHRP and camera then
                local targetPos = targetHRP.Position
                
                local lookAtCFrame = CFrame.new(camera.CFrame.Position, targetPos)
                camera.CFrame = camera.CFrame:Lerp(lookAtCFrame, 0.2)
                
                targetNameLabel.Text = "üë§ Target: " .. currentNearest.Name .. " (RMB)"
                targetCoordsLabel.Text = string.format("üìç X: %.0f | Y: %.0f | Z: %.0f", targetPos.X, targetPos.Y, targetPos.Z)
                targetDistLabel.Text = string.format("üìè Distance: %.0fm", dist)
                targetVisLabel.Text = "üîí LOCKED"
                targetVisLabel.TextColor3 = Colors.Success
                
                if targetHumanoid then
                    local healthPercent = targetHumanoid.Health / targetHumanoid.MaxHealth
                    targetHealthFill.Size = UDim2.new(healthPercent, 0, 1, 0)
                    
                    if healthPercent > 0.6 then
                        targetHealthFill.BackgroundColor3 = Colors.Success
                    elseif healthPercent > 0.3 then
                        targetHealthFill.BackgroundColor3 = Colors.Warning
                    else
                        targetHealthFill.BackgroundColor3 = Colors.Danger
                    end
                end
            end
        end)
        
        rightMouseTracking[player.UserId] = {
            connection = connection
        }
    end
    
    local function stopRMBTrackingUI()
        stopRightMouseTracking(player)
        if not activeTracking[player.UserId] then
            targetNameLabel.Text = "üë§ Target: None"
            statusLabel.Text = "‚úì Ready | RCtrl to toggle | RMB to track"
        end
    end
    
    -- Input Handling
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        
        if input.KeyCode == Enum.KeyCode.RightControl then
            mainFrame.Visible = not mainFrame.Visible
        end
        
        if input.UserInputType == Enum.UserInputType.MouseButton2 then
            if trackingMode[player.UserId] == "hold" then
                startRMBTracking()
            else
                if toggleTrackingActive[player.UserId] then
                    toggleTrackingActive[player.UserId] = false
                    stopRMBTrackingUI()
                else
                    toggleTrackingActive[player.UserId] = true
                    startRMBTracking()
                end
            end
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input, gameProcessed)
        if input.UserInputType == Enum.UserInputType.MouseButton2 then
            if trackingMode[player.UserId] == "hold" then
                stopRMBTrackingUI()
            end
        end
    end)
end

-- Give GUI to admins
Players.PlayerAdded:Connect(function(player)
    if isAdmin(player) then
        createAdminGui(player)
    end
end)

-- For admins already in game
for _, player in ipairs(Players:GetPlayers()) do
    if isAdmin(player) then
        createAdminGui(player)
    end
end
