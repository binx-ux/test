-- ServerScriptService
-- Clean Cheat-Style Admin Panel V3

-- Services
local Players = game:GetService("Players")
local ServerStorage = game:GetService("ServerStorage")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local activeTracking = {}
local activeESP = {}
local espEnabled = {}
local rightMouseTracking = {}
local espSettings = {}
local trackingMode = {}
local toggleTrackingActive = {}
local camTrackingSettings = {}

-- Clean Color Scheme
local Colors = {
    Background = Color3.fromRGB(20, 20, 25),
    BackgroundLight = Color3.fromRGB(30, 30, 38),
    Accent = Color3.fromRGB(130, 80, 200),
    AccentBright = Color3.fromRGB(160, 100, 255),
    Border = Color3.fromRGB(50, 50, 60),
    Text = Color3.fromRGB(220, 220, 230),
    TextDim = Color3.fromRGB(120, 120, 130),
    
    -- ESP Colors
    ESP_Close = Color3.fromRGB(255, 60, 60),
    ESP_Medium = Color3.fromRGB(255, 180, 50),
    ESP_Far = Color3.fromRGB(255, 255, 80),
    ESP_VeryFar = Color3.fromRGB(80, 255, 80),
    ESP_Visible = Color3.fromRGB(0, 255, 200),
    ESP_Hidden = Color3.fromRGB(255, 80, 80),
    
    Health_High = Color3.fromRGB(80, 255, 80),
    Health_Mid = Color3.fromRGB(255, 200, 50),
    Health_Low = Color3.fromRGB(255, 60, 60),
}

-- Skeleton bone connections
local SKELETON_CONNECTIONS = {
    -- Head to Torso
    {"Head", "UpperTorso"},
    {"UpperTorso", "LowerTorso"},
    
    -- Left Arm
    {"UpperTorso", "LeftUpperArm"},
    {"LeftUpperArm", "LeftLowerArm"},
    {"LeftLowerArm", "LeftHand"},
    
    -- Right Arm
    {"UpperTorso", "RightUpperArm"},
    {"RightUpperArm", "RightLowerArm"},
    {"RightLowerArm", "RightHand"},
    
    -- Left Leg
    {"LowerTorso", "LeftUpperLeg"},
    {"LeftUpperLeg", "LeftLowerLeg"},
    {"LeftLowerLeg", "LeftFoot"},
    
    -- Right Leg
    {"LowerTorso", "RightUpperLeg"},
    {"RightUpperLeg", "RightLowerLeg"},
    {"RightLowerLeg", "RightFoot"},
}

-- R6 Skeleton
local SKELETON_R6 = {
    {"Head", "Torso"},
    {"Torso", "Left Arm"},
    {"Torso", "Right Arm"},
    {"Torso", "Left Leg"},
    {"Torso", "Right Leg"},
}

local function isSameTeam(player1, player2)
    if not player1.Team or not player2.Team then return false end
    return player1.Team == player2.Team
end

local function isValidTarget(admin, target)
    if target == admin then return false end
    if isSameTeam(admin, target) then return false end
    return true
end

local function hasLineOfSight(admin, target)
    local adminChar = admin.Character
    local targetChar = target.Character
    if not adminChar or not targetChar then return false end
    
    local adminHead = adminChar:FindFirstChild("Head")
    local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
    if not adminHead or not targetHRP then return false end
    
    local origin = adminHead.Position
    local destination = targetHRP.Position
    local direction = (destination - origin)
    
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    raycastParams.FilterDescendantsInstances = {adminChar, targetChar}
    raycastParams.IgnoreWater = true
    
    local raycastResult = Workspace:Raycast(origin, direction, raycastParams)
    return raycastResult == nil
end

local function findPlayer(name)
    name = name:lower()
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Name:lower():sub(1, #name) == name then
            return player
        end
    end
    return nil
end

local function getNearestValidTarget(admin)
    local adminChar = admin.Character
    if not adminChar then return nil end
    
    local adminHRP = adminChar:FindFirstChild("HumanoidRootPart")
    if not adminHRP then return nil end
    
    local nearestPlayer = nil
    local nearestDistance = math.huge
    
    for _, player in ipairs(Players:GetPlayers()) do
        if isValidTarget(admin, player) then
            local char = player.Character
            if char then
                local hrp = char:FindFirstChild("HumanoidRootPart")
                if hrp then
                    local distance = (adminHRP.Position - hrp.Position).Magnitude
                    if distance < nearestDistance and hasLineOfSight(admin, player) then
                        nearestDistance = distance
                        nearestPlayer = player
                    end
                end
            end
        end
    end
    
    return nearestPlayer, nearestDistance
end

local function stopTracking(admin)
    if activeTracking[admin.UserId] then
        if activeTracking[admin.UserId].connection then
            activeTracking[admin.UserId].connection:Disconnect()
        end
        activeTracking[admin.UserId] = nil
        return true
    end
    return false
end

local function stopRightMouseTracking(admin)
    if rightMouseTracking[admin.UserId] then
        if rightMouseTracking[admin.UserId].connection then
            rightMouseTracking[admin.UserId].connection:Disconnect()
        end
        rightMouseTracking[admin.UserId] = nil
        return true
    end
    return false
end

local function getESPColor(distance, canSee)
    if distance < 30 then
        return Colors.ESP_Close
    elseif distance < 75 then
        return Colors.ESP_Medium
    elseif distance < 150 then
        return Colors.ESP_Far
    else
        return Colors.ESP_VeryFar
    end
end

local function getHealthColor(percent)
    if percent > 0.6 then
        return Colors.Health_High
    elseif percent > 0.3 then
        return Colors.Health_Mid
    else
        return Colors.Health_Low
    end
end

-- ========================================
-- CLEAN CHEAT-STYLE ESP
-- ========================================

local function createCleanESP(target, admin, screenGui)
    if not target.Character then return nil end
    if not isValidTarget(admin, target) then return nil end
    
    local existingFolder = target.Character:FindFirstChild("AdminESP_" .. admin.UserId)
    if existingFolder then existingFolder:Destroy() end
    
    local espFolder = Instance.new("Folder")
    espFolder.Name = "AdminESP_" .. admin.UserId
    espFolder.Parent = target.Character
    
    local settings = espSettings[admin.UserId] or {}
    
    -- ====== DRAWING FRAME (for 2D elements) ======
    local drawingFrame = Instance.new("Frame")
    drawingFrame.Name = "ESPDrawing_" .. target.UserId
    drawingFrame.Size = UDim2.new(1, 0, 1, 0)
    drawingFrame.BackgroundTransparency = 1
    drawingFrame.Parent = screenGui
    
    -- ====== MINIMAL INFO BILLBOARD ======
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Name = "InfoBoard"
    billboardGui.Adornee = target.Character:FindFirstChild("Head")
    billboardGui.Size = UDim2.new(0, 120, 0, 40)
    billboardGui.StudsOffset = Vector3.new(0, 2.2, 0)
    billboardGui.AlwaysOnTop = true
    billboardGui.MaxDistance = 800
    billboardGui.Parent = espFolder
    
    -- Name Label (clean, no background)
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "NameLabel"
    nameLabel.Size = UDim2.new(1, 0, 0, 14)
    nameLabel.Position = UDim2.new(0, 0, 0, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = target.Name
    nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    nameLabel.TextStrokeTransparency = 0.3
    nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    nameLabel.TextSize = 12
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.Visible = settings.nameEnabled ~= false
    nameLabel.Parent = billboardGui
    
    -- Distance Label
    local distanceLabel = Instance.new("TextLabel")
    distanceLabel.Name = "DistanceLabel"
    distanceLabel.Size = UDim2.new(1, 0, 0, 12)
    distanceLabel.Position = UDim2.new(0, 0, 0, 14)
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.Text = "[0m]"
    distanceLabel.TextColor3 = Colors.ESP_Far
    distanceLabel.TextStrokeTransparency = 0.3
    distanceLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    distanceLabel.TextSize = 10
    distanceLabel.Font = Enum.Font.Gotham
    distanceLabel.Visible = settings.distanceEnabled ~= false
    distanceLabel.Parent = billboardGui
    
    -- Health Bar (thin, side bar style)
    local healthBarBg = Instance.new("Frame")
    healthBarBg.Name = "HealthBarBg"
    healthBarBg.Size = UDim2.new(0, 3, 0, 24)
    healthBarBg.Position = UDim2.new(0, -8, 0, 4)
    healthBarBg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    healthBarBg.BackgroundTransparency = 0.3
    healthBarBg.BorderSizePixel = 0
    healthBarBg.Visible = settings.healthEnabled ~= false
    healthBarBg.Parent = billboardGui
    
    local healthBarFill = Instance.new("Frame")
    healthBarFill.Name = "HealthBarFill"
    healthBarFill.Size = UDim2.new(1, 0, 1, 0)
    healthBarFill.Position = UDim2.new(0, 0, 0, 0)
    healthBarFill.AnchorPoint = Vector2.new(0, 1)
    healthBarFill.BackgroundColor3 = Colors.Health_High
    healthBarFill.BorderSizePixel = 0
    healthBarFill.Parent = healthBarBg
    
    -- ====== SKELETON ESP ======
    local skeletonParts = {}
    local isR15 = target.Character:FindFirstChild("UpperTorso") ~= nil
    local bones = isR15 and SKELETON_CONNECTIONS or SKELETON_R6
    
    if settings.skeletonEnabled then
        for i, connection in ipairs(bones) do
            local line = Instance.new("Frame")
            line.Name = "Bone_" .. i
            line.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            line.BorderSizePixel = 0
            line.AnchorPoint = Vector2.new(0.5, 0)
            line.Visible = false
            line.Parent = drawingFrame
            
            table.insert(skeletonParts, {
                line = line,
                part1 = connection[1],
                part2 = connection[2]
            })
        end
    end
    
    -- ====== CORNER BOX ======
    local cornerLines = {}
    if settings.boxEnabled ~= false then
        for i = 1, 8 do
            local line = Instance.new("Frame")
            line.Name = "Corner_" .. i
            line.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            line.BorderSizePixel = 0
            line.Visible = false
            line.Parent = drawingFrame
            table.insert(cornerLines, line)
        end
    end
    
    -- ====== THIN TRACER LINE ======
    local tracerLine = Instance.new("Frame")
    tracerLine.Name = "Tracer"
    tracerLine.BackgroundColor3 = Colors.ESP_Far
    tracerLine.BorderSizePixel = 0
    tracerLine.AnchorPoint = Vector2.new(0.5, 0)
    tracerLine.Visible = settings.tracerEnabled ~= false
    tracerLine.Parent = drawingFrame
    
    -- ====== HEAD DOT ======
    local headDot = Instance.new("Frame")
    headDot.Name = "HeadDot"
    headDot.Size = UDim2.new(0, 6, 0, 6)
    headDot.BackgroundColor3 = Colors.ESP_Close
    headDot.BorderSizePixel = 0
    headDot.Visible = settings.headDotEnabled ~= false
    headDot.Parent = drawingFrame
    
    local headDotCorner = Instance.new("UICorner")
    headDotCorner.CornerRadius = UDim.new(1, 0)
    headDotCorner.Parent = headDot
    
    local headDotStroke = Instance.new("UIStroke")
    headDotStroke.Color = Color3.fromRGB(0, 0, 0)
    headDotStroke.Thickness = 1
    headDotStroke.Parent = headDot
    
    -- ====== OFFSCREEN ARROW ======
    local offscreenArrow = Instance.new("ImageLabel")
    offscreenArrow.Name = "OffscreenArrow"
    offscreenArrow.Size = UDim2.new(0, 20, 0, 20)
    offscreenArrow.BackgroundTransparency = 1
    offscreenArrow.Image = "rbxassetid://3926305904"
    offscreenArrow.ImageRectOffset = Vector2.new(924, 724)
    offscreenArrow.ImageRectSize = Vector2.new(36, 36)
    offscreenArrow.ImageColor3 = Colors.ESP_Close
    offscreenArrow.Visible = false
    offscreenArrow.AnchorPoint = Vector2.new(0.5, 0.5)
    offscreenArrow.Parent = drawingFrame
    
    -- Custom triangle arrow using frame
    local arrowFrame = Instance.new("Frame")
    arrowFrame.Name = "ArrowIndicator"
    arrowFrame.Size = UDim2.new(0, 0, 0, 0)
    arrowFrame.BackgroundTransparency = 1
    arrowFrame.Visible = false
    arrowFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    arrowFrame.Parent = drawingFrame
    
    -- Arrow made of 3 lines forming a triangle
    local arrowLines = {}
    for i = 1, 3 do
        local line = Instance.new("Frame")
        line.Name = "ArrowLine" .. i
        line.BackgroundColor3 = Colors.ESP_Close
        line.BorderSizePixel = 0
        line.AnchorPoint = Vector2.new(0.5, 0.5)
        line.Parent = arrowFrame
        table.insert(arrowLines, line)
    end
    
    return {
        folder = espFolder,
        drawingFrame = drawingFrame,
        billboard = billboardGui,
        nameLabel = nameLabel,
        distanceLabel = distanceLabel,
        healthBarBg = healthBarBg,
        healthBarFill = healthBarFill,
        skeletonParts = skeletonParts,
        cornerLines = cornerLines,
        tracerLine = tracerLine,
        headDot = headDot,
        isR15 = isR15,
        bones = bones,
        arrowFrame = arrowFrame,
        arrowLines = arrowLines
    }
end

local function worldToScreen(position)
    local camera = Workspace.CurrentCamera
    if not camera then return nil, false end
    
    local screenPos, onScreen = camera:WorldToViewportPoint(position)
    return Vector2.new(screenPos.X, screenPos.Y), onScreen and screenPos.Z > 0
end

local function drawLine(frame, p1, p2, thickness, color)
    local distance = (p2 - p1).Magnitude
    local center = (p1 + p2) / 2
    local angle = math.atan2(p2.Y - p1.Y, p2.X - p1.X)
    
    frame.Size = UDim2.new(0, distance, 0, thickness)
    frame.Position = UDim2.new(0, center.X, 0, center.Y)
    frame.Rotation = math.deg(angle)
    frame.BackgroundColor3 = color
    frame.Visible = true
end

local function updateCleanESP(admin, target, espComponents)
    if not admin.Character or not target.Character then return false end
    if not isValidTarget(admin, target) then
        if espComponents.folder then espComponents.folder:Destroy() end
        if espComponents.drawingFrame then espComponents.drawingFrame:Destroy() end
        return false
    end
    
    local adminHRP = admin.Character:FindFirstChild("HumanoidRootPart")
    local targetHRP = target.Character:FindFirstChild("HumanoidRootPart")
    local targetHead = target.Character:FindFirstChild("Head")
    local targetHumanoid = target.Character:FindFirstChild("Humanoid")
    
    if not adminHRP or not targetHRP then return true end
    
    local camera = Workspace.CurrentCamera
    if not camera then return true end
    
    local distance = (adminHRP.Position - targetHRP.Position).Magnitude
    local canSee = hasLineOfSight(admin, target)
    local espColor = getESPColor(distance, canSee)
    
    local settings = espSettings[admin.UserId] or {}
    local tracerThickness = settings.tracerThickness or 1
    local boxThickness = settings.boxThickness or 1
    
    -- Update distance label
    if espComponents.distanceLabel then
        espComponents.distanceLabel.Text = string.format("[%dm]", math.floor(distance))
        espComponents.distanceLabel.TextColor3 = espColor
    end
    
    -- Update name color based on visibility
    if espComponents.nameLabel then
        espComponents.nameLabel.TextColor3 = canSee and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(180, 180, 180)
    end
    
    -- Update health
    if targetHumanoid and espComponents.healthBarFill then
        local healthPercent = math.clamp(targetHumanoid.Health / targetHumanoid.MaxHealth, 0, 1)
        espComponents.healthBarFill.Size = UDim2.new(1, 0, healthPercent, 0)
        espComponents.healthBarFill.Position = UDim2.new(0, 0, 1, 0)
        espComponents.healthBarFill.BackgroundColor3 = getHealthColor(healthPercent)
    end
    
    -- ====== CORNER BOX ======
    if #espComponents.cornerLines > 0 and settings.boxEnabled ~= false then
        local hrpPos, onScreen = worldToScreen(targetHRP.Position)
        local headPos = targetHead and worldToScreen(targetHead.Position + Vector3.new(0, 0.5, 0))
        local footPos = worldToScreen(targetHRP.Position - Vector3.new(0, 3, 0))
        
        if onScreen and hrpPos and headPos and footPos then
            local height = math.abs(footPos.Y - headPos.Y)
            local width = height * 0.6
            
            local topLeft = Vector2.new(hrpPos.X - width/2, headPos.Y)
            local topRight = Vector2.new(hrpPos.X + width/2, headPos.Y)
            local bottomLeft = Vector2.new(hrpPos.X - width/2, footPos.Y)
            local bottomRight = Vector2.new(hrpPos.X + width/2, footPos.Y)
            
            local cornerSize = math.min(width, height) * 0.25
            
            -- Top Left Corner
            espComponents.cornerLines[1].Size = UDim2.new(0, cornerSize, 0, boxThickness)
            espComponents.cornerLines[1].Position = UDim2.new(0, topLeft.X, 0, topLeft.Y)
            espComponents.cornerLines[1].BackgroundColor3 = espColor
            espComponents.cornerLines[1].Visible = true
            
            espComponents.cornerLines[2].Size = UDim2.new(0, boxThickness, 0, cornerSize)
            espComponents.cornerLines[2].Position = UDim2.new(0, topLeft.X, 0, topLeft.Y)
            espComponents.cornerLines[2].BackgroundColor3 = espColor
            espComponents.cornerLines[2].Visible = true
            
            -- Top Right Corner
            espComponents.cornerLines[3].Size = UDim2.new(0, cornerSize, 0, boxThickness)
            espComponents.cornerLines[3].Position = UDim2.new(0, topRight.X - cornerSize, 0, topRight.Y)
            espComponents.cornerLines[3].BackgroundColor3 = espColor
            espComponents.cornerLines[3].Visible = true
            
            espComponents.cornerLines[4].Size = UDim2.new(0, boxThickness, 0, cornerSize)
            espComponents.cornerLines[4].Position = UDim2.new(0, topRight.X - boxThickness, 0, topRight.Y)
            espComponents.cornerLines[4].BackgroundColor3 = espColor
            espComponents.cornerLines[4].Visible = true
            
            -- Bottom Left Corner
            espComponents.cornerLines[5].Size = UDim2.new(0, cornerSize, 0, boxThickness)
            espComponents.cornerLines[5].Position = UDim2.new(0, bottomLeft.X, 0, bottomLeft.Y - boxThickness)
            espComponents.cornerLines[5].BackgroundColor3 = espColor
            espComponents.cornerLines[5].Visible = true
            
            espComponents.cornerLines[6].Size = UDim2.new(0, boxThickness, 0, cornerSize)
            espComponents.cornerLines[6].Position = UDim2.new(0, bottomLeft.X, 0, bottomLeft.Y - cornerSize)
            espComponents.cornerLines[6].BackgroundColor3 = espColor
            espComponents.cornerLines[6].Visible = true
            
            -- Bottom Right Corner
            espComponents.cornerLines[7].Size = UDim2.new(0, cornerSize, 0, boxThickness)
            espComponents.cornerLines[7].Position = UDim2.new(0, bottomRight.X - cornerSize, 0, bottomRight.Y - boxThickness)
            espComponents.cornerLines[7].BackgroundColor3 = espColor
            espComponents.cornerLines[7].Visible = true
            
            espComponents.cornerLines[8].Size = UDim2.new(0, boxThickness, 0, cornerSize)
            espComponents.cornerLines[8].Position = UDim2.new(0, bottomRight.X - boxThickness, 0, bottomRight.Y - cornerSize)
            espComponents.cornerLines[8].BackgroundColor3 = espColor
            espComponents.cornerLines[8].Visible = true
        else
            for _, line in ipairs(espComponents.cornerLines) do
                line.Visible = false
            end
        end
    end
    
    -- ====== SKELETON ======
    if #espComponents.skeletonParts > 0 and settings.skeletonEnabled then
        for _, bone in ipairs(espComponents.skeletonParts) do
            local part1 = target.Character:FindFirstChild(bone.part1)
            local part2 = target.Character:FindFirstChild(bone.part2)
            
            if part1 and part2 then
                local pos1, onScreen1 = worldToScreen(part1.Position)
                local pos2, onScreen2 = worldToScreen(part2.Position)
                
                if onScreen1 and onScreen2 then
                    drawLine(bone.line, pos1, pos2, settings.skeletonThickness or 1, espColor)
                else
                    bone.line.Visible = false
                end
            else
                bone.line.Visible = false
            end
        end
    end
    
    -- ====== THIN TRACER ======
    if espComponents.tracerLine and settings.tracerEnabled ~= false then
        local targetPos, onScreen = worldToScreen(targetHRP.Position)
        local screenSize = camera.ViewportSize
        local startPos = Vector2.new(screenSize.X / 2, screenSize.Y) -- Bottom center
        
        if settings.tracerOrigin == "Top" then
            startPos = Vector2.new(screenSize.X / 2, 0)
        elseif settings.tracerOrigin == "Mouse" then
            local mouse = admin:GetMouse()
            startPos = Vector2.new(mouse.X, mouse.Y)
        end
        
        if onScreen and targetPos then
            drawLine(espComponents.tracerLine, startPos, targetPos, tracerThickness, espColor)
        else
            espComponents.tracerLine.Visible = false
        end
    end
    
    -- ====== HEAD DOT ======
    if espComponents.headDot and targetHead and settings.headDotEnabled ~= false then
        local headScreenPos, onScreen = worldToScreen(targetHead.Position)
        if onScreen and headScreenPos then
            espComponents.headDot.Position = UDim2.new(0, headScreenPos.X - 3, 0, headScreenPos.Y - 3)
            espComponents.headDot.BackgroundColor3 = canSee and Colors.ESP_Visible or Colors.ESP_Hidden
            espComponents.headDot.Visible = true
        else
            espComponents.headDot.Visible = false
        end
    end
    
    -- ====== OFFSCREEN ARROWS ======
    if espComponents.arrowFrame and espComponents.arrowLines and settings.offscreenArrows then
        local targetPos, onScreen = worldToScreen(targetHRP.Position)
        
        if not onScreen and distance < (settings.arrowDistance or 500) then
            local camera = Workspace.CurrentCamera
            local screenSize = camera.ViewportSize
            local screenCenter = Vector2.new(screenSize.X / 2, screenSize.Y / 2)
            
            -- Get direction to target in screen space
            local camCF = camera.CFrame
            local targetDirection = (targetHRP.Position - camCF.Position).Unit
            local camLook = camCF.LookVector
            local camRight = camCF.RightVector
            local camUp = camCF.UpVector
            
            local x = targetDirection:Dot(camRight)
            local y = targetDirection:Dot(camUp)
            
            local angle = math.atan2(y, x)
            
            -- Position arrow on screen edge
            local arrowDist = math.min(screenSize.X, screenSize.Y) / 2 - 50
            local arrowX = screenCenter.X + math.cos(angle) * arrowDist
            local arrowY = screenCenter.Y - math.sin(angle) * arrowDist
            
            -- Clamp to screen bounds
            arrowX = math.clamp(arrowX, 40, screenSize.X - 40)
            arrowY = math.clamp(arrowY, 40, screenSize.Y - 40)
            
            espComponents.arrowFrame.Position = UDim2.new(0, arrowX, 0, arrowY)
            espComponents.arrowFrame.Rotation = -math.deg(angle) + 90
            espComponents.arrowFrame.Visible = true
            
            -- Draw arrow triangle
            local arrowSize = settings.arrowSize or 15
            local arrowColor = espColor
            
            -- Line 1 (left side)
            espComponents.arrowLines[1].Size = UDim2.new(0, arrowSize, 0, 3)
            espComponents.arrowLines[1].Position = UDim2.new(0, -arrowSize/2, 0, arrowSize/2)
            espComponents.arrowLines[1].Rotation = 45
            espComponents.arrowLines[1].BackgroundColor3 = arrowColor
            espComponents.arrowLines[1].Visible = true
            
            -- Line 2 (right side)
            espComponents.arrowLines[2].Size = UDim2.new(0, arrowSize, 0, 3)
            espComponents.arrowLines[2].Position = UDim2.new(0, arrowSize/2, 0, arrowSize/2)
            espComponents.arrowLines[2].Rotation = -45
            espComponents.arrowLines[2].BackgroundColor3 = arrowColor
            espComponents.arrowLines[2].Visible = true
            
            -- Line 3 (bottom connector) - optional
            espComponents.arrowLines[3].Visible = false
        else
            espComponents.arrowFrame.Visible = false
            for _, line in ipairs(espComponents.arrowLines) do
                line.Visible = false
            end
        end
    end
    
    return true
end

local function clearAllESP(admin)
    if activeESP[admin.UserId] then
        for _, data in pairs(activeESP[admin.UserId]) do
            if data.connection then data.connection:Disconnect() end
            if data.components then
                if data.components.folder then data.components.folder:Destroy() end
                if data.components.drawingFrame then data.components.drawingFrame:Destroy() end
            end
        end
        activeESP[admin.UserId] = nil
    end
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Character then
            local folder = player.Character:FindFirstChild("AdminESP_" .. admin.UserId)
            if folder then folder:Destroy() end
        end
    end
    
    espEnabled[admin.UserId] = false
end

local function enableESP(admin, screenGui)
    clearAllESP(admin)
    
    activeESP[admin.UserId] = {}
    espEnabled[admin.UserId] = true
    
    local function setupESPForTarget(target)
        if isValidTarget(admin, target) and target.Character then
            local components = createCleanESP(target, admin, screenGui)
            if components then
                local connection = RunService.RenderStepped:Connect(function()
                    if not espEnabled[admin.UserId] then return end
                    local stillValid = updateCleanESP(admin, target, components)
                    if not stillValid then
                        if activeESP[admin.UserId] and activeESP[admin.UserId][target.UserId] then
                            activeESP[admin.UserId][target.UserId].connection:Disconnect()
                            activeESP[admin.UserId][target.UserId] = nil
                        end
                    end
                end)
                
                activeESP[admin.UserId][target.UserId] = {
                    components = components,
                    connection = connection
                }
            end
        end
    end
    
    for _, target in ipairs(Players:GetPlayers()) do
        setupESPForTarget(target)
    end
    
    Players.PlayerAdded:Connect(function(target)
        if not espEnabled[admin.UserId] then return end
        target.CharacterAdded:Wait()
        task.wait(1)
        setupESPForTarget(target)
    end)
    
    for _, target in ipairs(Players:GetPlayers()) do
        if target ~= admin then
            target.CharacterAdded:Connect(function()
                if espEnabled[admin.UserId] then
                    task.wait(1)
                    if activeESP[admin.UserId] and activeESP[admin.UserId][target.UserId] then
                        if activeESP[admin.UserId][target.UserId].connection then
                            activeESP[admin.UserId][target.UserId].connection:Disconnect()
                        end
                        if activeESP[admin.UserId][target.UserId].components then
                            if activeESP[admin.UserId][target.UserId].components.folder then
                                activeESP[admin.UserId][target.UserId].components.folder:Destroy()
                            end
                            if activeESP[admin.UserId][target.UserId].components.drawingFrame then
                                activeESP[admin.UserId][target.UserId].components.drawingFrame:Destroy()
                            end
                        end
                    end
                    setupESPForTarget(target)
                end
            end)
        end
    end
end

-- ========================================
-- GUI CREATION
-- ========================================

local function createAdminGui(player)
    -- Initialize settings
    espSettings[player.UserId] = {
        boxEnabled = true,
        tracerEnabled = true,
        nameEnabled = true,
        healthEnabled = true,
        distanceEnabled = true,
        skeletonEnabled = true,
        headDotEnabled = true,
        tracerThickness = 1,
        boxThickness = 1,
        skeletonThickness = 1,
        tracerOrigin = "Bottom",
        offscreenArrows = true,
        arrowSize = 15,
        arrowDistance = 200
    }
    
    camTrackingSettings[player.UserId] = {
        smoothness = 0.1,
        lockPart = "Head",
        prediction = false,
        silentAim = false,
        silentAimFOV = 100,
        silentAimPart = "Head"
    }
    
    trackingMode[player.UserId] = "hold"
    toggleTrackingActive[player.UserId] = false
    
    -- Main ScreenGui
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "AdminPanel"
    screenGui.ResetOnSpawn = false
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.IgnoreGuiInset = true
    screenGui.Parent = player:WaitForChild("PlayerGui")
    
    -- Main Frame
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 500, 0, 380)
    mainFrame.Position = UDim2.new(0.5, -250, 0.5, -190)
    mainFrame.BackgroundColor3 = Colors.Background
    mainFrame.BorderSizePixel = 0
    mainFrame.Visible = true
    mainFrame.Active = true
    mainFrame.Draggable = true
    mainFrame.Parent = screenGui
    
    -- Silent Aim FOV Circle
    local fovCircle = Instance.new("Frame")
    fovCircle.Name = "SilentAimFOV"
    fovCircle.AnchorPoint = Vector2.new(0.5, 0.5)
    fovCircle.BackgroundTransparency = 1
    fovCircle.BorderSizePixel = 0
    fovCircle.Visible = false
    fovCircle.Parent = screenGui
    
    local fovCircleStroke = Instance.new("UIStroke")
    fovCircleStroke.Color = Colors.AccentBright
    fovCircleStroke.Thickness = 1
    fovCircleStroke.Transparency = 0.5
    fovCircleStroke.Parent = fovCircle
    
    local fovCircleCorner = Instance.new("UICorner")
    fovCircleCorner.CornerRadius = UDim.new(1, 0)
    fovCircleCorner.Parent = fovCircle
    
    -- Silent Aim target indicator
    local silentAimDot = Instance.new("Frame")
    silentAimDot.Name = "SilentAimTarget"
    silentAimDot.Size = UDim2.new(0, 8, 0, 8)
    silentAimDot.AnchorPoint = Vector2.new(0.5, 0.5)
    silentAimDot.BackgroundColor3 = Colors.ESP_Close
    silentAimDot.BorderSizePixel = 0
    silentAimDot.Visible = false
    silentAimDot.Parent = screenGui
    
    local silentDotCorner = Instance.new("UICorner")
    silentDotCorner.CornerRadius = UDim.new(1, 0)
    silentDotCorner.Parent = silentAimDot
    
    local silentDotStroke = Instance.new("UIStroke")
    silentDotStroke.Color = Color3.fromRGB(255, 255, 255)
    silentDotStroke.Thickness = 2
    silentDotStroke.Parent = silentAimDot
    
    -- Silent Aim Logic
    local silentAimTarget = nil
    
    local function getSilentAimTarget()
        local settings = camTrackingSettings[player.UserId]
        if not settings.silentAim then return nil end
        
        local camera = Workspace.CurrentCamera
        if not camera then return nil end
        
        local screenCenter = camera.ViewportSize / 2
        local fov = settings.silentAimFOV or 100
        local closestTarget = nil
        local closestDistance = fov
        
        for _, target in ipairs(Players:GetPlayers()) do
            if isValidTarget(player, target) and target.Character then
                local targetPart = target.Character:FindFirstChild(settings.lockPart) or target.Character:FindFirstChild("Head")
                if targetPart then
                    local screenPos, onScreen = worldToScreen(targetPart.Position)
                    if onScreen and screenPos then
                        local distFromCenter = (screenPos - screenCenter).Magnitude
                        if distFromCenter < closestDistance then
                            -- Check if visible (optional - can be toggled)
                            if hasLineOfSight(player, target) then
                                closestDistance = distFromCenter
                                closestTarget = target
                            end
                        end
                    end
                end
            end
        end
        
        return closestTarget
    end
    
    -- Update FOV circle and silent aim every frame
    RunService.RenderStepped:Connect(function()
        local settings = camTrackingSettings[player.UserId]
        local camera = Workspace.CurrentCamera
        
        if settings.silentAim and camera then
            local screenCenter = camera.ViewportSize / 2
            local fov = settings.silentAimFOV or 100
            
            -- Update FOV circle
            fovCircle.Size = UDim2.new(0, fov * 2, 0, fov * 2)
            fovCircle.Position = UDim2.new(0, screenCenter.X, 0, screenCenter.Y)
            fovCircle.Visible = true
            
            -- Get silent aim target
            silentAimTarget = getSilentAimTarget()
            
            if silentAimTarget and silentAimTarget.Character then
                local targetPart = silentAimTarget.Character:FindFirstChild(settings.lockPart) or silentAimTarget.Character:FindFirstChild("Head")
                if targetPart then
                    local screenPos, onScreen = worldToScreen(targetPart.Position)
                    if onScreen and screenPos then
                        silentAimDot.Position = UDim2.new(0, screenPos.X, 0, screenPos.Y)
                        silentAimDot.Visible = true
                    else
                        silentAimDot.Visible = false
                    end
                end
            else
                silentAimDot.Visible = false
            end
        else
            fovCircle.Visible = false
            silentAimDot.Visible = false
            silentAimTarget = nil
        end
    end)
    
    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = UDim.new(0, 6)
    mainCorner.Parent = mainFrame
    
    local mainStroke = Instance.new("UIStroke")
    mainStroke.Color = Colors.Accent
    mainStroke.Thickness = 1
    mainStroke.Parent = mainFrame
    
    -- Title Bar
    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, 0, 0, 30)
    titleBar.BackgroundColor3 = Colors.BackgroundLight
    titleBar.BorderSizePixel = 0
    titleBar.Parent = mainFrame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 6)
    titleCorner.Parent = titleBar
    
    local titleFix = Instance.new("Frame")
    titleFix.Size = UDim2.new(1, 0, 0, 6)
    titleFix.Position = UDim2.new(0, 0, 1, -6)
    titleFix.BackgroundColor3 = Colors.BackgroundLight
    titleFix.BorderSizePixel = 0
    titleFix.Parent = titleBar
    
    local titleText = Instance.new("TextLabel")
    titleText.Size = UDim2.new(1, -40, 1, 0)
    titleText.Position = UDim2.new(0, 12, 0, 0)
    titleText.BackgroundTransparency = 1
    titleText.Text = "⚡ Binxix's GUI | Clean ESP"
    titleText.TextColor3 = Colors.Text
    titleText.TextSize = 13
    titleText.Font = Enum.Font.GothamBold
    titleText.TextXAlignment = Enum.TextXAlignment.Left
    titleText.Parent = titleBar
    
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 26, 0, 26)
    closeBtn.Position = UDim2.new(1, -30, 0, 2)
    closeBtn.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
    closeBtn.BackgroundTransparency = 0.5
    closeBtn.Text = "×"
    closeBtn.TextColor3 = Colors.Text
    closeBtn.TextSize = 18
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.Parent = titleBar
    
    local closeBtnCorner = Instance.new("UICorner")
    closeBtnCorner.CornerRadius = UDim.new(0, 4)
    closeBtnCorner.Parent = closeBtn
    
    closeBtn.MouseButton1Click:Connect(function()
        mainFrame.Visible = false
    end)
    
    -- Tab Container
    local tabContainer = Instance.new("Frame")
    tabContainer.Size = UDim2.new(1, 0, 0, 26)
    tabContainer.Position = UDim2.new(0, 0, 0, 30)
    tabContainer.BackgroundTransparency = 1
    tabContainer.Parent = mainFrame
    
    local tabs = {"Tracking", "ESP", "Visuals", "Functions"}
    local tabButtons = {}
    local tabWidth = 1 / #tabs
    
    for i, tabName in ipairs(tabs) do
        local tabBtn = Instance.new("TextButton")
        tabBtn.Name = tabName .. "Tab"
        tabBtn.Size = UDim2.new(tabWidth, -2, 1, 0)
        tabBtn.Position = UDim2.new((i-1) * tabWidth, 1, 0, 0)
        tabBtn.BackgroundColor3 = i == 1 and Colors.Accent or Colors.BackgroundLight
        tabBtn.BackgroundTransparency = i == 1 and 0.5 or 0.7
        tabBtn.BorderSizePixel = 0
        tabBtn.Text = tabName
        tabBtn.TextColor3 = i == 1 and Colors.Text or Colors.TextDim
        tabBtn.TextSize = 11
        tabBtn.Font = Enum.Font.GothamMedium
        tabBtn.Parent = tabContainer
        tabButtons[tabName] = tabBtn
    end
    
    -- Content Area
    local contentArea = Instance.new("Frame")
    contentArea.Size = UDim2.new(1, -16, 1, -80)
    contentArea.Position = UDim2.new(0, 8, 0, 62)
    contentArea.BackgroundTransparency = 1
    contentArea.Parent = mainFrame
    
    -- Status Label
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Size = UDim2.new(1, -16, 0, 18)
    statusLabel.Position = UDim2.new(0, 8, 1, -22)
    statusLabel.BackgroundTransparency = 1
    statusLabel.Text = "✓ Ready | RCtrl toggle | RMB track"
    statusLabel.TextColor3 = Colors.TextDim
    statusLabel.TextSize = 10
    statusLabel.Font = Enum.Font.Gotham
    statusLabel.TextXAlignment = Enum.TextXAlignment.Left
    statusLabel.Parent = mainFrame
    
    -- Helper Functions
    local function createSection(parent, title, posX, posY, width, height)
        local section = Instance.new("Frame")
        section.Size = UDim2.new(0, width, 0, height)
        section.Position = UDim2.new(0, posX, 0, posY)
        section.BackgroundColor3 = Colors.BackgroundLight
        section.BackgroundTransparency = 0.5
        section.BorderSizePixel = 0
        section.Parent = parent
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 4)
        corner.Parent = section
        
        local stroke = Instance.new("UIStroke")
        stroke.Color = Colors.Border
        stroke.Thickness = 1
        stroke.Parent = section
        
        local titleLabel = Instance.new("TextLabel")
        titleLabel.Size = UDim2.new(0, #title * 7 + 12, 0, 14)
        titleLabel.Position = UDim2.new(0, 8, 0, -7)
        titleLabel.BackgroundColor3 = Colors.Background
        titleLabel.BorderSizePixel = 0
        titleLabel.Text = " " .. title .. " "
        titleLabel.TextColor3 = Colors.AccentBright
        titleLabel.TextSize = 10
        titleLabel.Font = Enum.Font.GothamBold
        titleLabel.Parent = section
        
        local titleCorner = Instance.new("UICorner")
        titleCorner.CornerRadius = UDim.new(0, 3)
        titleCorner.Parent = titleLabel
        
        return section
    end
    
    local function createCheckbox(parent, text, posX, posY, default, callback)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(0, 120, 0, 18)
        container.Position = UDim2.new(0, posX, 0, posY)
        container.BackgroundTransparency = 1
        container.Parent = parent
        
        local checkbox = Instance.new("Frame")
        checkbox.Size = UDim2.new(0, 14, 0, 14)
        checkbox.Position = UDim2.new(0, 0, 0, 2)
        checkbox.BackgroundColor3 = default and Colors.Accent or Colors.BackgroundLight
        checkbox.BorderSizePixel = 0
        checkbox.Parent = container
        
        local checkCorner = Instance.new("UICorner")
        checkCorner.CornerRadius = UDim.new(0, 3)
        checkCorner.Parent = checkbox
        
        local checkMark = Instance.new("TextLabel")
        checkMark.Size = UDim2.new(1, 0, 1, 0)
        checkMark.BackgroundTransparency = 1
        checkMark.Text = default and "✓" or ""
        checkMark.TextColor3 = Colors.Text
        checkMark.TextSize = 11
        checkMark.Font = Enum.Font.GothamBold
        checkMark.Parent = checkbox
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0, 100, 0, 18)
        label.Position = UDim2.new(0, 18, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = text
        label.TextColor3 = Colors.Text
        label.TextSize = 10
        label.Font = Enum.Font.Gotham
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = container
        
        local isEnabled = default
        
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(1, 0, 1, 0)
        btn.BackgroundTransparency = 1
        btn.Text = ""
        btn.Parent = container
        
        btn.MouseButton1Click:Connect(function()
            isEnabled = not isEnabled
            checkbox.BackgroundColor3 = isEnabled and Colors.Accent or Colors.BackgroundLight
            checkMark.Text = isEnabled and "✓" or ""
            if callback then callback(isEnabled) end
        end)
        
        return container, function() return isEnabled end, function(val)
            isEnabled = val
            checkbox.BackgroundColor3 = isEnabled and Colors.Accent or Colors.BackgroundLight
            checkMark.Text = isEnabled and "✓" or ""
        end
    end
    
    local function createSlider(parent, label, posX, posY, min, max, default, callback)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(0, 150, 0, 34)
        container.Position = UDim2.new(0, posX, 0, posY)
        container.BackgroundTransparency = 1
        container.Parent = parent
        
        local labelText = Instance.new("TextLabel")
        labelText.Size = UDim2.new(0.75, 0, 0, 14)
        labelText.BackgroundTransparency = 1
        labelText.Text = label
        labelText.TextColor3 = Colors.TextDim
        labelText.TextSize = 10
        labelText.Font = Enum.Font.Gotham
        labelText.TextXAlignment = Enum.TextXAlignment.Left
        labelText.Parent = container
        
        local valueLabel = Instance.new("TextLabel")
        valueLabel.Size = UDim2.new(0.25, 0, 0, 14)
        valueLabel.Position = UDim2.new(0.75, 0, 0, 0)
        valueLabel.BackgroundTransparency = 1
        valueLabel.Text = tostring(default)
        valueLabel.TextColor3 = Colors.AccentBright
        valueLabel.TextSize = 10
        valueLabel.Font = Enum.Font.GothamBold
        valueLabel.TextXAlignment = Enum.TextXAlignment.Right
        valueLabel.Parent = container
        
        local sliderBg = Instance.new("Frame")
        sliderBg.Size = UDim2.new(1, 0, 0, 6)
        sliderBg.Position = UDim2.new(0, 0, 0, 20)
        sliderBg.BackgroundColor3 = Colors.BackgroundLight
        sliderBg.BorderSizePixel = 0
        sliderBg.Parent = container
        
        local sliderCorner = Instance.new("UICorner")
        sliderCorner.CornerRadius = UDim.new(0, 3)
        sliderCorner.Parent = sliderBg
        
        local sliderFill = Instance.new("Frame")
        sliderFill.Size = UDim2.new((default - min) / (max - min), 0, 1, 0)
        sliderFill.BackgroundColor3 = Colors.Accent
        sliderFill.BorderSizePixel = 0
        sliderFill.Parent = sliderBg
        
        local fillCorner = Instance.new("UICorner")
        fillCorner.CornerRadius = UDim.new(0, 3)
        fillCorner.Parent = sliderFill
        
        local currentValue = default
        local dragging = false
        
        local sliderBtn = Instance.new("TextButton")
        sliderBtn.Size = UDim2.new(1, 0, 1, 12)
        sliderBtn.Position = UDim2.new(0, 0, 0, -6)
        sliderBtn.BackgroundTransparency = 1
        sliderBtn.Text = ""
        sliderBtn.Parent = sliderBg
        
        sliderBtn.MouseButton1Down:Connect(function()
            dragging = true
        end)
        
        UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
        
        RunService.RenderStepped:Connect(function()
            if dragging then
                local mouse = player:GetMouse()
                local relativeX = (mouse.X - sliderBg.AbsolutePosition.X) / sliderBg.AbsoluteSize.X
                relativeX = math.clamp(relativeX, 0, 1)
                currentValue = math.floor(min + relativeX * (max - min) + 0.5)
                if max <= 1 then
                    currentValue = min + relativeX * (max - min)
                    currentValue = math.floor(currentValue * 100) / 100
                end
                sliderFill.Size = UDim2.new(relativeX, 0, 1, 0)
                valueLabel.Text = tostring(currentValue)
                if callback then callback(currentValue) end
            end
        end)
        
        return container, function() return currentValue end
    end
    
    local function createDropdown(parent, label, posX, posY, options, default, callback)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(0, 130, 0, 38)
        container.Position = UDim2.new(0, posX, 0, posY)
        container.BackgroundTransparency = 1
        container.ZIndex = 5
        container.Parent = parent
        
        local labelText = Instance.new("TextLabel")
        labelText.Size = UDim2.new(1, 0, 0, 14)
        labelText.BackgroundTransparency = 1
        labelText.Text = label
        labelText.TextColor3 = Colors.TextDim
        labelText.TextSize = 10
        labelText.Font = Enum.Font.Gotham
        labelText.TextXAlignment = Enum.TextXAlignment.Left
        labelText.ZIndex = 5
        labelText.Parent = container
        
        local dropBtn = Instance.new("TextButton")
        dropBtn.Size = UDim2.new(1, 0, 0, 22)
        dropBtn.Position = UDim2.new(0, 0, 0, 16)
        dropBtn.BackgroundColor3 = Colors.BackgroundLight
        dropBtn.BorderSizePixel = 0
        dropBtn.Text = "  " .. default
        dropBtn.TextColor3 = Colors.Text
        dropBtn.TextSize = 10
        dropBtn.Font = Enum.Font.Gotham
        dropBtn.TextXAlignment = Enum.TextXAlignment.Left
        dropBtn.ZIndex = 5
        dropBtn.Parent = container
        
        local dropCorner = Instance.new("UICorner")
        dropCorner.CornerRadius = UDim.new(0, 3)
        dropCorner.Parent = dropBtn
        
        local dropStroke = Instance.new("UIStroke")
        dropStroke.Color = Colors.Border
        dropStroke.Thickness = 1
        dropStroke.Parent = dropBtn
        
        local arrow = Instance.new("TextLabel")
        arrow.Size = UDim2.new(0, 16, 1, 0)
        arrow.Position = UDim2.new(1, -18, 0, 0)
        arrow.BackgroundTransparency = 1
        arrow.Text = "▼"
        arrow.TextColor3 = Colors.Accent
        arrow.TextSize = 10
        arrow.Font = Enum.Font.GothamBold
        arrow.ZIndex = 5
        arrow.Parent = dropBtn
        
        local currentSelection = default
        local isOpen = false
        
        local optionsFrame = Instance.new("Frame")
        optionsFrame.Size = UDim2.new(1, 0, 0, #options * 22)
        optionsFrame.Position = UDim2.new(0, 0, 1, 2)
        optionsFrame.BackgroundColor3 = Colors.Background
        optionsFrame.BorderSizePixel = 0
        optionsFrame.Visible = false
        optionsFrame.ZIndex = 50
        optionsFrame.Parent = dropBtn
        
        local optCorner = Instance.new("UICorner")
        optCorner.CornerRadius = UDim.new(0, 3)
        optCorner.Parent = optionsFrame
        
        local optStroke = Instance.new("UIStroke")
        optStroke.Color = Colors.Accent
        optStroke.Thickness = 1
        optStroke.Parent = optionsFrame
        
        for i, opt in ipairs(options) do
            local optBtn = Instance.new("TextButton")
            optBtn.Size = UDim2.new(1, 0, 0, 22)
            optBtn.Position = UDim2.new(0, 0, 0, (i-1) * 22)
            optBtn.BackgroundColor3 = Colors.BackgroundLight
            optBtn.BackgroundTransparency = 0.5
            optBtn.Text = "  " .. opt
            optBtn.TextColor3 = Colors.Text
            optBtn.TextSize = 10
            optBtn.Font = Enum.Font.Gotham
            optBtn.TextXAlignment = Enum.TextXAlignment.Left
            optBtn.ZIndex = 51
            optBtn.Parent = optionsFrame
            
            optBtn.MouseEnter:Connect(function()
                optBtn.BackgroundTransparency = 0
                optBtn.BackgroundColor3 = Colors.Accent
            end)
            
            optBtn.MouseLeave:Connect(function()
                optBtn.BackgroundTransparency = 0.5
                optBtn.BackgroundColor3 = Colors.BackgroundLight
            end)
            
            optBtn.MouseButton1Click:Connect(function()
                currentSelection = opt
                dropBtn.Text = "  " .. opt
                isOpen = false
                optionsFrame.Visible = false
                arrow.Text = "▼"
                if callback then callback(opt) end
            end)
        end
        
        dropBtn.MouseButton1Click:Connect(function()
            isOpen = not isOpen
            optionsFrame.Visible = isOpen
            arrow.Text = isOpen and "▲" or "▼"
        end)
        
        return container, function() return currentSelection end
    end
    
    local function createButton(parent, text, posX, posY, width, callback)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0, width, 0, 24)
        btn.Position = UDim2.new(0, posX, 0, posY)
        btn.BackgroundColor3 = Colors.BackgroundLight
        btn.BorderSizePixel = 0
        btn.Text = text
        btn.TextColor3 = Colors.Text
        btn.TextSize = 10
        btn.Font = Enum.Font.GothamMedium
        btn.Parent = parent
        
        local btnCorner = Instance.new("UICorner")
        btnCorner.CornerRadius = UDim.new(0, 3)
        btnCorner.Parent = btn
        
        local btnStroke = Instance.new("UIStroke")
        btnStroke.Color = Colors.Accent
        btnStroke.Thickness = 1
        btnStroke.Parent = btn
        
        btn.MouseEnter:Connect(function()
            TweenService:Create(btn, TweenInfo.new(0.1), {BackgroundColor3 = Colors.Accent}):Play()
        end)
        
        btn.MouseLeave:Connect(function()
            TweenService:Create(btn, TweenInfo.new(0.1), {BackgroundColor3 = Colors.BackgroundLight}):Play()
        end)
        
        btn.MouseButton1Click:Connect(callback)
        
        return btn
    end
    
    local function createInput(parent, placeholder, posX, posY, width)
        local inputFrame = Instance.new("Frame")
        inputFrame.Size = UDim2.new(0, width, 0, 22)
        inputFrame.Position = UDim2.new(0, posX, 0, posY)
        inputFrame.BackgroundColor3 = Colors.BackgroundLight
        inputFrame.BorderSizePixel = 0
        inputFrame.Parent = parent
        
        local inputCorner = Instance.new("UICorner")
        inputCorner.CornerRadius = UDim.new(0, 3)
        inputCorner.Parent = inputFrame
        
        local inputStroke = Instance.new("UIStroke")
        inputStroke.Color = Colors.Border
        inputStroke.Thickness = 1
        inputStroke.Parent = inputFrame
        
        local textBox = Instance.new("TextBox")
        textBox.Size = UDim2.new(1, -10, 1, 0)
        textBox.Position = UDim2.new(0, 5, 0, 0)
        textBox.BackgroundTransparency = 1
        textBox.Text = ""
        textBox.PlaceholderText = placeholder
        textBox.TextColor3 = Colors.Text
        textBox.PlaceholderColor3 = Colors.TextDim
        textBox.TextSize = 10
        textBox.Font = Enum.Font.Gotham
        textBox.TextXAlignment = Enum.TextXAlignment.Left
        textBox.ClearTextOnFocus = false
        textBox.Parent = inputFrame
        
        return inputFrame, textBox
    end
    
    -- Create Tab Pages
    local tabPages = {}
    
    -- ===== TRACKING TAB =====
    local trackingPage = Instance.new("Frame")
    trackingPage.Name = "TrackingPage"
    trackingPage.Size = UDim2.new(1, 0, 1, 0)
    trackingPage.BackgroundTransparency = 1
    trackingPage.Visible = true
    trackingPage.Parent = contentArea
    tabPages["Tracking"] = trackingPage
    
    local valuesSection = createSection(trackingPage, "Settings", 0, 0, 230, 130)
    
    createCheckbox(valuesSection, "Enabled", 8, 16, false, nil)
    createCheckbox(valuesSection, "Toggle Mode", 8, 36, false, function(enabled)
        trackingMode[player.UserId] = enabled and "toggle" or "hold"
    end)
    
    createSlider(valuesSection, "Smoothness:", 8, 58, 0.05, 0.5, 0.1, function(val)
        camTrackingSettings[player.UserId].smoothness = val
    end)
    
    createCheckbox(valuesSection, "Prediction", 8, 96, false, function(enabled)
        camTrackingSettings[player.UserId].prediction = enabled
    end)
    
    -- Aimlock Section (moved from Visuals)
    local aimlockSection = createSection(trackingPage, "Aimlock", 245, 0, 230, 180)
    
    createDropdown(aimlockSection, "Lock Part", 8, 16, {"Head", "HumanoidRootPart", "UpperTorso", "Torso"}, "Head", function(val)
        camTrackingSettings[player.UserId].lockPart = val
    end)
    
    createSlider(aimlockSection, "Smoothness:", 8, 60, 0.05, 0.5, 0.1, function(val)
        camTrackingSettings[player.UserId].smoothness = val
    end)
    
    createCheckbox(aimlockSection, "Velocity Predict", 8, 98, false, function(enabled)
        camTrackingSettings[player.UserId].prediction = enabled
    end)
    
    -- Silent Aim
    createCheckbox(aimlockSection, "Silent Aim", 8, 118, false, function(enabled)
        camTrackingSettings[player.UserId].silentAim = enabled
        statusLabel.Text = enabled and "✓ Silent Aim ON" or "✓ Silent Aim OFF"
    end)
    
    createSlider(aimlockSection, "Silent FOV:", 8, 140, 50, 300, 100, function(val)
        camTrackingSettings[player.UserId].silentAimFOV = val
    end)
    
    -- Status labels (no box, just floating text)
    local targetNameLabel = Instance.new("TextLabel")
    targetNameLabel.Size = UDim2.new(0, 200, 0, 16)
    targetNameLabel.Position = UDim2.new(0, 8, 0, 150)
    targetNameLabel.BackgroundTransparency = 1
    targetNameLabel.Text = "Target: None"
    targetNameLabel.TextColor3 = Colors.AccentBright
    targetNameLabel.TextSize = 11
    targetNameLabel.Font = Enum.Font.GothamBold
    targetNameLabel.TextXAlignment = Enum.TextXAlignment.Left
    targetNameLabel.Parent = trackingPage
    
    local targetDistLabel = Instance.new("TextLabel")
    targetDistLabel.Size = UDim2.new(0, 200, 0, 14)
    targetDistLabel.Position = UDim2.new(0, 8, 0, 168)
    targetDistLabel.BackgroundTransparency = 1
    targetDistLabel.Text = "Distance: 0m | Status: --"
    targetDistLabel.TextColor3 = Colors.Text
    targetDistLabel.TextSize = 10
    targetDistLabel.Font = Enum.Font.Gotham
    targetDistLabel.TextXAlignment = Enum.TextXAlignment.Left
    targetDistLabel.Parent = trackingPage
    
    local targetHealthBg = Instance.new("Frame")
    targetHealthBg.Size = UDim2.new(0, 200, 0, 6)
    targetHealthBg.Position = UDim2.new(0, 8, 0, 186)
    targetHealthBg.BackgroundColor3 = Colors.BackgroundLight
    targetHealthBg.BorderSizePixel = 0
    targetHealthBg.Parent = trackingPage
    
    local targetHealthCorner = Instance.new("UICorner")
    targetHealthCorner.CornerRadius = UDim.new(0, 3)
    targetHealthCorner.Parent = targetHealthBg
    
    local targetHealthFill = Instance.new("Frame")
    targetHealthFill.Size = UDim2.new(1, 0, 1, 0)
    targetHealthFill.BackgroundColor3 = Colors.Health_High
    targetHealthFill.BorderSizePixel = 0
    targetHealthFill.Parent = targetHealthBg
    
    local targetHealthCorner2 = Instance.new("UICorner")
    targetHealthCorner2.CornerRadius = UDim.new(0, 3)
    targetHealthCorner2.Parent = targetHealthFill
    
    -- ===== ESP TAB =====
    local espPage = Instance.new("Frame")
    espPage.Name = "ESPPage"
    espPage.Size = UDim2.new(1, 0, 1, 0)
    espPage.BackgroundTransparency = 1
    espPage.Visible = false
    espPage.Parent = contentArea
    tabPages["ESP"] = espPage
    
    local espSection = createSection(espPage, "ESP Features", 0, 0, 230, 220)
    
    createCheckbox(espSection, "Enabled", 8, 16, false, function(enabled)
        if enabled then
            enableESP(player, screenGui)
            statusLabel.Text = "✓ ESP Enabled"
        else
            clearAllESP(player)
            statusLabel.Text = "✓ ESP Disabled"
        end
    end)
    
    createCheckbox(espSection, "Corner Box", 8, 36, true, function(enabled)
        espSettings[player.UserId].boxEnabled = enabled
    end)
    
    createCheckbox(espSection, "Skeleton", 8, 56, true, function(enabled)
        espSettings[player.UserId].skeletonEnabled = enabled
        if espEnabled[player.UserId] then
            clearAllESP(player)
            enableESP(player, screenGui)
        end
    end)
    
    createCheckbox(espSection, "Tracers", 8, 76, true, function(enabled)
        espSettings[player.UserId].tracerEnabled = enabled
    end)
    
    createCheckbox(espSection, "Names", 8, 96, true, function(enabled)
        espSettings[player.UserId].nameEnabled = enabled
    end)
    
    createCheckbox(espSection, "Health Bars", 8, 116, true, function(enabled)
        espSettings[player.UserId].healthEnabled = enabled
    end)
    
    createCheckbox(espSection, "Distance", 8, 136, true, function(enabled)
        espSettings[player.UserId].distanceEnabled = enabled
    end)
    
    createCheckbox(espSection, "Head Dot", 8, 156, true, function(enabled)
        espSettings[player.UserId].headDotEnabled = enabled
    end)
    
    createCheckbox(espSection, "Offscreen Arrows", 8, 176, true, function(enabled)
        espSettings[player.UserId].offscreenArrows = enabled
    end)
    
    local espAppearSection = createSection(espPage, "Appearance", 245, 0, 230, 200)
    
    createSlider(espAppearSection, "Tracer Width:", 8, 16, 1, 5, 1, function(val)
        espSettings[player.UserId].tracerThickness = val
    end)
    
    createSlider(espAppearSection, "Box Width:", 8, 54, 1, 5, 1, function(val)
        espSettings[player.UserId].boxThickness = val
    end)
    
    createSlider(espAppearSection, "Skeleton Width:", 8, 92, 1, 3, 1, function(val)
        espSettings[player.UserId].skeletonThickness = val
    end)
    
    createSlider(espAppearSection, "Arrow Size:", 8, 130, 10, 30, 15, function(val)
        espSettings[player.UserId].arrowSize = val
    end)
    
    createDropdown(espAppearSection, "Tracer Origin", 8, 164, {"Bottom", "Top", "Mouse"}, "Bottom", function(val)
        espSettings[player.UserId].tracerOrigin = val
    end)
    
    -- ===== VISUALS TAB =====
    local visualsPage = Instance.new("Frame")
    visualsPage.Name = "VisualsPage"
    visualsPage.Size = UDim2.new(1, 0, 1, 0)
    visualsPage.BackgroundTransparency = 1
    visualsPage.Visible = false
    visualsPage.Parent = contentArea
    tabPages["Visuals"] = visualsPage
    
    local fovSection = createSection(visualsPage, "Camera FOV", 0, 0, 230, 100)
    
    local fovEnabled = false
    local customFOV = 70
    local fovConnection = nil
    
    createCheckbox(fovSection, "Enabled", 8, 16, false, function(enabled)
        fovEnabled = enabled
        local camera = Workspace.CurrentCamera
        if camera then
            if enabled then
                if fovConnection then fovConnection:Disconnect() end
                fovConnection = RunService.RenderStepped:Connect(function()
                    if fovEnabled and camera then
                        camera.FieldOfView = customFOV
                    end
                end)
                statusLabel.Text = "✓ FOV: " .. customFOV
            else
                if fovConnection then 
                    fovConnection:Disconnect()
                    fovConnection = nil
                end
                camera.FieldOfView = 70
                statusLabel.Text = "✓ FOV reset"
            end
        end
    end)
    
    createSlider(fovSection, "FOV Amount:", 8, 40, 30, 120, 70, function(val)
        customFOV = val
        if fovEnabled then
            local camera = Workspace.CurrentCamera
            if camera then camera.FieldOfView = val end
        end
    end)
    
    local thirdPersonSection = createSection(visualsPage, "Third Person", 245, 0, 230, 70)
    
    createCheckbox(thirdPersonSection, "Enable", 8, 16, false, nil)
    createSlider(thirdPersonSection, "Distance:", 8, 38, 5, 30, 12, nil)
    
    -- ===== FUNCTIONS TAB =====
    local functionsPage = Instance.new("Frame")
    functionsPage.Name = "FunctionsPage"
    functionsPage.Size = UDim2.new(1, 0, 1, 0)
    functionsPage.BackgroundTransparency = 1
    functionsPage.Visible = false
    functionsPage.Parent = contentArea
    tabPages["Functions"] = functionsPage
    
    local charSection = createSection(functionsPage, "Character", 0, 0, 230, 140)
    
    createCheckbox(charSection, "Speed Boost", 8, 16, false, function(enabled)
        local char = player.Character
        if char then
            local humanoid = char:FindFirstChild("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = enabled and 100 or 16
                statusLabel.Text = enabled and "✓ Speed Boost ON" or "✓ Speed Boost OFF"
            end
        end
    end)
    
    createCheckbox(charSection, "High Jump", 8, 36, false, function(enabled)
        local char = player.Character
        if char then
            local humanoid = char:FindFirstChild("Humanoid")
            if humanoid then
                humanoid.JumpPower = enabled and 150 or 50
                statusLabel.Text = enabled and "✓ High Jump ON" or "✓ High Jump OFF"
            end
        end
    end)
    
    createSlider(charSection, "Walk Speed:", 8, 60, 16, 200, 16, function(val)
        local char = player.Character
        if char then
            local humanoid = char:FindFirstChild("Humanoid")
            if humanoid then 
                humanoid.WalkSpeed = val 
                statusLabel.Text = "Walk Speed: " .. val
            end
        end
    end)
    
    createSlider(charSection, "Jump Power:", 8, 98, 50, 300, 50, function(val)
        local char = player.Character
        if char then
            local humanoid = char:FindFirstChild("Humanoid")
            if humanoid then 
                humanoid.JumpPower = val 
                statusLabel.Text = "Jump Power: " .. val
            end
        end
    end)
    
    -- Keep settings on respawn
    player.CharacterAdded:Connect(function(char)
        task.wait(0.5)
        local humanoid = char:FindFirstChild("Humanoid")
        if humanoid then
            -- Reapply current slider values would need stored values
            -- For now just reset to defaults
        end
    end)
    
    -- Tab switching
    for tabName, tabBtn in pairs(tabButtons) do
        tabBtn.MouseButton1Click:Connect(function()
            for name, btn in pairs(tabButtons) do
                btn.BackgroundColor3 = name == tabName and Colors.Accent or Colors.BackgroundLight
                btn.BackgroundTransparency = name == tabName and 0.5 or 0.7
                btn.TextColor3 = name == tabName and Colors.Text or Colors.TextDim
            end
            
            for name, page in pairs(tabPages) do
                page.Visible = name == tabName
            end
        end)
    end
    
    -- RMB Tracking
    local function startRMBTracking()
        stopRightMouseTracking(player)
        
        local nearestPlayer, dist = getNearestValidTarget(player)
        if not nearestPlayer then
            statusLabel.Text = "⚠ No visible targets"
            return
        end
        
        statusLabel.Text = "🎯 RMB: " .. nearestPlayer.Name
        targetNameLabel.Text = "Target: " .. nearestPlayer.Name .. " (RMB)"
        
        local camera = Workspace.CurrentCamera
        local settings = camTrackingSettings[player.UserId]
        
        local connection = RunService.RenderStepped:Connect(function()
            local currentNearest, d = getNearestValidTarget(player)
            if not currentNearest then return end
            
            local targetChar = currentNearest.Character
            if not targetChar then return end
            
            local targetPart = targetChar:FindFirstChild(settings.lockPart) or targetChar:FindFirstChild("Head")
            local targetHumanoid = targetChar:FindFirstChild("Humanoid")
            
            if targetPart and camera then
                local targetPos = targetPart.Position
                
                if settings.prediction then
                    local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
                    if targetHRP then
                        targetPos = targetPos + targetHRP.AssemblyLinearVelocity * 0.1
                    end
                end
                
                local lookAtCFrame = CFrame.new(camera.CFrame.Position, targetPos)
                camera.CFrame = camera.CFrame:Lerp(lookAtCFrame, settings.smoothness * 2)
                
                targetDistLabel.Text = string.format("Distance: %dm | LOCKED", math.floor(d))
                
                if targetHumanoid then
                    local healthPercent = targetHumanoid.Health / targetHumanoid.MaxHealth
                    targetHealthFill.Size = UDim2.new(healthPercent, 0, 1, 0)
                    targetHealthFill.BackgroundColor3 = getHealthColor(healthPercent)
                end
            end
        end)
        
        rightMouseTracking[player.UserId] = { connection = connection }
    end
    
    local function stopRMBTrackingUI()
        stopRightMouseTracking(player)
        if not activeTracking[player.UserId] then
            targetNameLabel.Text = "Target: None"
            statusLabel.Text = "✓ Ready | RCtrl toggle | RMB track"
        end
    end
    
    -- Input
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        
        if input.KeyCode == Enum.KeyCode.RightControl then
            mainFrame.Visible = not mainFrame.Visible
        end
        
        if input.UserInputType == Enum.UserInputType.MouseButton2 then
            if trackingMode[player.UserId] == "hold" then
                startRMBTracking()
            else
                if toggleTrackingActive[player.UserId] then
                    toggleTrackingActive[player.UserId] = false
                    stopRMBTrackingUI()
                else
                    toggleTrackingActive[player.UserId] = true
                    startRMBTracking()
                end
            end
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton2 then
            if trackingMode[player.UserId] == "hold" then
                stopRMBTrackingUI()
            end
        end
    end)
    
    -- Loaded Notification (bottom middle)
    local loadedNotif = Instance.new("TextLabel")
    loadedNotif.Name = "LoadedNotification"
    loadedNotif.Size = UDim2.new(0, 200, 0, 30)
    loadedNotif.Position = UDim2.new(0.5, -100, 1, -40)
    loadedNotif.BackgroundColor3 = Colors.Background
    loadedNotif.BackgroundTransparency = 0.3
    loadedNotif.BorderSizePixel = 0
    loadedNotif.Text = "✓ Binxix's GUI loaded"
    loadedNotif.TextColor3 = Colors.AccentBright
    loadedNotif.TextSize = 12
    loadedNotif.Font = Enum.Font.GothamBold
    loadedNotif.Parent = screenGui
    
    local notifCorner = Instance.new("UICorner")
    notifCorner.CornerRadius = UDim.new(0, 6)
    notifCorner.Parent = loadedNotif
    
    local notifStroke = Instance.new("UIStroke")
    notifStroke.Color = Colors.Accent
    notifStroke.Thickness = 1
    notifStroke.Parent = loadedNotif
    
    -- Fade out notification after 3 seconds
    task.spawn(function()
        task.wait(3)
        for i = 0, 1, 0.05 do
            loadedNotif.BackgroundTransparency = 0.3 + (i * 0.7)
            loadedNotif.TextTransparency = i
            notifStroke.Transparency = i
            task.wait(0.02)
        end
        loadedNotif:Destroy()
    end)
end

-- Initialize for all players
Players.PlayerAdded:Connect(function(player)
    createAdminGui(player)
end)

for _, player in ipairs(Players:GetPlayers()) do
    createAdminGui(player)
end
