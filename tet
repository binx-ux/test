-- ServerScriptService

-- Services
local Players = game:GetService("Players")
local ServerStorage = game:GetService("ServerStorage")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local Debris = game:GetService("Debris")
local SoundService = game:GetService("SoundService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local MarketplaceService = game:GetService("MarketplaceService")
local TeleportService = game:GetService("TeleportService")
local BadgeService = game:GetService("BadgeService")
local DataStoreService = game:GetService("DataStoreService")
local PhysicsService = game:GetService("PhysicsService")
local PathfindingService = game:GetService("PathfindingService")
local Chat = game:GetService("Chat")
local Teams = game:GetService("Teams")
local StarterGui = game:GetService("StarterGui")
local StarterPack = game:GetService("StarterPack")
local StarterPlayer = game:GetService("StarterPlayer")
local ContextActionService = game:GetService("ContextActionService")
local CoreGui = game:GetService("CoreGui")

local adminIds = {
    9766385891, -- Your admin
}

local activeTracking = {}
local activeESP = {}
local espEnabled = {}
local rightMouseTracking = {}
local espSettings = {}
local trackingMode = {} -- "hold" or "toggle"
local toggleTrackingActive = {}

local function isAdmin(player)
    for _, id in ipairs(adminIds) do
        if player.UserId == id then
            return true
        end
    end
    return false
end

local function isSameTeam(player1, player2)
    if not player1.Team or not player2.Team then
        return false
    end
    return player1.Team == player2.Team
end

local function isValidTarget(admin, target)
    if target == admin then
        return false
    end
    
    if isAdmin(target) then
        return false
    end
    
    if isSameTeam(admin, target) then
        return false
    end
    
    return true
end

local function hasLineOfSight(admin, target)
    local adminChar = admin.Character
    local targetChar = target.Character
    
    if not adminChar or not targetChar then
        return false
    end
    
    local adminHead = adminChar:FindFirstChild("Head")
    local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
    
    if not adminHead or not targetHRP then
        return false
    end
    
    local origin = adminHead.Position
    local destination = targetHRP.Position
    local direction = (destination - origin)
    local distance = direction.Magnitude
    
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    raycastParams.FilterDescendantsInstances = {adminChar, targetChar}
    raycastParams.IgnoreWater = true
    
    local raycastResult = Workspace:Raycast(origin, direction.Unit * distance, raycastParams)
    
    if raycastResult then
        return false
    end
    
    return true
end

local function findPlayer(name)
    name = name:lower()
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Name:lower():sub(1, #name) == name then
            return player
        end
    end
    return nil
end

local function getNearestValidTarget(admin)
    local adminChar = admin.Character
    if not adminChar then return nil end
    
    local adminHRP = adminChar:FindFirstChild("HumanoidRootPart")
    if not adminHRP then return nil end
    
    local nearestPlayer = nil
    local nearestDistance = math.huge
    
    for _, player in ipairs(Players:GetPlayers()) do
        if isValidTarget(admin, player) then
            local char = player.Character
            if char then
                local hrp = char:FindFirstChild("HumanoidRootPart")
                if hrp then
                    local distance = (adminHRP.Position - hrp.Position).Magnitude
                    
                    if distance < nearestDistance and hasLineOfSight(admin, player) then
                        nearestDistance = distance
                        nearestPlayer = player
                    end
                end
            end
        end
    end
    
    return nearestPlayer, nearestDistance
end

local function stopTracking(admin)
    if activeTracking[admin.UserId] then
        if activeTracking[admin.UserId].connection then
            activeTracking[admin.UserId].connection:Disconnect()
        end
        activeTracking[admin.UserId] = nil
        return true
    end
    return false
end

local function stopRightMouseTracking(admin)
    if rightMouseTracking[admin.UserId] then
        if rightMouseTracking[admin.UserId].connection then
            rightMouseTracking[admin.UserId].connection:Disconnect()
        end
        rightMouseTracking[admin.UserId] = nil
        
        local camera = Workspace.CurrentCamera
        if camera then
            camera.CameraType = Enum.CameraType.Custom
        end
        return true
    end
    return false
end

local function createBoxESP(target, admin)
    if not target.Character then return nil end
    
    if not isValidTarget(admin, target) then
        return nil
    end
    
    -- Clean up existing
    local existingFolder = target.Character:FindFirstChild("AdminESP_" .. admin.UserId)
    if existingFolder then
        existingFolder:Destroy()
    end
    
    local espFolder = Instance.new("Folder")
    espFolder.Name = "AdminESP_" .. admin.UserId
    espFolder.Parent = target.Character
    
    local settings = espSettings[admin.UserId] or {
        boxEnabled = true,
        tracerEnabled = true,
        nameEnabled = true,
        healthEnabled = true,
        distanceEnabled = true,
        skeletonEnabled = false
    }
    
    -- Billboard GUI for info
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Name = "InfoBoard"
    billboardGui.Adornee = target.Character:FindFirstChild("Head")
    billboardGui.Size = UDim2.new(0, 200, 0, 80)
    billboardGui.StudsOffset = Vector3.new(0, 2.5, 0)
    billboardGui.AlwaysOnTop = true
    billboardGui.Parent = espFolder
    
    local infoFrame = Instance.new("Frame")
    infoFrame.Size = UDim2.new(1, 0, 1, 0)
    infoFrame.BackgroundTransparency = 1
    infoFrame.Parent = billboardGui
    
    -- Name Label
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "NameLabel"
    nameLabel.Size = UDim2.new(1, 0, 0, 18)
    nameLabel.Position = UDim2.new(0, 0, 0, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = target.Name
    nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    nameLabel.TextStrokeTransparency = 0
    nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    nameLabel.TextSize = 14
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.Visible = settings.nameEnabled
    nameLabel.Parent = infoFrame
    
    -- Health Bar Background
    local healthBarBg = Instance.new("Frame")
    healthBarBg.Name = "HealthBarBg"
    healthBarBg.Size = UDim2.new(0.8, 0, 0, 6)
    healthBarBg.Position = UDim2.new(0.1, 0, 0, 20)
    healthBarBg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    healthBarBg.BorderSizePixel = 0
    healthBarBg.Visible = settings.healthEnabled
    healthBarBg.Parent = infoFrame
    
    local healthBarBgCorner = Instance.new("UICorner")
    healthBarBgCorner.CornerRadius = UDim.new(0, 3)
    healthBarBgCorner.Parent = healthBarBg
    
    -- Health Bar Fill
    local healthBarFill = Instance.new("Frame")
    healthBarFill.Name = "HealthBarFill"
    healthBarFill.Size = UDim2.new(1, 0, 1, 0)
    healthBarFill.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
    healthBarFill.BorderSizePixel = 0
    healthBarFill.Parent = healthBarBg
    
    local healthBarFillCorner = Instance.new("UICorner")
    healthBarFillCorner.CornerRadius = UDim.new(0, 3)
    healthBarFillCorner.Parent = healthBarFill
    
    -- Distance Label
    local distanceLabel = Instance.new("TextLabel")
    distanceLabel.Name = "DistanceLabel"
    distanceLabel.Size = UDim2.new(1, 0, 0, 16)
    distanceLabel.Position = UDim2.new(0, 0, 0, 28)
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.Text = "0m"
    distanceLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
    distanceLabel.TextStrokeTransparency = 0
    distanceLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    distanceLabel.TextSize = 12
    distanceLabel.Font = Enum.Font.Gotham
    distanceLabel.Visible = settings.distanceEnabled
    distanceLabel.Parent = infoFrame
    
    -- Visibility Label
    local visibilityLabel = Instance.new("TextLabel")
    visibilityLabel.Name = "VisibilityLabel"
    visibilityLabel.Size = UDim2.new(1, 0, 0, 14)
    visibilityLabel.Position = UDim2.new(0, 0, 0, 44)
    visibilityLabel.BackgroundTransparency = 1
    visibilityLabel.Text = "VISIBLE"
    visibilityLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
    visibilityLabel.TextStrokeTransparency = 0
    visibilityLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    visibilityLabel.TextSize = 10
    visibilityLabel.Font = Enum.Font.GothamBold
    visibilityLabel.Parent = infoFrame
    
    -- Box Highlight
    local highlight = Instance.new("Highlight")
    highlight.Name = "BoxHighlight"
    highlight.Adornee = target.Character
    highlight.FillColor = Color3.fromRGB(255, 0, 0)
    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    highlight.FillTransparency = 0.7
    highlight.OutlineTransparency = 0
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Enabled = settings.boxEnabled
    highlight.Parent = espFolder
    
    -- Selection Box (3D Box)
    local selectionBox = Instance.new("SelectionBox")
    selectionBox.Name = "SelectionBox"
    selectionBox.Adornee = target.Character
    selectionBox.Color3 = Color3.fromRGB(255, 0, 0)
    selectionBox.LineThickness = 0.05
    selectionBox.SurfaceColor3 = Color3.fromRGB(255, 0, 0)
    selectionBox.SurfaceTransparency = 0.9
    selectionBox.Visible = settings.boxEnabled
    selectionBox.Parent = espFolder
    
    -- Tracer Line
    local tracerPart = Instance.new("Part")
    tracerPart.Name = "TracerAnchor"
    tracerPart.Anchored = true
    tracerPart.CanCollide = false
    tracerPart.Transparency = 1
    tracerPart.Size = Vector3.new(0.1, 0.1, 0.1)
    tracerPart.Parent = espFolder
    
    local beam = Instance.new("Beam")
    beam.Name = "Tracer"
    beam.Color = ColorSequence.new(Color3.fromRGB(255, 0, 0))
    beam.Transparency = NumberSequence.new(0.3)
    beam.Width0 = 0.1
    beam.Width1 = 0.1
    beam.FaceCamera = true
    beam.Enabled = settings.tracerEnabled
    beam.Parent = espFolder
    
    local attachment0 = Instance.new("Attachment")
    attachment0.Name = "TracerStart"
    attachment0.Parent = tracerPart
    
    local attachment1 = Instance.new("Attachment")
    attachment1.Name = "TracerEnd"
    attachment1.Parent = tracerPart
    
    beam.Attachment0 = attachment0
    beam.Attachment1 = attachment1
    
    return {
        folder = espFolder,
        highlight = highlight,
        selectionBox = selectionBox,
        billboard = billboardGui,
        nameLabel = nameLabel,
        healthBarBg = healthBarBg,
        healthBarFill = healthBarFill,
        distanceLabel = distanceLabel,
        visibilityLabel = visibilityLabel,
        beam = beam,
        tracerPart = tracerPart,
        attachment0 = attachment0,
        attachment1 = attachment1
    }
end

local function updateBoxESP(admin, target, espComponents)
    if not admin.Character or not target.Character then return false end
    
    if not isValidTarget(admin, target) then
        if espComponents.folder then
            espComponents.folder:Destroy()
        end
        return false
    end
    
    local adminHRP = admin.Character:FindFirstChild("HumanoidRootPart")
    local targetHRP = target.Character:FindFirstChild("HumanoidRootPart")
    local targetHumanoid = target.Character:FindFirstChild("Humanoid")
    
    if not adminHRP or not targetHRP then return true end
    
    local distance = (adminHRP.Position - targetHRP.Position).Magnitude
    local canSee = hasLineOfSight(admin, target)
    
    -- Update distance
    if espComponents.distanceLabel then
        espComponents.distanceLabel.Text = string.format("%.0fm", distance)
    end
    
    -- Update health bar
    if targetHumanoid and espComponents.healthBarFill then
        local healthPercent = targetHumanoid.Health / targetHumanoid.MaxHealth
        espComponents.healthBarFill.Size = UDim2.new(healthPercent, 0, 1, 0)
        
        -- Color based on health
        if healthPercent > 0.6 then
            espComponents.healthBarFill.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
        elseif healthPercent > 0.3 then
            espComponents.healthBarFill.BackgroundColor3 = Color3.fromRGB(255, 255, 0)
        else
            espComponents.healthBarFill.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        end
    end
    
    -- Update visibility
    if espComponents.visibilityLabel then
        if canSee then
            espComponents.visibilityLabel.Text = "â—‰ VISIBLE"
            espComponents.visibilityLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
        else
            espComponents.visibilityLabel.Text = "â—Ž COVERED"
            espComponents.visibilityLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        end
    end
    
    -- Update colors based on distance
    local espColor
    if distance < 50 then
        espColor = Color3.fromRGB(255, 0, 0) -- Red = Close
    elseif distance < 100 then
        espColor = Color3.fromRGB(255, 165, 0) -- Orange = Medium
    elseif distance < 200 then
        espColor = Color3.fromRGB(255, 255, 0) -- Yellow = Far
    else
        espColor = Color3.fromRGB(0, 255, 0) -- Green = Very far
    end
    
    if espComponents.highlight then
        espComponents.highlight.FillColor = espColor
        espComponents.highlight.OutlineColor = canSee and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(150, 150, 150)
        espComponents.highlight.FillTransparency = canSee and 0.7 or 0.9
    end
    
    if espComponents.selectionBox then
        espComponents.selectionBox.Color3 = espColor
        espComponents.selectionBox.SurfaceColor3 = espColor
    end
    
    -- Update tracer
    if espComponents.beam and espComponents.tracerPart then
        local camera = Workspace.CurrentCamera
        if camera then
            espComponents.tracerPart.Position = camera.CFrame.Position
            espComponents.attachment0.WorldPosition = camera.CFrame.Position + Vector3.new(0, -2, 0)
            espComponents.attachment1.WorldPosition = targetHRP.Position
            espComponents.beam.Color = ColorSequence.new(espColor)
        end
    end
    
    return true
end

local function clearAllESP(admin)
    if activeESP[admin.UserId] then
        for _, data in pairs(activeESP[admin.UserId]) do
            if data.connection then
                data.connection:Disconnect()
            end
            if data.components and data.components.folder then
                data.components.folder:Destroy()
            end
        end
        activeESP[admin.UserId] = nil
    end
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Character then
            local folder = player.Character:FindFirstChild("AdminESP_" .. admin.UserId)
            if folder then
                folder:Destroy()
            end
        end
    end
    
    espEnabled[admin.UserId] = false
end

local function enableESP(admin)
    clearAllESP(admin)
    
    activeESP[admin.UserId] = {}
    espEnabled[admin.UserId] = true
    
    for _, target in ipairs(Players:GetPlayers()) do
        if isValidTarget(admin, target) then
            local components = createBoxESP(target, admin)
            if components then
                local connection = RunService.Heartbeat:Connect(function()
                    if not espEnabled[admin.UserId] then
                        return
                    end
                    local stillValid = updateBoxESP(admin, target, components)
                    if not stillValid then
                        if activeESP[admin.UserId] and activeESP[admin.UserId][target.UserId] then
                            activeESP[admin.UserId][target.UserId].connection:Disconnect()
                            activeESP[admin.UserId][target.UserId] = nil
                        end
                    end
                end)
                
                activeESP[admin.UserId][target.UserId] = {
                    components = components,
                    connection = connection
                }
            end
        end
    end
    
    local playerAddedConn
    playerAddedConn = Players.PlayerAdded:Connect(function(target)
        if not espEnabled[admin.UserId] then
            playerAddedConn:Disconnect()
            return
        end
        
        target.CharacterAdded:Wait()
        task.wait(1)
        
        if espEnabled[admin.UserId] and isValidTarget(admin, target) then
            local components = createBoxESP(target, admin)
            if components then
                local connection = RunService.Heartbeat:Connect(function()
                    if not espEnabled[admin.UserId] then
                        return
                    end
                    updateBoxESP(admin, target, components)
                end)
                
                if not activeESP[admin.UserId] then
                    activeESP[admin.UserId] = {}
                end
                
                activeESP[admin.UserId][target.UserId] = {
                    components = components,
                    connection = connection
                }
            end
        end
    end)
    
    for _, target in ipairs(Players:GetPlayers()) do
        if target ~= admin then
            target.CharacterAdded:Connect(function()
                if espEnabled[admin.UserId] and isValidTarget(admin, target) then
                    task.wait(1)
                    
                    if activeESP[admin.UserId] and activeESP[admin.UserId][target.UserId] then
                        if activeESP[admin.UserId][target.UserId].connection then
                            activeESP[admin.UserId][target.UserId].connection:Disconnect()
                        end
                        if activeESP[admin.UserId][target.UserId].components and activeESP[admin.UserId][target.UserId].components.folder then
                            activeESP[admin.UserId][target.UserId].components.folder:Destroy()
                        end
                    end
                    
                    local components = createBoxESP(target, admin)
                    if components then
                        local connection = RunService.Heartbeat:Connect(function()
                            if not espEnabled[admin.UserId] then
                                return
                            end
                            updateBoxESP(admin, target, components)
                        end)
                        
                        if not activeESP[admin.UserId] then
                            activeESP[admin.UserId] = {}
                        end
                        
                        activeESP[admin.UserId][target.UserId] = {
                            components = components,
                            connection = connection
                        }
                    end
                end
            end)
            
            target:GetPropertyChangedSignal("Team"):Connect(function()
                if espEnabled[admin.UserId] then
                    if not isValidTarget(admin, target) then
                        if activeESP[admin.UserId] and activeESP[admin.UserId][target.UserId] then
                            if activeESP[admin.UserId][target.UserId].connection then
                                activeESP[admin.UserId][target.UserId].connection:Disconnect()
                            end
                            if activeESP[admin.UserId][target.UserId].components and activeESP[admin.UserId][target.UserId].components.folder then
                                activeESP[admin.UserId][target.UserId].components.folder:Destroy()
                            end
                            activeESP[admin.UserId][target.UserId] = nil
                        end
                    else
                        if (not activeESP[admin.UserId] or not activeESP[admin.UserId][target.UserId]) and target.Character then
                            local components = createBoxESP(target, admin)
                            if components then
                                local connection = RunService.Heartbeat:Connect(function()
                                    if not espEnabled[admin.UserId] then
                                        return
                                    end
                                    updateBoxESP(admin, target, components)
                                end)
                                
                                if not activeESP[admin.UserId] then
                                    activeESP[admin.UserId] = {}
                                end
                                
                                activeESP[admin.UserId][target.UserId] = {
                                    components = components,
                                    connection = connection
                                }
                            end
                        end
                    end
                end
            end)
        end
    end
end

local function createAdminGui(player)
    -- Initialize settings
    espSettings[player.UserId] = {
        boxEnabled = true,
        tracerEnabled = true,
        nameEnabled = true,
        healthEnabled = true,
        distanceEnabled = true
    }
    trackingMode[player.UserId] = "hold" -- Default to hold
    toggleTrackingActive[player.UserId] = false
    
    -- Main ScreenGui
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "AdminPanel"
    screenGui.ResetOnSpawn = false
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.Parent = player:WaitForChild("PlayerGui")
    
    -- Main Frame
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 380, 0, 650)
    mainFrame.Position = UDim2.new(0.5, -190, 0.5, -325)
    mainFrame.BackgroundColor3 = Color3.fromRGB(18, 18, 22)
    mainFrame.BorderSizePixel = 0
    mainFrame.Visible = false
    mainFrame.Active = true
    mainFrame.Draggable = true
    mainFrame.Parent = screenGui
    
    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = UDim.new(0, 8)
    mainCorner.Parent = mainFrame
    
    local mainStroke = Instance.new("UIStroke")
    mainStroke.Color = Color3.fromRGB(60, 60, 70)
    mainStroke.Thickness = 1
    mainStroke.Parent = mainFrame
    
    -- Header
    local header = Instance.new("Frame")
    header.Name = "Header"
    header.Size = UDim2.new(1, 0, 0, 50)
    header.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    header.BorderSizePixel = 0
    header.Parent = mainFrame
    
    local headerCorner = Instance.new("UICorner")
    headerCorner.CornerRadius = UDim.new(0, 8)
    headerCorner.Parent = header
    
    local headerFix = Instance.new("Frame")
    headerFix.Size = UDim2.new(1, 0, 0.5, 0)
    headerFix.Position = UDim2.new(0, 0, 0.5, 0)
    headerFix.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    headerFix.BorderSizePixel = 0
    headerFix.Parent = header
    
    -- Logo/Icon
    local logoFrame = Instance.new("Frame")
    logoFrame.Size = UDim2.new(0, 36, 0, 36)
    logoFrame.Position = UDim2.new(0, 10, 0.5, -18)
    logoFrame.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
    logoFrame.Parent = header
    
    local logoCorner = Instance.new("UICorner")
    logoCorner.CornerRadius = UDim.new(0, 8)
    logoCorner.Parent = logoFrame
    
    local logoText = Instance.new("TextLabel")
    logoText.Size = UDim2.new(1, 0, 1, 0)
    logoText.BackgroundTransparency = 1
    logoText.Text = "A"
    logoText.TextColor3 = Color3.fromRGB(255, 255, 255)
    logoText.TextSize = 20
    logoText.Font = Enum.Font.GothamBold
    logoText.Parent = logoFrame
    
    -- Title
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(0, 200, 0, 20)
    titleLabel.Position = UDim2.new(0, 55, 0, 8)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = "ADMIN CONTROL PANEL"
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.TextSize = 14
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = header
    
    local subtitleLabel = Instance.new("TextLabel")
    subtitleLabel.Size = UDim2.new(0, 200, 0, 14)
    subtitleLabel.Position = UDim2.new(0, 55, 0, 28)
    subtitleLabel.BackgroundTransparency = 1
    subtitleLabel.Text = "Press Right Ctrl to toggle"
    subtitleLabel.TextColor3 = Color3.fromRGB(120, 120, 130)
    subtitleLabel.TextSize = 11
    subtitleLabel.Font = Enum.Font.Gotham
    subtitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    subtitleLabel.Parent = header
    
    -- Close Button
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 30, 0, 30)
    closeBtn.Position = UDim2.new(1, -40, 0.5, -15)
    closeBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    closeBtn.Text = "âœ•"
    closeBtn.TextColor3 = Color3.fromRGB(180, 180, 180)
    closeBtn.TextSize = 14
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.Parent = header
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 6)
    closeCorner.Parent = closeBtn
    
    -- Status Bar
    local statusBar = Instance.new("Frame")
    statusBar.Name = "StatusBar"
    statusBar.Size = UDim2.new(1, -20, 0, 35)
    statusBar.Position = UDim2.new(0, 10, 0, 58)
    statusBar.BackgroundColor3 = Color3.fromRGB(30, 35, 45)
    statusBar.BorderSizePixel = 0
    statusBar.Parent = mainFrame
    
    local statusCorner = Instance.new("UICorner")
    statusCorner.CornerRadius = UDim.new(0, 6)
    statusCorner.Parent = statusBar
    
    local statusDot = Instance.new("Frame")
    statusDot.Size = UDim2.new(0, 8, 0, 8)
    statusDot.Position = UDim2.new(0, 12, 0.5, -4)
    statusDot.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
    statusDot.Parent = statusBar
    
    local statusDotCorner = Instance.new("UICorner")
    statusDotCorner.CornerRadius = UDim.new(1, 0)
    statusDotCorner.Parent = statusDot
    
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Name = "StatusText"
    statusLabel.Size = UDim2.new(1, -30, 1, 0)
    statusLabel.Position = UDim2.new(0, 28, 0, 0)
    statusLabel.BackgroundTransparency = 1
    statusLabel.Text = "System Ready â€¢ RMB to track nearest enemy"
    statusLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
    statusLabel.TextSize = 11
    statusLabel.Font = Enum.Font.Gotham
    statusLabel.TextXAlignment = Enum.TextXAlignment.Left
    statusLabel.Parent = statusBar
    
    -- Content Container
    local contentFrame = Instance.new("ScrollingFrame")
    contentFrame.Name = "Content"
    contentFrame.Size = UDim2.new(1, -20, 1, -105)
    contentFrame.Position = UDim2.new(0, 10, 0, 100)
    contentFrame.BackgroundTransparency = 1
    contentFrame.ScrollBarThickness = 3
    contentFrame.ScrollBarImageColor3 = Color3.fromRGB(88, 101, 242)
    contentFrame.CanvasSize = UDim2.new(0, 0, 0, 850)
    contentFrame.Parent = mainFrame
    
    -- Section Creator Function
    local function createSection(name, posY)
        local section = Instance.new("Frame")
        section.Name = name .. "Section"
        section.Size = UDim2.new(1, 0, 0, 25)
        section.Position = UDim2.new(0, 0, 0, posY)
        section.BackgroundTransparency = 1
        section.Parent = contentFrame
        
        local sectionLine = Instance.new("Frame")
        sectionLine.Size = UDim2.new(0, 3, 1, -6)
        sectionLine.Position = UDim2.new(0, 0, 0, 3)
        sectionLine.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
        sectionLine.BorderSizePixel = 0
        sectionLine.Parent = section
        
        local sectionCorner = Instance.new("UICorner")
        sectionCorner.CornerRadius = UDim.new(0, 2)
        sectionCorner.Parent = sectionLine
        
        local sectionLabel = Instance.new("TextLabel")
        sectionLabel.Size = UDim2.new(1, -15, 1, 0)
        sectionLabel.Position = UDim2.new(0, 12, 0, 0)
        sectionLabel.BackgroundTransparency = 1
        sectionLabel.Text = name
        sectionLabel.TextColor3 = Color3.fromRGB(150, 150, 160)
        sectionLabel.TextSize = 11
        sectionLabel.Font = Enum.Font.GothamBold
        sectionLabel.TextXAlignment = Enum.TextXAlignment.Left
        sectionLabel.Parent = section
        
        return section
    end
    
    -- Button Creator Function
    local function createButton(name, text, icon, color, posY, callback)
        local btn = Instance.new("TextButton")
        btn.Name = name
        btn.Size = UDim2.new(1, 0, 0, 42)
        btn.Position = UDim2.new(0, 0, 0, posY)
        btn.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
        btn.BorderSizePixel = 0
        btn.Text = ""
        btn.AutoButtonColor = false
        btn.Parent = contentFrame
        
        local btnCorner = Instance.new("UICorner")
        btnCorner.CornerRadius = UDim.new(0, 6)
        btnCorner.Parent = btn
        
        local btnStroke = Instance.new("UIStroke")
        btnStroke.Color = Color3.fromRGB(45, 45, 50)
        btnStroke.Thickness = 1
        btnStroke.Parent = btn
        
        local iconFrame = Instance.new("Frame")
        iconFrame.Size = UDim2.new(0, 28, 0, 28)
        iconFrame.Position = UDim2.new(0, 8, 0.5, -14)
        iconFrame.BackgroundColor3 = color
        iconFrame.Parent = btn
        
        local iconCorner = Instance.new("UICorner")
        iconCorner.CornerRadius = UDim.new(0, 6)
        iconCorner.Parent = iconFrame
        
        local iconLabel = Instance.new("TextLabel")
        iconLabel.Size = UDim2.new(1, 0, 1, 0)
        iconLabel.BackgroundTransparency = 1
        iconLabel.Text = icon
        iconLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        iconLabel.TextSize = 14
        iconLabel.Font = Enum.Font.GothamBold
        iconLabel.Parent = iconFrame
        
        local btnLabel = Instance.new("TextLabel")
        btnLabel.Name = "Label"
        btnLabel.Size = UDim2.new(1, -50, 1, 0)
        btnLabel.Position = UDim2.new(0, 45, 0, 0)
        btnLabel.BackgroundTransparency = 1
        btnLabel.Text = text
        btnLabel.TextColor3 = Color3.fromRGB(220, 220, 220)
        btnLabel.TextSize = 13
        btnLabel.Font = Enum.Font.GothamMedium
        btnLabel.TextXAlignment = Enum.TextXAlignment.Left
        btnLabel.Parent = btn
        
        -- Hover effects
        btn.MouseEnter:Connect(function()
            TweenService:Create(btn, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(40, 40, 48)}):Play()
            TweenService:Create(btnStroke, TweenInfo.new(0.15), {Color = color}):Play()
        end)
        
        btn.MouseLeave:Connect(function()
            TweenService:Create(btn, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(30, 30, 35)}):Play()
            TweenService:Create(btnStroke, TweenInfo.new(0.15), {Color = Color3.fromRGB(45, 45, 50)}):Play()
        end)
        
        btn.MouseButton1Click:Connect(callback)
        
        return btn, btnLabel, iconFrame
    end
    
    -- Toggle Creator Function
    local function createToggle(name, text, posY, default, callback)
        local toggle = Instance.new("Frame")
        toggle.Name = name
        toggle.Size = UDim2.new(1, 0, 0, 38)
        toggle.Position = UDim2.new(0, 0, 0, posY)
        toggle.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
        toggle.BorderSizePixel = 0
        toggle.Parent = contentFrame
        
        local toggleCorner = Instance.new("UICorner")
        toggleCorner.CornerRadius = UDim.new(0, 6)
        toggleCorner.Parent = toggle
        
        local toggleLabel = Instance.new("TextLabel")
        toggleLabel.Size = UDim2.new(1, -70, 1, 0)
        toggleLabel.Position = UDim2.new(0, 12, 0, 0)
        toggleLabel.BackgroundTransparency = 1
        toggleLabel.Text = text
        toggleLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
        toggleLabel.TextSize = 12
        toggleLabel.Font = Enum.Font.Gotham
        toggleLabel.TextXAlignment = Enum.TextXAlignment.Left
        toggleLabel.Parent = toggle
        
        local toggleBg = Instance.new("Frame")
        toggleBg.Name = "ToggleBg"
        toggleBg.Size = UDim2.new(0, 44, 0, 22)
        toggleBg.Position = UDim2.new(1, -54, 0.5, -11)
        toggleBg.BackgroundColor3 = default and Color3.fromRGB(88, 101, 242) or Color3.fromRGB(50, 50, 55)
        toggleBg.BorderSizePixel = 0
        toggleBg.Parent = toggle
        
        local toggleBgCorner = Instance.new("UICorner")
        toggleBgCorner.CornerRadius = UDim.new(1, 0)
        toggleBgCorner.Parent = toggleBg
        
        local toggleCircle = Instance.new("Frame")
        toggleCircle.Name = "Circle"
        toggleCircle.Size = UDim2.new(0, 18, 0, 18)
        toggleCircle.Position = default and UDim2.new(1, -20, 0.5, -9) or UDim2.new(0, 2, 0.5, -9)
        toggleCircle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        toggleCircle.BorderSizePixel = 0
        toggleCircle.Parent = toggleBg
        
        local toggleCircleCorner = Instance.new("UICorner")
        toggleCircleCorner.CornerRadius = UDim.new(1, 0)
        toggleCircleCorner.Parent = toggleCircle
        
        local isEnabled = default
        
        local toggleBtn = Instance.new("TextButton")
        toggleBtn.Size = UDim2.new(1, 0, 1, 0)
        toggleBtn.BackgroundTransparency = 1
        toggleBtn.Text = ""
        toggleBtn.Parent = toggle
        
        toggleBtn.MouseButton1Click:Connect(function()
            isEnabled = not isEnabled
            
            if isEnabled then
                TweenService:Create(toggleBg, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(88, 101, 242)}):Play()
                TweenService:Create(toggleCircle, TweenInfo.new(0.2), {Position = UDim2.new(1, -20, 0.5, -9)}):Play()
            else
                TweenService:Create(toggleBg, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(50, 50, 55)}):Play()
                TweenService:Create(toggleCircle, TweenInfo.new(0.2), {Position = UDim2.new(0, 2, 0.5, -9)}):Play()
            end
            
            callback(isEnabled)
        end)
        
        return toggle, function() return isEnabled end, function(value)
            isEnabled = value
            if isEnabled then
                toggleBg.BackgroundColor3 = Color3.fromRGB(88, 101, 242)
                toggleCircle.Position = UDim2.new(1, -20, 0.5, -9)
            else
                toggleBg.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
                toggleCircle.Position = UDim2.new(0, 2, 0.5, -9)
            end
        end
    end
    
    -- Dropdown Creator Function
    local function createDropdown(name, text, options, posY, default, callback)
        local dropdown = Instance.new("Frame")
        dropdown.Name = name
        dropdown.Size = UDim2.new(1, 0, 0, 38)
        dropdown.Position = UDim2.new(0, 0, 0, posY)
        dropdown.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
        dropdown.BorderSizePixel = 0
        dropdown.ClipsDescendants = true
        dropdown.Parent = contentFrame
        
        local dropdownCorner = Instance.new("UICorner")
        dropdownCorner.CornerRadius = UDim.new(0, 6)
        dropdownCorner.Parent = dropdown
        
        local dropdownLabel = Instance.new("TextLabel")
        dropdownLabel.Size = UDim2.new(0.5, 0, 0, 38)
        dropdownLabel.Position = UDim2.new(0, 12, 0, 0)
        dropdownLabel.BackgroundTransparency = 1
        dropdownLabel.Text = text
        dropdownLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
        dropdownLabel.TextSize = 12
        dropdownLabel.Font = Enum.Font.Gotham
        dropdownLabel.TextXAlignment = Enum.TextXAlignment.Left
        dropdownLabel.Parent = dropdown
        
        local selectedLabel = Instance.new("TextLabel")
        selectedLabel.Name = "Selected"
        selectedLabel.Size = UDim2.new(0.4, 0, 0, 38)
        selectedLabel.Position = UDim2.new(0.55, 0, 0, 0)
        selectedLabel.BackgroundTransparency = 1
        selectedLabel.Text = default
        selectedLabel.TextColor3 = Color3.fromRGB(88, 101, 242)
        selectedLabel.TextSize = 12
        selectedLabel.Font = Enum.Font.GothamBold
        selectedLabel.TextXAlignment = Enum.TextXAlignment.Right
        selectedLabel.Parent = dropdown
        
        local dropdownArrow = Instance.new("TextLabel")
        dropdownArrow.Size = UDim2.new(0, 20, 0, 38)
        dropdownArrow.Position = UDim2.new(1, -25, 0, 0)
        dropdownArrow.BackgroundTransparency = 1
        dropdownArrow.Text = "â–¼"
        dropdownArrow.TextColor3 = Color3.fromRGB(120, 120, 130)
        dropdownArrow.TextSize = 10
        dropdownArrow.Font = Enum.Font.Gotham
        dropdownArrow.Parent = dropdown
        
        local isOpen = false
        local currentSelection = default
        
        local optionsFrame = Instance.new("Frame")
        optionsFrame.Name = "Options"
        optionsFrame.Size = UDim2.new(1, -10, 0, #options * 32)
        optionsFrame.Position = UDim2.new(0, 5, 0, 42)
        optionsFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
        optionsFrame.BorderSizePixel = 0
        optionsFrame.Visible = false
        optionsFrame.Parent = dropdown
        
        local optionsCorner = Instance.new("UICorner")
        optionsCorner.CornerRadius = UDim.new(0, 4)
        optionsCorner.Parent = optionsFrame
        
        for i, option in ipairs(options) do
            local optionBtn = Instance.new("TextButton")
            optionBtn.Size = UDim2.new(1, 0, 0, 32)
            optionBtn.Position = UDim2.new(0, 0, 0, (i - 1) * 32)
            optionBtn.BackgroundTransparency = 1
            optionBtn.Text = option
            optionBtn.TextColor3 = Color3.fromRGB(180, 180, 180)
            optionBtn.TextSize = 12
            optionBtn.Font = Enum.Font.Gotham
            optionBtn.Parent = optionsFrame
            
            optionBtn.MouseEnter:Connect(function()
                optionBtn.TextColor3 = Color3.fromRGB(88, 101, 242)
            end)
            
            optionBtn.MouseLeave:Connect(function()
                optionBtn.TextColor3 = Color3.fromRGB(180, 180, 180)
            end)
            
            optionBtn.MouseButton1Click:Connect(function()
                currentSelection = option
                selectedLabel.Text = option
                isOpen = false
                optionsFrame.Visible = false
                dropdown.Size = UDim2.new(1, 0, 0, 38)
                dropdownArrow.Text = "â–¼"
                callback(option)
            end)
        end
        
        local dropdownBtn = Instance.new("TextButton")
        dropdownBtn.Size = UDim2.new(1, 0, 0, 38)
        dropdownBtn.BackgroundTransparency = 1
        dropdownBtn.Text = ""
        dropdownBtn.Parent = dropdown
        
        dropdownBtn.MouseButton1Click:Connect(function()
            isOpen = not isOpen
            optionsFrame.Visible = isOpen
            
            if isOpen then
                dropdown.Size = UDim2.new(1, 0, 0, 42 + #options * 32)
                dropdownArrow.Text = "â–²"
            else
                dropdown.Size = UDim2.new(1, 0, 0, 38)
                dropdownArrow.Text = "â–¼"
            end
        end)
        
        return dropdown, function() return currentSelection end
    end
    
    -- Input Field Creator
    local function createInput(name, placeholder, posY)
        local input = Instance.new("Frame")
        input.Name = name
        input.Size = UDim2.new(1, 0, 0, 42)
        input.Position = UDim2.new(0, 0, 0, posY)
        input.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
        input.BorderSizePixel = 0
        input.Parent = contentFrame
        
        local inputCorner = Instance.new("UICorner")
        inputCorner.CornerRadius = UDim.new(0, 6)
        inputCorner.Parent = input
        
        local inputStroke = Instance.new("UIStroke")
        inputStroke.Color = Color3.fromRGB(45, 45, 50)
        inputStroke.Thickness = 1
        inputStroke.Parent = input
        
        local searchIcon = Instance.new("TextLabel")
        searchIcon.Size = UDim2.new(0, 30, 1, 0)
        searchIcon.Position = UDim2.new(0, 8, 0, 0)
        searchIcon.BackgroundTransparency = 1
        searchIcon.Text = "ðŸ”"
        searchIcon.TextColor3 = Color3.fromRGB(100, 100, 110)
        searchIcon.TextSize = 14
        searchIcon.Font = Enum.Font.Gotham
        searchIcon.Parent = input
        
        local textBox = Instance.new("TextBox")
        textBox.Name = "TextBox"
        textBox.Size = UDim2.new(1, -50, 1, 0)
        textBox.Position = UDim2.new(0, 40, 0, 0)
        textBox.BackgroundTransparency = 1
        textBox.Text = ""
        textBox.PlaceholderText = placeholder
        textBox.TextColor3 = Color3.fromRGB(220, 220, 220)
        textBox.PlaceholderColor3 = Color3.fromRGB(100, 100, 110)
        textBox.TextSize = 13
        textBox.Font = Enum.Font.Gotham
        textBox.TextXAlignment = Enum.TextXAlignment.Left
        textBox.ClearTextOnFocus = false
        textBox.Parent = input
        
        textBox.Focused:Connect(function()
            TweenService:Create(inputStroke, TweenInfo.new(0.15), {Color = Color3.fromRGB(88, 101, 242)}):Play()
        end)
        
        textBox.FocusLost:Connect(function()
            TweenService:Create(inputStroke, TweenInfo.new(0.15), {Color = Color3.fromRGB(45, 45, 50)}):Play()
        end)
        
        return input, textBox
    end
    
    -- Live Tracking Panel
    local trackingPanel = Instance.new("Frame")
    trackingPanel.Name = "TrackingPanel"
    trackingPanel.Size = UDim2.new(1, 0, 0, 100)
    trackingPanel.Position = UDim2.new(0, 0, 0, 0)
    trackingPanel.BackgroundColor3 = Color3.fromRGB(25, 30, 40)
    trackingPanel.BorderSizePixel = 0
    trackingPanel.Visible = false
    trackingPanel.Parent = contentFrame
    
    local trackingCorner = Instance.new("UICorner")
    trackingCorner.CornerRadius = UDim.new(0, 6)
    trackingCorner.Parent = trackingPanel
    
    local trackingStroke = Instance.new("UIStroke")
    trackingStroke.Color = Color3.fromRGB(88, 101, 242)
    trackingStroke.Thickness = 1
    trackingStroke.Parent = trackingPanel
    
    local trackingTitle = Instance.new("TextLabel")
    trackingTitle.Size = UDim2.new(1, 0, 0, 25)
    trackingTitle.Position = UDim2.new(0, 12, 0, 5)
    trackingTitle.BackgroundTransparency = 1
    trackingTitle.Text = "â—‰ LIVE TRACKING"
    trackingTitle.TextColor3 = Color3.fromRGB(88, 101, 242)
    trackingTitle.TextSize = 12
    trackingTitle.Font = Enum.Font.GothamBold
    trackingTitle.TextXAlignment = Enum.TextXAlignment.Left
    trackingTitle.Parent = trackingPanel
    
    local trackingTarget = Instance.new("TextLabel")
    trackingTarget.Name = "Target"
    trackingTarget.Size = UDim2.new(1, -24, 0, 18)
    trackingTarget.Position = UDim2.new(0, 12, 0, 28)
    trackingTarget.BackgroundTransparency = 1
    trackingTarget.Text = "Target: None"
    trackingTarget.TextColor3 = Color3.fromRGB(200, 200, 200)
    trackingTarget.TextSize = 11
    trackingTarget.Font = Enum.Font.Gotham
    trackingTarget.TextXAlignment = Enum.TextXAlignment.Left
    trackingTarget.Parent = trackingPanel
    
    local trackingCoords = Instance.new("TextLabel")
    trackingCoords.Name = "Coords"
    trackingCoords.Size = UDim2.new(1, -24, 0, 18)
    trackingCoords.Position = UDim2.new(0, 12, 0, 46)
    trackingCoords.BackgroundTransparency = 1
    trackingCoords.Text = "Position: X: 0 | Y: 0 | Z: 0"
    trackingCoords.TextColor3 = Color3.fromRGB(255, 200, 100)
    trackingCoords.TextSize = 11
    trackingCoords.Font = Enum.Font.Gotham
    trackingCoords.TextXAlignment = Enum.TextXAlignment.Left
    trackingCoords.Parent = trackingPanel
    
    local trackingDist = Instance.new("TextLabel")
    trackingDist.Name = "Distance"
    trackingDist.Size = UDim2.new(0.5, -12, 0, 18)
    trackingDist.Position = UDim2.new(0, 12, 0, 64)
    trackingDist.BackgroundTransparency = 1
    trackingDist.Text = "Distance: 0m"
    trackingDist.TextColor3 = Color3.fromRGB(100, 200, 255)
    trackingDist.TextSize = 11
    trackingDist.Font = Enum.Font.Gotham
    trackingDist.TextXAlignment = Enum.TextXAlignment.Left
    trackingDist.Parent = trackingPanel
    
    local trackingStatus = Instance.new("TextLabel")
    trackingStatus.Name = "Status"
    trackingStatus.Size = UDim2.new(0.5, -12, 0, 18)
    trackingStatus.Position = UDim2.new(0.5, 0, 0, 64)
    trackingStatus.BackgroundTransparency = 1
    trackingStatus.Text = "â—‰ VISIBLE"
    trackingStatus.TextColor3 = Color3.fromRGB(0, 255, 100)
    trackingStatus.TextSize = 11
    trackingStatus.Font = Enum.Font.GothamBold
    trackingStatus.TextXAlignment = Enum.TextXAlignment.Left
    trackingStatus.Parent = trackingPanel
    
    local trackingHealth = Instance.new("Frame")
    trackingHealth.Name = "HealthBar"
    trackingHealth.Size = UDim2.new(1, -24, 0, 6)
    trackingHealth.Position = UDim2.new(0, 12, 0, 86)
    trackingHealth.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    trackingHealth.BorderSizePixel = 0
    trackingHealth.Parent = trackingPanel
    
    local trackingHealthCorner = Instance.new("UICorner")
    trackingHealthCorner.CornerRadius = UDim.new(0, 3)
    trackingHealthCorner.Parent = trackingHealth
    
    local trackingHealthFill = Instance.new("Frame")
    trackingHealthFill.Name = "Fill"
    trackingHealthFill.Size = UDim2.new(1, 0, 1, 0)
    trackingHealthFill.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
    trackingHealthFill.BorderSizePixel = 0
    trackingHealthFill.Parent = trackingHealth
    
    local trackingHealthFillCorner = Instance.new("UICorner")
    trackingHealthFillCorner.CornerRadius = UDim.new(0, 3)
    trackingHealthFillCorner.Parent = trackingHealthFill
    
    -- Create UI Elements
    local currentY = 0
    
    -- Target Input Section
    createSection("TARGET", currentY)
    currentY = currentY + 30
    
    local _, playerInput = createInput("PlayerInput", "Enter player name...", currentY)
    currentY = currentY + 52
    
    -- Tracking Section
    createSection("TRACKING", currentY)
    currentY = currentY + 30
    
    local _, getTrackingMode = createDropdown("TrackingMode", "RMB Mode", {"Hold to Track", "Click to Toggle"}, currentY, "Hold to Track", function(option)
        if option == "Hold to Track" then
            trackingMode[player.UserId] = "hold"
        else
            trackingMode[player.UserId] = "toggle"
        end
        
        local modeText = trackingMode[player.UserId] == "hold" and "Hold RMB" or "Click RMB"
        statusLabel.Text = "Tracking mode: " .. modeText
    end)
    currentY = currentY + 48
    
    local trackBtn, trackLabel = createButton("Track", "Track Player (Camera)", "ðŸŽ¯", Color3.fromRGB(138, 43, 226), currentY, function()
        local targetName = playerInput.Text
        if targetName == "" then
            statusLabel.Text = "âš  Enter a player name first"
            statusDot.BackgroundColor3 = Color3.fromRGB(255, 180, 0)
            return
        end
        
        stopTracking(player)
        
        local target = findPlayer(targetName)
        if not target then
            statusLabel.Text = "âœ• Player not found"
            statusDot.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
            return
        end
        
        if target == player then
            statusLabel.Text = "âš  Cannot track yourself"
            statusDot.BackgroundColor3 = Color3.fromRGB(255, 180, 0)
            return
        end
        
        if isAdmin(target) then
            statusLabel.Text = "âš  Cannot track admins"
            statusDot.BackgroundColor3 = Color3.fromRGB(255, 180, 0)
            return
        end
        
        if isSameTeam(player, target) then
            statusLabel.Text = "âš  Cannot track teammates"
            statusDot.BackgroundColor3 = Color3.fromRGB(255, 180, 0)
            return
        end
        
        statusLabel.Text = "â—‰ Tracking " .. target.Name
        statusDot.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
        trackingPanel.Visible = true
        trackingPanel.Position = UDim2.new(0, 0, 0, 0)
        trackingTarget.Text = "Target: " .. target.Name
        
        -- Shift content down
        for _, child in ipairs(contentFrame:GetChildren()) do
            if child ~= trackingPanel and child:IsA("GuiObject") then
                child.Position = child.Position + UDim2.new(0, 0, 0, 110)
            end
        end
        contentFrame.CanvasSize = UDim2.new(0, 0, 0, 960)
        
        local camera = Workspace.CurrentCamera
        
        local connection = RunService.RenderStepped:Connect(function()
            local adminChar = player.Character
            local targetChar = target.Character
            
            if not adminChar or not targetChar then return end
            
            local adminHRP = adminChar:FindFirstChild("HumanoidRootPart")
            local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
            local targetHumanoid = targetChar:FindFirstChild("Humanoid")
            
            if adminHRP and targetHRP and camera then
                local targetPos = targetHRP.Position
                local adminPos = adminHRP.Position
                local distance = (adminPos - targetPos).Magnitude
                local canSee = hasLineOfSight(player, target)
                
                if canSee then
                    local lookAtCFrame = CFrame.new(camera.CFrame.Position, targetPos)
                    camera.CFrame = camera.CFrame:Lerp(lookAtCFrame, 0.1)
                    trackingStatus.Text = "â—‰ VISIBLE"
                    trackingStatus.TextColor3 = Color3.fromRGB(0, 255, 100)
                else
                    trackingStatus.Text = "â—Ž COVERED"
                    trackingStatus.TextColor3 = Color3.fromRGB(255, 100, 100)
                end
                
                trackingCoords.Text = string.format("Position: X: %.0f | Y: %.0f | Z: %.0f", targetPos.X, targetPos.Y, targetPos.Z)
                trackingDist.Text = string.format("Distance: %.0fm", distance)
                
                if targetHumanoid then
                    local healthPercent = targetHumanoid.Health / targetHumanoid.MaxHealth
                    trackingHealthFill.Size = UDim2.new(healthPercent, 0, 1, 0)
                    
                    if healthPercent > 0.6 then
                        trackingHealthFill.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
                    elseif healthPercent > 0.3 then
                        trackingHealthFill.BackgroundColor3 = Color3.fromRGB(255, 200, 0)
                    else
                        trackingHealthFill.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
                    end
                end
            end
        end)
        
        activeTracking[player.UserId] = {
            connection = connection,
            target = target
        }
        
        target.AncestryChanged:Connect(function()
            if not target:IsDescendantOf(Players) then
                stopTracking(player)
                trackingPanel.Visible = false
                for _, child in ipairs(contentFrame:GetChildren()) do
                    if child ~= trackingPanel and child:IsA("GuiObject") then
                        child.Position = child.Position - UDim2.new(0, 0, 0, 110)
                    end
                end
                contentFrame.CanvasSize = UDim2.new(0, 0, 0, 850)
                statusLabel.Text = "âš  " .. target.Name .. " left the game"
                statusDot.BackgroundColor3 = Color3.fromRGB(255, 180, 0)
            end
        end)
    end)
    currentY = currentY + 52
    
    local stopTrackBtn = createButton("StopTrack", "Stop Tracking", "ðŸ›‘", Color3.fromRGB(220, 60, 60), currentY, function()
        if stopTracking(player) then
            trackingPanel.Visible = false
            for _, child in ipairs(contentFrame:GetChildren()) do
                if child ~= trackingPanel and child:IsA("GuiObject") then
                    child.Position = child.Position - UDim2.new(0, 0, 0, 110)
                end
            end
            contentFrame.CanvasSize = UDim2.new(0, 0, 0, 850)
            statusLabel.Text = "â—‰ Tracking stopped"
            statusDot.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
        else
            statusLabel.Text = "âš  Not tracking anyone"
            statusDot.BackgroundColor3 = Color3.fromRGB(255, 180, 0)
        end
    end)
    currentY = currentY + 52
    
    -- ESP Section
    createSection("ESP SETTINGS", currentY)
    currentY = currentY + 30
    
    local espBtn, espLabel, espIcon = createButton("ESP", "Toggle ESP (Enemies Only)", "ðŸ‘", Color3.fromRGB(0, 180, 255), currentY, function()
        if espEnabled[player.UserId] then
            clearAllESP(player)
            espLabel.Text = "Toggle ESP (Enemies Only)"
            statusLabel.Text = "â—‰ ESP disabled"
            statusDot.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
        else
            enableESP(player)
            espLabel.Text = "ESP Active (Click to disable)"
            statusLabel.Text = "â—‰ ESP enabled"
            statusDot.BackgroundColor3 = Color3.fromRGB(0, 180, 255)
        end
    end)
    currentY = currentY + 52
    
    createToggle("BoxESP", "Box Highlight", currentY, true, function(enabled)
        espSettings[player.UserId].boxEnabled = enabled
        if espEnabled[player.UserId] then
            clearAllESP(player)
            enableESP(player)
        end
    end)
    currentY = currentY + 44
    
    createToggle("TracerESP", "Tracer Lines", currentY, true, function(enabled)
        espSettings[player.UserId].tracerEnabled = enabled
        if espEnabled[player.UserId] then
            clearAllESP(player)
            enableESP(player)
        end
    end)
    currentY = currentY + 44
    
    createToggle("NameESP", "Player Names", currentY, true, function(enabled)
        espSettings[player.UserId].nameEnabled = enabled
        if espEnabled[player.UserId] then
            clearAllESP(player)
            enableESP(player)
        end
    end)
    currentY = currentY + 44
    
    createToggle("HealthESP", "Health Bars", currentY, true, function(enabled)
        espSettings[player.UserId].healthEnabled = enabled
        if espEnabled[player.UserId] then
            clearAllESP(player)
            enableESP(player)
        end
    end)
    currentY = currentY + 44
    
    createToggle("DistanceESP", "Distance Display", currentY, true, function(enabled)
        espSettings[player.UserId].distanceEnabled = enabled
        if espEnabled[player.UserId] then
            clearAllESP(player)
            enableESP(player)
        end
    end)
    currentY = currentY + 52
    
    -- Player Actions Section
    createSection("PLAYER ACTIONS", currentY)
    currentY = currentY + 30
    
    createButton("Teleport", "Teleport to Player", "âš¡", Color3.fromRGB(80, 200, 120), currentY, function()
        local targetName = playerInput.Text
        if targetName == "" then
            statusLabel.Text = "âš  Enter a player name first"
            statusDot.BackgroundColor3 = Color3.fromRGB(255, 180, 0)
            return
        end
        
        local target = findPlayer(targetName)
        if not target then
            statusLabel.Text = "âœ• Player not found"
            statusDot.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
            return
        end
        
        local adminChar = player.Character
        local targetChar = target.Character
        
        if adminChar and targetChar then
            local adminHRP = adminChar:FindFirstChild("HumanoidRootPart")
            local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
            
            if adminHRP and targetHRP then
                adminHRP.CFrame = targetHRP.CFrame * CFrame.new(0, 0, 3)
                statusLabel.Text = "â—‰ Teleported to " .. target.Name
                statusDot.BackgroundColor3 = Color3.fromRGB(80, 200, 120)
            end
        end
    end)
    currentY = currentY + 52
    
    createButton("Bring", "Bring Player to You", "ðŸ“¥", Color3.fromRGB(255, 100, 150), currentY, function()
        local targetName = playerInput.Text
        if targetName == "" then
            statusLabel.Text = "âš  Enter a player name first"
            statusDot.BackgroundColor3 = Color3.fromRGB(255, 180, 0)
            return
        end
        
        local target = findPlayer(targetName)
        if not target then
            statusLabel.Text = "âœ• Player not found"
            statusDot.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
            return
        end
        
        local adminChar = player.Character
        local targetChar = target.Character
        
        if adminChar and targetChar then
            local adminHRP = adminChar:FindFirstChild("HumanoidRootPart")
            local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
            
            if adminHRP and targetHRP then
                targetHRP.CFrame = adminHRP.CFrame * CFrame.new(0, 0, 3)
                statusLabel.Text = "â—‰ Brought " .. target.Name
                statusDot.BackgroundColor3 = Color3.fromRGB(255, 100, 150)
            end
        end
    end)
    currentY = currentY + 52
    
    createButton("Locate", "Locate All Enemies", "ðŸ“", Color3.fromRGB(255, 180, 50), currentY, function()
        local count = 0
        local output = "Enemies: "
        
        for _, p in ipairs(Players:GetPlayers()) do
            if isValidTarget(player, p) then
                local char = p.Character
                if char then
                    local hrp = char:FindFirstChild("HumanoidRootPart")
                    if hrp then
                        count = count + 1
                        local canSee = hasLineOfSight(player, p)
                        local icon = canSee and "â—‰" or "â—Ž"
                        print(string.format("[LOCATE] %s %s: X:%.0f Y:%.0f Z:%.0f", icon, p.Name, hrp.Position.X, hrp.Position.Y, hrp.Position.Z))
                    end
                end
            end
        end
        
        statusLabel.Text = "â—‰ Located " .. count .. " enemies (check console)"
        statusDot.BackgroundColor3 = Color3.fromRGB(255, 180, 50)
    end)
    currentY = currentY + 52
    
    -- Admin Tools Section
    createSection("ADMIN TOOLS", currentY)
    currentY = currentY + 30
    
    createButton("Unlock", "Unlock All Items", "ðŸ”“", Color3.fromRGB(80, 150, 255), currentY, function()
        local itemsFolder = ServerStorage:FindFirstChild("Items")
        if itemsFolder then
            for _, item in ipairs(itemsFolder:GetChildren()) do
                local clone = item:Clone()
                clone.Parent = player.Backpack
            end
        end
        
        local leaderstats = player:FindFirstChild("leaderstats")
        if leaderstats then
            for _, stat in ipairs(leaderstats:GetChildren()) do
                if stat:IsA("IntValue") or stat:IsA("NumberValue") then
                    stat.Value = 999999
                end
            end
        end
        
        statusLabel.Text = "â—‰ Unlocked all items"
        statusDot.BackgroundColor3 = Color3.fromRGB(80, 150, 255)
    end)
    currentY = currentY + 52
    
    local godModeEnabled = false
    local godModeConnection = nil
    
    local godBtn, godLabel = createButton("God", "God Mode", "ðŸ’Ž", Color3.fromRGB(255, 215, 0), currentY, function()
        godModeEnabled = not godModeEnabled
        
        if godModeEnabled then
            godModeConnection = RunService.Heartbeat:Connect(function()
                local char = player.Character
                if char then
                    local humanoid = char:FindFirstChild("Humanoid")
                    if humanoid then
                        humanoid.Health = humanoid.MaxHealth
                    end
                end
            end)
            godLabel.Text = "God Mode (Active)"
            statusLabel.Text = "â—‰ God mode enabled"
            statusDot.BackgroundColor3 = Color3.fromRGB(255, 215, 0)
        else
            if godModeConnection then
                godModeConnection:Disconnect()
                godModeConnection = nil
            end
            godLabel.Text = "God Mode"
            statusLabel.Text = "â—‰ God mode disabled"
            statusDot.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
        end
    end)
    currentY = currentY + 52
    
    local speedBoostEnabled = false
    
    local speedBtn, speedLabel = createButton("Speed", "Speed Boost", "ðŸƒ", Color3.fromRGB(100, 200, 255), currentY, function()
        speedBoostEnabled = not speedBoostEnabled
        
        local char = player.Character
        if char then
            local humanoid = char:FindFirstChild("Humanoid")
            if humanoid then
                if speedBoostEnabled then
                    humanoid.WalkSpeed = 100
                    speedLabel.Text = "Speed Boost (Active)"
                    statusLabel.Text = "â—‰ Speed boost enabled"
                    statusDot.BackgroundColor3 = Color3.fromRGB(100, 200, 255)
                else
                    humanoid.WalkSpeed = 16
                    speedLabel.Text = "Speed Boost"
                    statusLabel.Text = "â—‰ Speed boost disabled"
                    statusDot.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
                end
            end
        end
    end)
    currentY = currentY + 52
    
    -- RMB Tracking Functions
    local function startRMBTracking()
        stopRightMouseTracking(player)
        
        local nearestPlayer, distance = getNearestValidTarget(player)
        if not nearestPlayer then
            statusLabel.Text = "âš  No visible enemies nearby"
            statusDot.BackgroundColor3 = Color3.fromRGB(255, 180, 0)
            return
        end
        
        trackingPanel.Visible = true
        trackingPanel.Position = UDim2.new(0, 0, 0, 0)
        trackingTarget.Text = "Target: " .. nearestPlayer.Name .. " (RMB)"
        statusLabel.Text = "â—‰ RMB tracking " .. nearestPlayer.Name
        statusDot.BackgroundColor3 = Color3.fromRGB(0, 180, 255)
        
        for _, child in ipairs(contentFrame:GetChildren()) do
            if child ~= trackingPanel and child:IsA("GuiObject") then
                child.Position = child.Position + UDim2.new(0, 0, 0, 110)
            end
        end
        contentFrame.CanvasSize = UDim2.new(0, 0, 0, 960)
        
        local camera = Workspace.CurrentCamera
        
        local connection = RunService.RenderStepped:Connect(function()
            local currentNearest, dist = getNearestValidTarget(player)
            if not currentNearest then 
                trackingStatus.Text = "âš  NO TARGET"
                trackingStatus.TextColor3 = Color3.fromRGB(255, 180, 0)
                return 
            end
            
            local adminChar = player.Character
            local targetChar = currentNearest.Character
            
            if not adminChar or not targetChar then return end
            
            local adminHRP = adminChar:FindFirstChild("HumanoidRootPart")
            local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
            local targetHumanoid = targetChar:FindFirstChild("Humanoid")
            
            if adminHRP and targetHRP and camera then
                local targetPos = targetHRP.Position
                local adminPos = adminHRP.Position
                
                local lookAtCFrame = CFrame.new(camera.CFrame.Position, targetPos)
                camera.CFrame = camera.CFrame:Lerp(lookAtCFrame, 0.2)
                
                trackingTarget.Text = "Target: " .. currentNearest.Name .. " (RMB)"
                trackingCoords.Text = string.format("Position: X: %.0f | Y: %.0f | Z: %.0f", targetPos.X, targetPos.Y, targetPos.Z)
                trackingDist.Text = string.format("Distance: %.0fm", dist)
                trackingStatus.Text = "â—‰ LOCKED"
                trackingStatus.TextColor3 = Color3.fromRGB(0, 255, 100)
                
                if targetHumanoid then
                    local healthPercent = targetHumanoid.Health / targetHumanoid.MaxHealth
                    trackingHealthFill.Size = UDim2.new(healthPercent, 0, 1, 0)
                    
                    if healthPercent > 0.6 then
                        trackingHealthFill.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
                    elseif healthPercent > 0.3 then
                        trackingHealthFill.BackgroundColor3 = Color3.fromRGB(255, 200, 0)
                    else
                        trackingHealthFill.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
                    end
                end
            end
        end)
        
        rightMouseTracking[player.UserId] = {
            connection = connection
        }
    end
    
    local function stopRMBTracking()
        stopRightMouseTracking(player)
        if not activeTracking[player.UserId] then
            trackingPanel.Visible = false
            for _, child in ipairs(contentFrame:GetChildren()) do
                if child ~= trackingPanel and child:IsA("GuiObject") then
                    child.Position = child.Position - UDim2.new(0, 0, 0, 110)
                end
            end
            contentFrame.CanvasSize = UDim2.new(0, 0, 0, 850)
            statusLabel.Text = "â—‰ System Ready â€¢ RMB to track"
            statusDot.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
        end
    end
    
    -- Input Handling
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        
        if input.KeyCode == Enum.KeyCode.RightControl then
            mainFrame.Visible = not mainFrame.Visible
        end
        
        if input.UserInputType == Enum.UserInputType.MouseButton2 then
            if trackingMode[player.UserId] == "hold" then
                startRMBTracking()
            else
                -- Toggle mode
                if toggleTrackingActive[player.UserId] then
                    toggleTrackingActive[player.UserId] = false
                    stopRMBTracking()
                else
                    toggleTrackingActive[player.UserId] = true
                    startRMBTracking()
                end
            end
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input, gameProcessed)
        if input.UserInputType == Enum.UserInputType.MouseButton2 then
            if trackingMode[player.UserId] == "hold" then
                stopRMBTracking()
            end
        end
    end)
    
    -- Close button
    closeBtn.MouseButton1Click:Connect(function()
        mainFrame.Visible = false
    end)
    
    closeBtn.MouseEnter:Connect(function()
        TweenService:Create(closeBtn, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(255, 60, 60)}):Play()
    end)
    
    closeBtn.MouseLeave:Connect(function()
        TweenService:Create(closeBtn, TweenInfo.new(0.15), {BackgroundColor3 = Color3.fromRGB(40, 40, 45)}):Play()
    end)
end

-- Give GUI to admins
Players.PlayerAdded:Connect(function(player)
    if isAdmin(player) then
        createAdminGui(player)
    end
end)

-- For admins already in game
for _, player in ipairs(Players:GetPlayers()) do
    if isAdmin(player) then
        createAdminGui(player)
    end
end
