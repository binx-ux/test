-- ServerScriptService

-- Services
local Players = game:GetService("Players")
local ServerStorage = game:GetService("ServerStorage")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local Debris = game:GetService("Debris")
local SoundService = game:GetService("SoundService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local MarketplaceService = game:GetService("MarketplaceService")
local TeleportService = game:GetService("TeleportService")
local BadgeService = game:GetService("BadgeService")
local DataStoreService = game:GetService("DataStoreService")
local PhysicsService = game:GetService("PhysicsService")
local PathfindingService = game:GetService("PathfindingService")
local Chat = game:GetService("Chat")
local Teams = game:GetService("Teams")
local StarterGui = game:GetService("StarterGui")
local StarterPack = game:GetService("StarterPack")
local StarterPlayer = game:GetService("StarterPlayer")
local ContextActionService = game:GetService("ContextActionService")

local adminIds = {
    9766385891, -- Your admin
}

local activeTracking = {}
local activeESP = {}
local espEnabled = {}
local rightMouseTracking = {}

local function isAdmin(player)
    for _, id in ipairs(adminIds) do
        if player.UserId == id then
            return true
        end
    end
    return false
end

local function isSameTeam(player1, player2)
    if not player1.Team or not player2.Team then
        return false
    end
    return player1.Team == player2.Team
end

local function isValidTarget(admin, target)
    -- Not yourself
    if target == admin then
        return false
    end
    
    -- Not an admin
    if isAdmin(target) then
        return false
    end
    
    -- Not same team
    if isSameTeam(admin, target) then
        return false
    end
    
    return true
end

local function hasLineOfSight(admin, target)
    local adminChar = admin.Character
    local targetChar = target.Character
    
    if not adminChar or not targetChar then
        return false
    end
    
    local adminHead = adminChar:FindFirstChild("Head")
    local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
    
    if not adminHead or not targetHRP then
        return false
    end
    
    local origin = adminHead.Position
    local destination = targetHRP.Position
    local direction = (destination - origin)
    local distance = direction.Magnitude
    
    -- Raycast parameters - ignore admin and target characters
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    raycastParams.FilterDescendantsInstances = {adminChar, targetChar}
    raycastParams.IgnoreWater = true
    
    local raycastResult = Workspace:Raycast(origin, direction.Unit * distance, raycastParams)
    
    -- If raycast hit something, there's a wall in the way
    if raycastResult then
        return false
    end
    
    return true
end

local function findPlayer(name)
    name = name:lower()
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Name:lower():sub(1, #name) == name then
            return player
        end
    end
    return nil
end

local function getNearestValidTarget(admin)
    local adminChar = admin.Character
    if not adminChar then return nil end
    
    local adminHRP = adminChar:FindFirstChild("HumanoidRootPart")
    if not adminHRP then return nil end
    
    local nearestPlayer = nil
    local nearestDistance = math.huge
    
    for _, player in ipairs(Players:GetPlayers()) do
        -- Check if valid target (not admin, not same team)
        if isValidTarget(admin, player) then
            local char = player.Character
            if char then
                local hrp = char:FindFirstChild("HumanoidRootPart")
                if hrp then
                    local distance = (adminHRP.Position - hrp.Position).Magnitude
                    
                    -- Check line of sight (no walls)
                    if distance < nearestDistance and hasLineOfSight(admin, player) then
                        nearestDistance = distance
                        nearestPlayer = player
                    end
                end
            end
        end
    end
    
    return nearestPlayer, nearestDistance
end

local function stopTracking(admin)
    if activeTracking[admin.UserId] then
        if activeTracking[admin.UserId].connection then
            activeTracking[admin.UserId].connection:Disconnect()
        end
        activeTracking[admin.UserId] = nil
        return true
    end
    return false
end

local function stopRightMouseTracking(admin)
    if rightMouseTracking[admin.UserId] then
        if rightMouseTracking[admin.UserId].connection then
            rightMouseTracking[admin.UserId].connection:Disconnect()
        end
        rightMouseTracking[admin.UserId] = nil
        
        local camera = Workspace.CurrentCamera
        if camera then
            camera.CameraType = Enum.CameraType.Custom
        end
        return true
    end
    return false
end

local function createESPHighlight(target, admin)
    if not target.Character then return nil end
    
    -- Don't create ESP for admins or same team
    if not isValidTarget(admin, target) then
        return nil
    end
    
    local existingHighlight = target.Character:FindFirstChild("AdminESP_" .. admin.UserId)
    if existingHighlight then
        existingHighlight:Destroy()
    end
    
    local existingBillboard = target.Character:FindFirstChild("AdminESPInfo_" .. admin.UserId)
    if existingBillboard then
        existingBillboard:Destroy()
    end
    
    local highlight = Instance.new("Highlight")
    highlight.Name = "AdminESP_" .. admin.UserId
    highlight.Adornee = target.Character
    highlight.FillColor = Color3.fromRGB(255, 0, 0)
    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    highlight.FillTransparency = 0.5
    highlight.OutlineTransparency = 0
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = target.Character
    
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Name = "AdminESPInfo_" .. admin.UserId
    billboardGui.Adornee = target.Character:FindFirstChild("Head")
    billboardGui.Size = UDim2.new(0, 200, 0, 50)
    billboardGui.StudsOffset = Vector3.new(0, 3, 0)
    billboardGui.AlwaysOnTop = true
    billboardGui.Parent = target.Character
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "NameLabel"
    nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = target.Name
    nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    nameLabel.TextStrokeTransparency = 0
    nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    nameLabel.TextSize = 14
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.Parent = billboardGui
    
    local distanceLabel = Instance.new("TextLabel")
    distanceLabel.Name = "DistanceLabel"
    distanceLabel.Size = UDim2.new(1, 0, 0.5, 0)
    distanceLabel.Position = UDim2.new(0, 0, 0.5, 0)
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.Text = "0 studs"
    distanceLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
    distanceLabel.TextStrokeTransparency = 0
    distanceLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    distanceLabel.TextSize = 12
    distanceLabel.Font = Enum.Font.Gotham
    distanceLabel.Parent = billboardGui
    
    local visibilityLabel = Instance.new("TextLabel")
    visibilityLabel.Name = "VisibilityLabel"
    visibilityLabel.Size = UDim2.new(1, 0, 0.3, 0)
    visibilityLabel.Position = UDim2.new(0, 0, 0.7, 0)
    visibilityLabel.BackgroundTransparency = 1
    visibilityLabel.Text = "ðŸ‘ï¸ Visible"
    visibilityLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
    visibilityLabel.TextStrokeTransparency = 0
    visibilityLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    visibilityLabel.TextSize = 10
    visibilityLabel.Font = Enum.Font.Gotham
    visibilityLabel.Parent = billboardGui
    
    return {
        highlight = highlight, 
        billboard = billboardGui, 
        distanceLabel = distanceLabel,
        visibilityLabel = visibilityLabel
    }
end

local function updateESPDistance(admin, target, espComponents)
    if not admin.Character or not target.Character then return end
    
    -- Re-check if still valid target (team might have changed)
    if not isValidTarget(admin, target) then
        if espComponents.highlight then
            espComponents.highlight:Destroy()
        end
        if espComponents.billboard then
            espComponents.billboard:Destroy()
        end
        return false
    end
    
    local adminHRP = admin.Character:FindFirstChild("HumanoidRootPart")
    local targetHRP = target.Character:FindFirstChild("HumanoidRootPart")
    
    if adminHRP and targetHRP and espComponents.distanceLabel then
        local distance = (adminHRP.Position - targetHRP.Position).Magnitude
        espComponents.distanceLabel.Text = string.format("%.0f studs", distance)
        
        -- Check line of sight and update visibility indicator
        local canSee = hasLineOfSight(admin, target)
        
        if canSee then
            espComponents.visibilityLabel.Text = "ðŸ‘ï¸ Visible"
            espComponents.visibilityLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
            espComponents.highlight.FillTransparency = 0.5
        else
            espComponents.visibilityLabel.Text = "ðŸ§± Behind Cover"
            espComponents.visibilityLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            espComponents.highlight.FillTransparency = 0.8
        end
        
        -- Color based on distance
        if distance < 50 then
            espComponents.highlight.FillColor = Color3.fromRGB(255, 0, 0)
        elseif distance < 150 then
            espComponents.highlight.FillColor = Color3.fromRGB(255, 165, 0)
        else
            espComponents.highlight.FillColor = Color3.fromRGB(0, 255, 0)
        end
    end
    
    return true
end

local function clearAllESP(admin)
    if activeESP[admin.UserId] then
        for _, data in pairs(activeESP[admin.UserId]) do
            if data.connection then
                data.connection:Disconnect()
            end
            if data.components then
                if data.components.highlight and data.components.highlight.Parent then
                    data.components.highlight:Destroy()
                end
                if data.components.billboard and data.components.billboard.Parent then
                    data.components.billboard:Destroy()
                end
            end
        end
        activeESP[admin.UserId] = nil
    end
    
    -- Clean up any remaining ESP on all players
    for _, player in ipairs(Players:GetPlayers()) do
        if player.Character then
            local highlight = player.Character:FindFirstChild("AdminESP_" .. admin.UserId)
            if highlight then
                highlight:Destroy()
            end
            local billboard = player.Character:FindFirstChild("AdminESPInfo_" .. admin.UserId)
            if billboard then
                billboard:Destroy()
            end
        end
    end
    
    espEnabled[admin.UserId] = false
end

local function enableESP(admin)
    clearAllESP(admin)
    
    activeESP[admin.UserId] = {}
    espEnabled[admin.UserId] = true
    
    for _, target in ipairs(Players:GetPlayers()) do
        if isValidTarget(admin, target) then
            local components = createESPHighlight(target, admin)
            if components then
                local connection = RunService.Heartbeat:Connect(function()
                    if not espEnabled[admin.UserId] then
                        return
                    end
                    local stillValid = updateESPDistance(admin, target, components)
                    if not stillValid then
                        -- Target became invalid, clean up
                        if activeESP[admin.UserId] and activeESP[admin.UserId][target.UserId] then
                            activeESP[admin.UserId][target.UserId].connection:Disconnect()
                            activeESP[admin.UserId][target.UserId] = nil
                        end
                    end
                end)
                
                activeESP[admin.UserId][target.UserId] = {
                    components = components,
                    connection = connection
                }
            end
        end
    end
    
    -- Handle new players joining
    local playerAddedConn
    playerAddedConn = Players.PlayerAdded:Connect(function(target)
        if not espEnabled[admin.UserId] then
            playerAddedConn:Disconnect()
            return
        end
        
        target.CharacterAdded:Wait()
        task.wait(1)
        
        if espEnabled[admin.UserId] and isValidTarget(admin, target) then
            local components = createESPHighlight(target, admin)
            if components then
                local connection = RunService.Heartbeat:Connect(function()
                    if not espEnabled[admin.UserId] then
                        return
                    end
                    updateESPDistance(admin, target, components)
                end)
                
                if not activeESP[admin.UserId] then
                    activeESP[admin.UserId] = {}
                end
                
                activeESP[admin.UserId][target.UserId] = {
                    components = components,
                    connection = connection
                }
            end
        end
    end)
    
    -- Handle character respawns
    for _, target in ipairs(Players:GetPlayers()) do
        if target ~= admin then
            target.CharacterAdded:Connect(function()
                if espEnabled[admin.UserId] and isValidTarget(admin, target) then
                    task.wait(1)
                    
                    -- Clean old
                    if activeESP[admin.UserId] and activeESP[admin.UserId][target.UserId] then
                        if activeESP[admin.UserId][target.UserId].connection then
                            activeESP[admin.UserId][target.UserId].connection:Disconnect()
                        end
                    end
                    
                    -- Create new
                    local components = createESPHighlight(target, admin)
                    if components then
                        local connection = RunService.Heartbeat:Connect(function()
                            if not espEnabled[admin.UserId] then
                                return
                            end
                            updateESPDistance(admin, target, components)
                        end)
                        
                        if not activeESP[admin.UserId] then
                            activeESP[admin.UserId] = {}
                        end
                        
                        activeESP[admin.UserId][target.UserId] = {
                            components = components,
                            connection = connection
                        }
                    end
                end
            end)
            
            -- Handle team changes
            target:GetPropertyChangedSignal("Team"):Connect(function()
                if espEnabled[admin.UserId] then
                    -- If now same team or admin, remove ESP
                    if not isValidTarget(admin, target) then
                        if activeESP[admin.UserId] and activeESP[admin.UserId][target.UserId] then
                            if activeESP[admin.UserId][target.UserId].connection then
                                activeESP[admin.UserId][target.UserId].connection:Disconnect()
                            end
                            if activeESP[admin.UserId][target.UserId].components then
                                if activeESP[admin.UserId][target.UserId].components.highlight then
                                    activeESP[admin.UserId][target.UserId].components.highlight:Destroy()
                                end
                                if activeESP[admin.UserId][target.UserId].components.billboard then
                                    activeESP[admin.UserId][target.UserId].components.billboard:Destroy()
                                end
                            end
                            activeESP[admin.UserId][target.UserId] = nil
                        end
                    else
                        -- Now enemy, add ESP if not exists
                        if not activeESP[admin.UserId][target.UserId] and target.Character then
                            local components = createESPHighlight(target, admin)
                            if components then
                                local connection = RunService.Heartbeat:Connect(function()
                                    if not espEnabled[admin.UserId] then
                                        return
                                    end
                                    updateESPDistance(admin, target, components)
                                end)
                                
                                activeESP[admin.UserId][target.UserId] = {
                                    components = components,
                                    connection = connection
                                }
                            end
                        end
                    end
                end
            end)
        end
    end
end

local function createAdminGui(player)
    -- Main ScreenGui
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "AdminPanel"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = player:WaitForChild("PlayerGui")
    
    -- Toggle Button
    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Name = "ToggleButton"
    toggleBtn.Size = UDim2.new(0, 50, 0, 50)
    toggleBtn.Position = UDim2.new(0, 10, 0.5, -25)
    toggleBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    toggleBtn.Text = "âš¡"
    toggleBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    toggleBtn.TextSize = 24
    toggleBtn.Font = Enum.Font.GothamBold
    toggleBtn.Parent = screenGui
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 8)
    toggleCorner.Parent = toggleBtn
    
    -- Main Frame
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 320, 0, 560)
    mainFrame.Position = UDim2.new(0.5, -160, 0.5, -280)
    mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    mainFrame.BorderSizePixel = 0
    mainFrame.Visible = false
    mainFrame.Active = true
    mainFrame.Draggable = true
    mainFrame.Parent = screenGui
    
    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = UDim.new(0, 12)
    mainCorner.Parent = mainFrame
    
    -- Title Bar
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 45)
    titleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    titleBar.BorderSizePixel = 0
    titleBar.Parent = mainFrame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 12)
    titleCorner.Parent = titleBar
    
    local titleFix = Instance.new("Frame")
    titleFix.Size = UDim2.new(1, 0, 0.5, 0)
    titleFix.Position = UDim2.new(0, 0, 0.5, 0)
    titleFix.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    titleFix.BorderSizePixel = 0
    titleFix.Parent = titleBar
    
    local titleText = Instance.new("TextLabel")
    titleText.Size = UDim2.new(1, -50, 1, 0)
    titleText.Position = UDim2.new(0, 15, 0, 0)
    titleText.BackgroundTransparency = 1
    titleText.Text = "âš¡ Admin Panel [R-Ctrl]"
    titleText.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleText.TextSize = 16
    titleText.Font = Enum.Font.GothamBold
    titleText.TextXAlignment = Enum.TextXAlignment.Left
    titleText.Parent = titleBar
    
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 30, 0, 30)
    closeBtn.Position = UDim2.new(1, -38, 0, 7)
    closeBtn.BackgroundColor3 = Color3.fromRGB(255, 70, 70)
    closeBtn.Text = "âœ•"
    closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeBtn.TextSize = 14
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.Parent = titleBar
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 6)
    closeCorner.Parent = closeBtn
    
    -- Info Label
    local infoLabel = Instance.new("TextLabel")
    infoLabel.Size = UDim2.new(1, -20, 0, 30)
    infoLabel.Position = UDim2.new(0, 10, 0, 48)
    infoLabel.BackgroundColor3 = Color3.fromRGB(60, 40, 80)
    infoLabel.Text = "  â„¹ï¸ Ignores: Admins, Teammates, Walls"
    infoLabel.TextColor3 = Color3.fromRGB(200, 180, 255)
    infoLabel.TextSize = 11
    infoLabel.Font = Enum.Font.Gotham
    infoLabel.TextXAlignment = Enum.TextXAlignment.Left
    infoLabel.Parent = mainFrame
    
    local infoCorner = Instance.new("UICorner")
    infoCorner.CornerRadius = UDim.new(0, 6)
    infoCorner.Parent = infoLabel
    
    -- Content Frame
    local contentFrame = Instance.new("ScrollingFrame")
    contentFrame.Name = "Content"
    contentFrame.Size = UDim2.new(1, -20, 1, -90)
    contentFrame.Position = UDim2.new(0, 10, 0, 82)
    contentFrame.BackgroundTransparency = 1
    contentFrame.ScrollBarThickness = 4
    contentFrame.CanvasSize = UDim2.new(0, 0, 0, 620)
    contentFrame.Parent = mainFrame
    
    -- Player Input
    local playerInput = Instance.new("TextBox")
    playerInput.Name = "PlayerInput"
    playerInput.Size = UDim2.new(1, 0, 0, 38)
    playerInput.Position = UDim2.new(0, 0, 0, 0)
    playerInput.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    playerInput.Text = ""
    playerInput.PlaceholderText = "Enter player name..."
    playerInput.TextColor3 = Color3.fromRGB(255, 255, 255)
    playerInput.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
    playerInput.TextSize = 14
    playerInput.Font = Enum.Font.Gotham
    playerInput.Parent = contentFrame
    
    local inputCorner = Instance.new("UICorner")
    inputCorner.CornerRadius = UDim.new(0, 6)
    inputCorner.Parent = playerInput
    
    -- Status Label
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Name = "Status"
    statusLabel.Size = UDim2.new(1, 0, 0, 20)
    statusLabel.Position = UDim2.new(0, 0, 0, 42)
    statusLabel.BackgroundTransparency = 1
    statusLabel.Text = "Ready | Hold RMB to track nearest enemy"
    statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
    statusLabel.TextSize = 11
    statusLabel.Font = Enum.Font.Gotham
    statusLabel.Parent = contentFrame
    
    -- Live Tracking Info
    local trackingInfo = Instance.new("Frame")
    trackingInfo.Name = "TrackingInfo"
    trackingInfo.Size = UDim2.new(1, 0, 0, 85)
    trackingInfo.Position = UDim2.new(0, 0, 0, 65)
    trackingInfo.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    trackingInfo.BorderSizePixel = 0
    trackingInfo.Visible = false
    trackingInfo.Parent = contentFrame
    
    local trackingCorner = Instance.new("UICorner")
    trackingCorner.CornerRadius = UDim.new(0, 6)
    trackingCorner.Parent = trackingInfo
    
    local trackingTitle = Instance.new("TextLabel")
    trackingTitle.Size = UDim2.new(1, 0, 0, 20)
    trackingTitle.Position = UDim2.new(0, 10, 0, 5)
    trackingTitle.BackgroundTransparency = 1
    trackingTitle.Text = "ðŸŽ¯ LIVE CAM TRACKING"
    trackingTitle.TextColor3 = Color3.fromRGB(180, 80, 255)
    trackingTitle.TextSize = 12
    trackingTitle.Font = Enum.Font.GothamBold
    trackingTitle.TextXAlignment = Enum.TextXAlignment.Left
    trackingTitle.Parent = trackingInfo
    
    local trackingTarget = Instance.new("TextLabel")
    trackingTarget.Name = "TargetName"
    trackingTarget.Size = UDim2.new(1, -20, 0, 15)
    trackingTarget.Position = UDim2.new(0, 10, 0, 25)
    trackingTarget.BackgroundTransparency = 1
    trackingTarget.Text = "Target: None"
    trackingTarget.TextColor3 = Color3.fromRGB(255, 255, 255)
    trackingTarget.TextSize = 11
    trackingTarget.Font = Enum.Font.Gotham
    trackingTarget.TextXAlignment = Enum.TextXAlignment.Left
    trackingTarget.Parent = trackingInfo
    
    local trackingCoords = Instance.new("TextLabel")
    trackingCoords.Name = "Coords"
    trackingCoords.Size = UDim2.new(1, -20, 0, 15)
    trackingCoords.Position = UDim2.new(0, 10, 0, 40)
    trackingCoords.BackgroundTransparency = 1
    trackingCoords.Text = "Position: X: 0 | Y: 0 | Z: 0"
    trackingCoords.TextColor3 = Color3.fromRGB(255, 255, 0)
    trackingCoords.TextSize = 11
    trackingCoords.Font = Enum.Font.Gotham
    trackingCoords.TextXAlignment = Enum.TextXAlignment.Left
    trackingCoords.Parent = trackingInfo
    
    local trackingDist = Instance.new("TextLabel")
    trackingDist.Name = "Distance"
    trackingDist.Size = UDim2.new(1, -20, 0, 15)
    trackingDist.Position = UDim2.new(0, 10, 0, 55)
    trackingDist.BackgroundTransparency = 1
    trackingDist.Text = "Distance: 0 studs"
    trackingDist.TextColor3 = Color3.fromRGB(0, 255, 255)
    trackingDist.TextSize = 11
    trackingDist.Font = Enum.Font.Gotham
    trackingDist.TextXAlignment = Enum.TextXAlignment.Left
    trackingDist.Parent = trackingInfo
    
    local trackingVisibility = Instance.new("TextLabel")
    trackingVisibility.Name = "Visibility"
    trackingVisibility.Size = UDim2.new(1, -20, 0, 15)
    trackingVisibility.Position = UDim2.new(0, 10, 0, 70)
    trackingVisibility.BackgroundTransparency = 1
    trackingVisibility.Text = "Status: ðŸ‘ï¸ Visible"
    trackingVisibility.TextColor3 = Color3.fromRGB(0, 255, 0)
    trackingVisibility.TextSize = 11
    trackingVisibility.Font = Enum.Font.Gotham
    trackingVisibility.TextXAlignment = Enum.TextXAlignment.Left
    trackingVisibility.Parent = trackingInfo
    
    -- Button Template Function
    local function createButton(name, text, color, positionY)
        local btn = Instance.new("TextButton")
        btn.Name = name
        btn.Size = UDim2.new(1, 0, 0, 40)
        btn.Position = UDim2.new(0, 0, 0, positionY)
        btn.BackgroundColor3 = color
        btn.Text = text
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)
        btn.TextSize = 14
        btn.Font = Enum.Font.GothamBold
        btn.Parent = contentFrame
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 6)
        corner.Parent = btn
        
        return btn
    end
    
    -- Create Buttons
    local unlockBtn = createButton("UnlockAll", "ðŸ”“ Unlock All", Color3.fromRGB(80, 150, 255), 160)
    local locateBtn = createButton("Locate", "ðŸ“ Locate Enemies", Color3.fromRGB(255, 180, 50), 210)
    local trackBtn = createButton("Track", "ðŸŽ¯ Track Player (Cam)", Color3.fromRGB(180, 80, 255), 260)
    local untrackBtn = createButton("Untrack", "ðŸ›‘ Stop Tracking", Color3.fromRGB(255, 80, 80), 310)
    local espBtn = createButton("ESP", "ðŸ‘ï¸ Toggle ESP (Enemies Only)", Color3.fromRGB(0, 200, 255), 360)
    local tpBtn = createButton("Teleport", "âš¡ Teleport To Player", Color3.fromRGB(80, 200, 120), 410)
    local bringBtn = createButton("Bring", "ðŸ“¥ Bring Player", Color3.fromRGB(255, 100, 150), 460)
    local godBtn = createButton("God", "ðŸ’Ž God Mode", Color3.fromRGB(255, 215, 0), 510)
    local speedBtn = createButton("Speed", "ðŸƒ Speed Boost", Color3.fromRGB(100, 200, 255), 560)
    
    -- Player List Frame
    local playerListFrame = Instance.new("ScrollingFrame")
    playerListFrame.Name = "PlayerList"
    playerListFrame.Size = UDim2.new(1, 0, 0, 180)
    playerListFrame.Position = UDim2.new(0, 0, 0, 610)
    playerListFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    playerListFrame.BorderSizePixel = 0
    playerListFrame.ScrollBarThickness = 4
    playerListFrame.Visible = false
    playerListFrame.Parent = contentFrame
    
    local listCorner = Instance.new("UICorner")
    listCorner.CornerRadius = UDim.new(0, 8)
    listCorner.Parent = playerListFrame
    
    local listLayout = Instance.new("UIListLayout")
    listLayout.Padding = UDim.new(0, 5)
    listLayout.Parent = playerListFrame
    
    local listPadding = Instance.new("UIPadding")
    listPadding.PaddingLeft = UDim.new(0, 5)
    listPadding.PaddingRight = UDim.new(0, 5)
    listPadding.PaddingTop = UDim.new(0, 5)
    listPadding.Parent = playerListFrame
    
    -- State
    local godModeEnabled = false
    local godModeConnection = nil
    local speedBoostEnabled = false
    
    -- Functions
    local function setStatus(text, color)
        statusLabel.Text = text
        statusLabel.TextColor3 = color or Color3.fromRGB(100, 255, 100)
    end
    
    local function unlockAll()
        local itemsFolder = ServerStorage:FindFirstChild("Items")
        if itemsFolder then
            for _, item in ipairs(itemsFolder:GetChildren()) do
                local clone = item:Clone()
                clone.Parent = player.Backpack
            end
        end
        
        local leaderstats = player:FindFirstChild("leaderstats")
        if leaderstats then
            for _, stat in ipairs(leaderstats:GetChildren()) do
                if stat:IsA("IntValue") or stat:IsA("NumberValue") then
                    stat.Value = 999999
                end
            end
        end
        
        setStatus("âœ… Unlocked everything!", Color3.fromRGB(100, 255, 100))
    end
    
    local function locatePlayers()
        for _, child in ipairs(playerListFrame:GetChildren()) do
            if child:IsA("TextLabel") then
                child:Destroy()
            end
        end
        
        local count = 0
        for _, p in ipairs(Players:GetPlayers()) do
            -- Only show valid targets (not admins, not same team)
            if isValidTarget(player, p) then
                local char = p.Character
                local label = Instance.new("TextLabel")
                label.Size = UDim2.new(1, -10, 0, 35)
                label.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
                label.TextColor3 = Color3.fromRGB(255, 255, 255)
                label.TextSize = 10
                label.Font = Enum.Font.Gotham
                label.TextXAlignment = Enum.TextXAlignment.Left
                label.TextWrapped = true
                
                local corner = Instance.new("UICorner")
                corner.CornerRadius = UDim.new(0, 4)
                corner.Parent = label
                
                local padding = Instance.new("UIPadding")
                padding.PaddingLeft = UDim.new(0, 8)
                padding.Parent = label
                
                if char then
                    local hrp = char:FindFirstChild("HumanoidRootPart")
                    if hrp then
                        local pos = hrp.Position
                        local canSee = hasLineOfSight(player, p)
                        local visIcon = canSee and "ðŸ‘ï¸" or "ðŸ§±"
                        label.Text = string.format("%s %s | X:%.0f Y:%.0f Z:%.0f", visIcon, p.Name, pos.X, pos.Y, pos.Z)
                        label.BackgroundColor3 = canSee and Color3.fromRGB(50, 70, 50) or Color3.fromRGB(70, 50, 50)
                    else
                        label.Text = "â“ " .. p.Name .. " | Unknown"
                    end
                else
                    label.Text = "ðŸ’¤ " .. p.Name .. " | Not spawned"
                end
                
                label.Parent = playerListFrame
                count = count + 1
            end
        end
        
        playerListFrame.Visible = not playerListFrame.Visible
        playerListFrame.CanvasSize = UDim2.new(0, 0, 0, count * 40 + 10)
        
        if playerListFrame.Visible then
            contentFrame.CanvasSize = UDim2.new(0, 0, 0, 800)
        else
            contentFrame.CanvasSize = UDim2.new(0, 0, 0, 610)
        end
        
        setStatus("ðŸ“ Showing " .. count .. " enemies", Color3.fromRGB(255, 180, 50))
    end
    
    local function trackPlayerCam(targetName)
        if targetName == "" then
            setStatus("âš ï¸ Enter a player name first!", Color3.fromRGB(255, 100, 100))
            return
        end
        
        stopTracking(player)
        
        local target = findPlayer(targetName)
        if not target then
            setStatus("âŒ Player not found!", Color3.fromRGB(255, 100, 100))
            return
        end
        
        if target == player then
            setStatus("âš ï¸ Can't track yourself!", Color3.fromRGB(255, 100, 100))
            return
        end
        
        if isAdmin(target) then
            setStatus("âš ï¸ Can't track admins!", Color3.fromRGB(255, 100, 100))
            return
        end
        
        if isSameTeam(player, target) then
            setStatus("âš ï¸ Can't track teammates!", Color3.fromRGB(255, 100, 100))
            return
        end
        
        setStatus("ðŸŽ¯ Cam tracking " .. target.Name, Color3.fromRGB(180, 80, 255))
        trackingInfo.Visible = true
        trackingTarget.Text = "Target: " .. target.Name
        
        local camera = Workspace.CurrentCamera
        
        local connection = RunService.RenderStepped:Connect(function()
            local adminChar = player.Character
            local targetChar = target.Character
            
            if not adminChar or not targetChar then return end
            
            local adminHRP = adminChar:FindFirstChild("HumanoidRootPart")
            local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
            
            if adminHRP and targetHRP and camera then
                local targetPos = targetHRP.Position
                local adminPos = adminHRP.Position
                local distance = (adminPos - targetPos).Magnitude
                local canSee = hasLineOfSight(player, target)
                
                -- Only track if visible (no walls)
                if canSee then
                    local lookAtCFrame = CFrame.new(camera.CFrame.Position, targetPos)
                    camera.CFrame = camera.CFrame:Lerp(lookAtCFrame, 0.1)
                    trackingVisibility.Text = "Status: ðŸ‘ï¸ Visible - Tracking"
                    trackingVisibility.TextColor3 = Color3.fromRGB(0, 255, 0)
                else
                    trackingVisibility.Text = "Status: ðŸ§± Behind Cover - Paused"
                    trackingVisibility.TextColor3 = Color3.fromRGB(255, 100, 100)
                end
                
                trackingCoords.Text = string.format(
                    "Position: X: %.0f | Y: %.0f | Z: %.0f",
                    targetPos.X,
                    targetPos.Y,
                    targetPos.Z
                )
                trackingDist.Text = string.format("Distance: %.0f studs", distance)
            end
        end)
        
        activeTracking[player.UserId] = {
            connection = connection,
            target = target
        }
        
        target.AncestryChanged:Connect(function()
            if not target:IsDescendantOf(Players) then
                stopTracking(player)
                trackingInfo.Visible = false
                setStatus("âš ï¸ " .. target.Name .. " left", Color3.fromRGB(255, 180, 50))
            end
        end)
    end
    
    local function startRightMouseTracking()
        stopRightMouseTracking(player)
        
        local nearestPlayer, distance = getNearestValidTarget(player)
        if not nearestPlayer then
            setStatus("âš ï¸ No visible enemies nearby!", Color3.fromRGB(255, 100, 100))
            return
        end
        
        trackingInfo.Visible = true
        trackingTarget.Text = "Target: " .. nearestPlayer.Name .. " (RMB)"
        setStatus("ðŸŽ¯ RMB tracking " .. nearestPlayer.Name, Color3.fromRGB(0, 255, 255))
        
        local camera = Workspace.CurrentCamera
        
        local connection = RunService.RenderStepped:Connect(function()
            -- Continuously find nearest VALID and VISIBLE player
            local currentNearest, dist = getNearestValidTarget(player)
            if not currentNearest then 
                trackingVisibility.Text = "Status: âš ï¸ No visible enemies"
                trackingVisibility.TextColor3 = Color3.fromRGB(255, 180, 50)
                return 
            end
            
            local adminChar = player.Character
            local targetChar = currentNearest.Character
            
            if not adminChar or not targetChar then return end
            
            local adminHRP = adminChar:FindFirstChild("HumanoidRootPart")
            local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
            
            if adminHRP and targetHRP and camera then
                local targetPos = targetHRP.Position
                local adminPos = adminHRP.Position
                
                -- Lock camera onto nearest visible enemy
                local lookAtCFrame = CFrame.new(camera.CFrame.Position, targetPos)
                camera.CFrame = camera.CFrame:Lerp(lookAtCFrame, 0.2)
                
                -- Update UI
                trackingTarget.Text = "Target: " .. currentNearest.Name .. " (RMB)"
                trackingCoords.Text = string.format(
                    "Position: X: %.0f | Y: %.0f | Z: %.0f",
                    targetPos.X,
                    targetPos.Y,
                    targetPos.Z
                )
                trackingDist.Text = string.format("Distance: %.0f studs", dist)
                trackingVisibility.Text = "Status: ðŸ‘ï¸ Visible - Locked"
                trackingVisibility.TextColor3 = Color3.fromRGB(0, 255, 0)
            end
        end)
        
        rightMouseTracking[player.UserId] = {
            connection = connection
        }
    end
    
    local function teleportToPlayer()
        local targetName = playerInput.Text
        if targetName == "" then
            setStatus("âš ï¸ Enter a player name first!", Color3.fromRGB(255, 100, 100))
            return
        end
        
        local target = findPlayer(targetName)
        if not target then
            setStatus("âŒ Player not found!", Color3.fromRGB(255, 100, 100))
            return
        end
        
        local adminChar = player.Character
        local targetChar = target.Character
        
        if adminChar and targetChar then
            local adminHRP = adminChar:FindFirstChild("HumanoidRootPart")
            local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
            
            if adminHRP and targetHRP then
                adminHRP.CFrame = targetHRP.CFrame * CFrame.new(0, 0, 3)
                setStatus("âš¡ Teleported to " .. target.Name, Color3.fromRGB(80, 200, 120))
            end
        end
    end
    
    local function bringPlayer()
        local targetName = playerInput.Text
        if targetName == "" then
            setStatus("âš ï¸ Enter a player name first!", Color3.fromRGB(255, 100, 100))
            return
        end
        
        local target = findPlayer(targetName)
        if not target then
            setStatus("âŒ Player not found!", Color3.fromRGB(255, 100, 100))
            return
        end
        
        local adminChar = player.Character
        local targetChar = target.Character
        
        if adminChar and targetChar then
            local adminHRP = adminChar:FindFirstChild("HumanoidRootPart")
            local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
            
            if adminHRP and targetHRP then
                targetHRP.CFrame = adminHRP.CFrame * CFrame.new(0, 0, 3)
                setStatus("ðŸ“¥ Brought " .. target.Name, Color3.fromRGB(255, 100, 150))
            end
        end
    end
    
    local function toggleGodMode()
        godModeEnabled = not godModeEnabled
        
        if godModeEnabled then
            godModeConnection = RunService.Heartbeat:Connect(function()
                local char = player.Character
                if char then
                    local humanoid = char:FindFirstChild("Humanoid")
                    if humanoid then
                        humanoid.Health = humanoid.MaxHealth
                    end
                end
            end)
            godBtn.Text = "ðŸ’Ž God Mode (ON)"
            godBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
            setStatus("ðŸ’Ž God Mode enabled!", Color3.fromRGB(255, 215, 0))
        else
            if godModeConnection then
                godModeConnection:Disconnect()
                godModeConnection = nil
            end
            godBtn.Text = "ðŸ’Ž God Mode"
            godBtn.BackgroundColor3 = Color3.fromRGB(255, 215, 0)
            setStatus("God Mode disabled", Color3.fromRGB(150, 150, 150))
        end
    end
    
    local function toggleSpeedBoost()
        speedBoostEnabled = not speedBoostEnabled
        
        local char = player.Character
        if char then
            local humanoid = char:FindFirstChild("Humanoid")
            if humanoid then
                if speedBoostEnabled then
                    humanoid.WalkSpeed = 100
                    speedBtn.Text = "ðŸƒ Speed Boost (ON)"
                    speedBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
                    setStatus("ðŸƒ Speed Boost enabled!", Color3.fromRGB(100, 200, 255))
                else
                    humanoid.WalkSpeed = 16
                    speedBtn.Text = "ðŸƒ Speed Boost"
                    speedBtn.BackgroundColor3 = Color3.fromRGB(100, 200, 255)
                    setStatus("Speed Boost disabled", Color3.fromRGB(150, 150, 150))
                end
            end
        end
    end
    
    local function toggleESP()
        if espEnabled[player.UserId] then
            clearAllESP(player)
            espBtn.Text = "ðŸ‘ï¸ Toggle ESP (Enemies Only)"
            espBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 255)
            setStatus("ðŸ‘ï¸ ESP disabled", Color3.fromRGB(150, 150, 150))
        else
            enableESP(player)
            espBtn.Text = "ðŸ‘ï¸ ESP (ON)"
            espBtn.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
            setStatus("ðŸ‘ï¸ ESP enabled! (Enemies only)", Color3.fromRGB(0, 200, 255))
        end
    end
    
    -- Toggle GUI with Right Ctrl
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        
        if input.KeyCode == Enum.KeyCode.RightControl then
            mainFrame.Visible = not mainFrame.Visible
        end
        
        -- Right Mouse Button - Track nearest visible enemy
        if input.UserInputType == Enum.UserInputType.MouseButton2 then
            startRightMouseTracking()
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input, gameProcessed)
        -- Release Right Mouse Button - Stop tracking
        if input.UserInputType == Enum.UserInputType.MouseButton2 then
            stopRightMouseTracking(player)
            if not activeTracking[player.UserId] then
                trackingInfo.Visible = false
                setStatus("Ready | Hold RMB to track nearest enemy", Color3.fromRGB(100, 255, 100))
            end
        end
    end)
    
    -- Button Connections
    toggleBtn.MouseButton1Click:Connect(function()
        mainFrame.Visible = not mainFrame.Visible
    end)
    
    closeBtn.MouseButton1Click:Connect(function()
        mainFrame.Visible = false
    end)
    
    unlockBtn.MouseButton1Click:Connect(unlockAll)
    locateBtn.MouseButton1Click:Connect(locatePlayers)
    trackBtn.MouseButton1Click:Connect(function()
        trackPlayerCam(playerInput.Text)
    end)
    
    untrackBtn.MouseButton1Click:Connect(function()
        if stopTracking(player) then
            trackingInfo.Visible = false
            setStatus("ðŸ›‘ Stopped tracking", Color3.fromRGB(255, 80, 80))
        else
            setStatus("âš ï¸ Not tracking anyone", Color3.fromRGB(255, 180, 50))
        end
    end)
    
    espBtn.MouseButton1Click:Connect(toggleESP)
    tpBtn.MouseButton1Click:Connect(teleportToPlayer)
    bringBtn.MouseButton1Click:Connect(bringPlayer)
    godBtn.MouseButton1Click:Connect(toggleGodMode)
    speedBtn.MouseButton1Click:Connect(toggleSpeedBoost)
    
    -- Button Hover Effects
    local buttons = {unlockBtn, locateBtn, trackBtn, untrackBtn, espBtn, tpBtn, bringBtn, godBtn, speedBtn, closeBtn, toggleBtn}
    for _, btn in ipairs(buttons) do
        local originalColor = btn.BackgroundColor3
        btn.MouseEnter:Connect(function()
            btn.BackgroundColor3 = Color3.new(
                math.min(originalColor.R + 0.15, 1),
                math.min(originalColor.G + 0.15, 1),
                math.min(originalColor.B + 0.15, 1)
            )
        end)
        btn.MouseLeave:Connect(function()
            btn.BackgroundColor3 = originalColor
        end)
    end
end

-- Give GUI to admins
Players.PlayerAdded:Connect(function(player)
    if isAdmin(player) then
        createAdminGui(player)
    end
end)

-- For admins already in game (studio testing)
for _, player in ipairs(Players:GetPlayers()) do
    if isAdmin(player) then
        createAdminGui(player)
    end
end
